{% extends "base.html" %}
{% import "macros.html" as macros %}

{% block title %}{{ _('admin.audit_trail.title') }}{% endblock %}

{% block content %}
<div class="mb-4">
  <h1 class="text-2xl font-bold mb-1">{{ _('admin.audit_trail.heading') }}</h1>
  <p class="text-[var(--color-muted)] mb-0">{{ _('admin.audit_trail.subtitle') }}</p>
</div>

<div class="bg-[var(--color-card)] rounded-lg shadow-sm border border-[var(--color-border)] mb-4 p-4">
    <form method="get" class="flex flex-wrap lg:flex-nowrap gap-4 items-end">
        <div class="w-full lg:w-1/4">
            <label class="block text-sm font-medium text-[var(--color-text)] mb-1">{{ _('admin.audit_trail.filter.user') }}</label>
            <input type="text" name="user" class="w-full rounded-md bg-[var(--color-surface)] border border-[var(--color-border)] text-[var(--color-text)] px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500/50" value="{{ request.args.get('user', '') }}" placeholder="{{ _('admin.audit_trail.filter.user.placeholder') }}">
        </div>
        <div class="w-full lg:w-1/4">
            <label class="block text-sm font-medium text-[var(--color-text)] mb-1">{{ _('admin.audit_trail.filter.action') }}</label>
            <input type="text" name="action" class="w-full rounded-md bg-[var(--color-surface)] border border-[var(--color-border)] text-[var(--color-text)] px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500/50" value="{{ request.args.get('action', '') }}" placeholder="{{ _('admin.audit_trail.filter.action.placeholder') }}">
        </div>
        <div class="w-full lg:w-1/4">
            <label class="block text-sm font-medium text-[var(--color-text)] mb-1">{{ _('admin.audit_trail.filter.target') }}</label>
            <input type="text" name="target" class="w-full rounded-md bg-[var(--color-surface)] border border-[var(--color-border)] text-[var(--color-text)] px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500/50" value="{{ request.args.get('target', '') }}" placeholder="{{ _('admin.audit_trail.filter.target.placeholder') }}">
        </div>
        <div class="w-full lg:w-auto">
            <button type="submit" class="inline-flex items-center justify-center font-medium rounded-md px-4 py-2 text-sm transition-colors bg-primary-600 text-white hover:bg-primary-700 w-full lg:w-auto">
                {{ _('admin.audit_trail.filter.apply') }}
            </button>
        </div>
        {% if request.args %}
        <div class="w-full lg:w-auto">
            <a href="{{ url_for('admin.audit_trail') }}" class="inline-flex items-center justify-center font-medium rounded-md px-4 py-2 text-sm transition-colors border border-[var(--color-border)] text-[var(--color-text)] hover:bg-white/5 w-full lg:w-auto">
                {{ _('admin.audit_trail.filter.clear') }}
            </a>
        </div>
        {% endif %}
    </form>
</div>

<div class="overflow-x-auto w-full rounded-md border border-[var(--color-border)] mb-4">
  <table class="w-full text-sm text-left border-collapse bg-[var(--color-card)]">
    <thead class="bg-[var(--color-surface)] text-[var(--color-text)] border-b border-[var(--color-border)]">
      <tr>
        <th scope="col" class="px-4 py-3 font-semibold w-40">{{ _('admin.audit_trail.table.timestamp') }}</th>
        <th scope="col" class="px-4 py-3 font-semibold">{{ _('admin.audit_trail.table.user') }}</th>
        <th scope="col" class="px-4 py-3 font-semibold">{{ _('admin.audit_trail.table.action') }}</th>
        <th scope="col" class="px-4 py-3 font-semibold">{{ _('admin.audit_trail.table.target') }}</th>
        <th scope="col" class="px-4 py-3 font-semibold">{{ _('admin.audit_trail.table.details') }}</th>
        <th scope="col" class="px-4 py-3 font-semibold w-24">{{ _('admin.audit_trail.table.ip') }}</th>
      </tr>
    </thead>
    <tbody class="divide-y divide-[var(--color-border)]">
      {% for event in events %}
      <tr class="hover:bg-slate-500/5 transition-colors">
        <td class="px-4 py-3 align-top whitespace-nowrap text-[var(--color-muted)] text-xs">
          {{ event.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}
        </td>
        <td class="px-4 py-3 align-top">
          {% if event.user %}
             <span class="font-medium">{{ event.user.full_name }}</span>
             <br><span class="text-[var(--color-muted)] text-xs">{{ event.user.email }}</span>
          {% else %}
             <span class="text-[var(--color-muted)]">{{ _('admin.audit_trail.system') }}</span>
          {% endif %}
        </td>
        <td class="px-4 py-3 align-top">
          <span class="inline-flex items-center text-xs font-semibold uppercase tracking-wide rounded-full px-2 py-0.5 bg-slate-500/20 text-[var(--color-text)]">
            {{ event.action }}
          </span>
        </td>
        <td class="px-4 py-3 align-top font-mono text-xs text-[var(--color-primary)]">
          {{ event.target_type }} #{{ event.target_id }}
        </td>
        <td class="px-4 py-3 align-top">
          {% if event.details %}
            <div x-data="{ expanded: false }" class="relative">
                <div class="text-xs font-mono text-[var(--color-muted)] break-all max-h-16 overflow-hidden transition-all"
                     :class="{ 'max-h-full': expanded, 'max-h-16': !expanded }">
                    {{ event.details }}
                </div>
                {% if event.details|length > 100 %}
                    <button @click="expanded = !expanded" class="text-[var(--color-primary)] text-xs mt-1 hover:underline focus:outline-none">
                        <span x-show="!expanded">{{ _('admin.audit_trail.show_more') }}</span>
                        <span x-show="expanded">{{ _('admin.audit_trail.show_less') }}</span>
                    </button>
                {% endif %}
            </div>
          {% else %}
            <span class="text-[var(--color-muted)] text-xs">-</span>
          {% endif %}
        </td>
        <td class="px-4 py-3 align-top text-xs text-[var(--color-muted)] font-mono">
            {{ event.ip_address or '-' }}
        </td>
      </tr>
      {% else %}
      <tr>
          <td colspan="6" class="px-4 py-8 text-center text-[var(--color-muted)]">
              {{ _('admin.audit_trail.no_events') }}
          </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div class="flex justify-center mt-4">
    {{ macros.render_pagination(pagination, 'admin.audit_trail') }}
</div>
{% endblock %}