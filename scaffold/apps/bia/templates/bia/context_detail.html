{% extends "base.html" %}
{% block extra_css %}
  {{ super() }}
  {% include "bia/_badge_styles.html" %}
  <style nonce="{{ csp_nonce }}">
    .bia-cia-grid {
      display: grid;
      gap: 1rem;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }
    @media (min-width: 768px) {
      .bia-cia-grid {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
    }
    {% if export_mode %}
    .badge-ai-high-risk {
      background-color: #fd7e14;
      color: #212529 !important;
    }
    {% endif %}
  </style>
{% endblock %}
{% block title %}{{ item.name }} | BIA{% endblock %}
{% block content %}
{% set is_dark = theme != 'light' %}
{% set outline_inverse = 'border-slate-200 text-slate-100 hover:bg-slate-800' if is_dark else 'border-slate-300 text-slate-700 hover:bg-slate-50' %}
{% if not export_mode|default(false) %}
  <div class="mb-3">
    {% if item.is_archived %}
      <a href="{{ url_for('bia.archived_list') }}" class="text-[var(--color-muted)] hover:text-[var(--color-text)] no-underline">&larr; {{ _('bia.archived.back_to_list') }}</a>
    {% else %}
      <a href="{{ url_for('bia.dashboard') }}" class="text-[var(--color-muted)] hover:text-[var(--color-text)] no-underline">&larr; {{ _('bia.context_detail.back') }}</a>
    {% endif %}
  </div>
{% endif %}

{% if item.is_archived %}
<div class="rounded-xl px-4 py-3 text-sm border bg-yellow-400/10 border-yellow-400/40 text-yellow-600 dark:text-yellow-200 flex items-center mb-4" role="alert">
  <i class="fas fa-lock mr-3 fa-lg"></i>
  <div class="grow">
    <strong>{{ _('bia.archived.banner') }}</strong>
    <div>{{ _('bia.archived.archived_on', date=item.archived_at.strftime('%Y-%m-%d %H:%M') if item.archived_at else '-') }}</div>
  </div>
  {% if can_edit_context|default(False) %}
  <form method="post" action="{{ url_for('bia.archive_item', item_id=item.id) }}" class="ml-3">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <button type="submit" class="inline-flex items-center justify-center font-medium rounded-md px-4 py-2 text-sm transition-colors border border-transparent bg-yellow-500 text-slate-900 hover:bg-yellow-600" onclick="return confirm('{{ _('bia.archived.confirm_unarchive') }}');">
      {{ _('bia.archived.unarchive') }}
    </button>
  </form>
  {% endif %}
</div>
{% endif %}

<div class="flex flex-col lg:flex-row justify-between items-start gap-3 mb-6 {% if export_mode %}pt-3{% endif %}">
  <div>
    <h1 class="text-3xl font-bold mb-1 flex items-center flex-wrap gap-2">
      {{ item.name }}
      {% if item.tier %}
      <span class="inline-flex items-center text-xs font-semibold uppercase tracking-wide rounded-full px-3 py-0.5 bg-slate-100 text-slate-800 dark:bg-slate-700 dark:text-slate-300 align-middle">{{ item.tier.get_label() }}</span>
      {% endif %}
      {% if item.is_archived %}
      <span class="inline-flex items-center text-xs font-semibold uppercase tracking-wide rounded-full px-3 py-0.5 bg-yellow-400/20 text-yellow-600 dark:text-yellow-400 align-middle"><i class="fas fa-lock mr-1"></i> {{ _('bia.archived.badge') }}</span>
      {% endif %}
    </h1>
    <p class="text-[var(--color-muted)] mb-0">Last updated {{ item.last_update or 'never' }}</p>
  </div>
  {% if not export_mode|default(false) %}
    <div class="flex flex-wrap gap-2 items-center">
      {% if can_edit_context|default(False) and not item.is_archived %}
        <a href="{{ url_for('bia.edit_item', item_id=item.id) }}" class="inline-flex items-center justify-center font-medium rounded-md px-4 py-2 text-sm transition-colors border border-transparent {{ outline_inverse }} px-2.5 py-1 text-xs">{{ _('bia.context_detail.actions.edit') }}</a>
        <a href="{{ url_for('bia.manage_summary', item_id=item.id) }}" class="inline-flex items-center justify-center font-medium rounded-md px-4 py-2 text-sm transition-colors border border-transparent {{ outline_inverse }} px-2.5 py-1 text-xs">{{ _('bia.context_detail.tabs.summary') }}</a>
      {% endif %}
      <a href="{{ url_for('bia.export_item', item_id=item.id) }}" class="inline-flex items-center justify-center font-medium rounded-md px-4 py-2 text-sm transition-colors border border-transparent border-[var(--color-border)] text-[var(--color-muted)] hover:bg-slate-500/10 px-2.5 py-1 text-xs">HTML</a>
      <a href="{{ url_for('bia.export_csv', item_id=item.id) }}" class="inline-flex items-center justify-center font-medium rounded-md px-4 py-2 text-sm transition-colors border border-transparent border-[var(--color-border)] text-[var(--color-muted)] hover:bg-slate-500/10 px-2.5 py-1 text-xs">CSV</a>
      <a href="{{ url_for('bia.export_bia_sql', item_id=item.id) }}" class="inline-flex items-center justify-center font-medium rounded-md px-4 py-2 text-sm transition-colors border border-transparent border-[var(--color-border)] text-[var(--color-muted)] hover:bg-slate-500/10 px-2.5 py-1 text-xs">SQL</a>
      {% if can_edit_context|default(False) and not item.is_archived %}
      <div class="border-l border-[var(--color-border)] mx-1 h-6"></div>
      <form method="post" action="{{ url_for('bia.copy_item', item_id=item.id) }}" style="display: contents;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button type="submit" class="inline-flex items-center justify-center font-medium rounded-md px-4 py-2 text-sm transition-colors border border-transparent {{ outline_inverse }} px-2.5 py-1 text-xs" onclick="return confirm('{{ _('bia.actions.confirm_copy') }}');">
          <i class="fas fa-copy mr-1"></i> {{ _('bia.actions.copy') }}
        </button>
      </form>
      <form method="post" action="{{ url_for('bia.archive_item', item_id=item.id) }}" style="display: contents;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button type="submit" class="inline-flex items-center justify-center font-medium rounded-md px-4 py-2 text-sm transition-colors border border-transparent border-yellow-500 text-yellow-600 hover:bg-yellow-50 dark:text-yellow-400 dark:hover:bg-yellow-400/10 px-2.5 py-1 text-xs" onclick="return confirm('{{ _('bia.actions.confirm_archive') }}');">
          <i class="fas fa-archive mr-1"></i> {{ _('bia.actions.archive') }}
        </button>
      </form>
      <form method="post" action="{{ url_for('bia.delete_item', item_id=item.id) }}" style="display: contents;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button type="submit" class="inline-flex items-center justify-center font-medium rounded-md px-4 py-2 text-sm transition-colors border border-transparent border-red-500 text-red-600 hover:bg-red-50 dark:text-red-400 dark:hover:bg-red-400/10 px-2.5 py-1 text-xs" onclick="return confirm('{{ _('bia.actions.confirm_delete') }}');">{{ _('bia.context_detail.actions.delete') }}</button>
      </form>
      {% endif %}
    </div>
  {% endif %}
</div>

{% if item.summary and item.summary.content %}
<div class="mb-6">
  <div class="bg-[var(--color-card)] border border-[var(--color-border)] rounded-xl shadow-card">
    <div class="px-5 py-4 border-b border-[var(--color-border)]">
      <h3 class="font-semibold text-lg m-0">{{ _('bia.context_detail.tabs.summary') }}</h3>
    </div>
    <div class="px-5 py-4 whitespace-pre-wrap text-[var(--color-text)]">
      {{ item.summary.content }}
    </div>
  </div>
</div>
{% endif %}

<div class="bia-cia-grid mb-6">
  {% for property in ['confidentiality', 'integrity', 'availability'] %}
    {% set value = max_cia_impact.get(property) %}
    {% if value is not none %}
    <div class="bg-[var(--color-card)] border border-[var(--color-border)] rounded-xl shadow-card h-full">
      <div class="px-5 py-4 flex flex-col items-center text-center">
        <div class="text-[var(--color-muted)] uppercase text-xs font-semibold tracking-wider mb-2">{{ property.capitalize() }}</div>
        {% set cia_value = value or 'N/A' %}
        <span class="bia-impact-badge" data-impact="{{ cia_value | lower }}">{{ cia_value }}</span>
      </div>
    </div>
    {% endif %}
  {% endfor %}
</div>

<div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-6">
  <div class="h-full">
    <div class="bg-[var(--color-card)] border border-[var(--color-border)] rounded-xl shadow-card h-full">
      <div class="px-5 py-4">
        <div class="text-[var(--color-muted)] uppercase text-xs font-semibold tracking-wider mb-1">{{ _('bia.context_detail.sections.components') }}</div>
        <div class="text-3xl font-bold">{{ item.components | length }}</div>
      </div>
    </div>
  </div>
  <div class="h-full">
    <div class="bg-[var(--color-card)] border border-[var(--color-border)] rounded-xl shadow-card h-full">
      <div class="px-5 py-4 flex flex-col justify-between h-full">
        <div class="text-[var(--color-muted)] uppercase text-xs font-semibold tracking-wider mb-1">{{ _('bia.context_form.fields.tier.label') }}</div>
        <div class="text-2xl font-semibold">
          {% if item.tier %}
            {{ item.tier.get_label() }}
          {% else %}
            <span class="text-[var(--color-muted)]">-</span>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<div class="flex flex-col lg:flex-row items-start gap-4 mb-6">
  <div class="grow w-full">
    <!-- Components -->
    <div class="bg-[var(--color-card)] border border-[var(--color-border)] rounded-xl shadow-card h-full mb-6">
      <div class="px-5 py-4 border-b border-[var(--color-border)] flex justify-between items-center">
        <span class="font-semibold text-lg">{{ _('bia.context_detail.sections.components') }}</span>
        {% if not export_mode|default(false) and not item.is_archived %}
        <a href="{{ url_for('bia.view_components', scope=item.name, bia_id=item.id) }}" class="inline-flex items-center justify-center font-medium rounded-md px-4 py-2 text-sm transition-colors border border-transparent {{ outline_inverse }} px-2.5 py-1 text-xs">{{ _('bia.context_detail.actions.manage') }}</a>
        {% endif %}
      </div>
      <div class="p-0">
        {% if item.components %}
        <div class="overflow-x-auto w-full">
          <table class="w-full text-sm border-collapse bg-[var(--color-card)] [&_tbody_tr]:hover:bg-primary-500/5 align-middle mb-0">
            <thead class="bg-[var(--color-surface)]">
              <tr>
                <th scope="col" class="px-4 py-3 text-left font-semibold text-[var(--color-text)]">Name</th>
                <th scope="col" class="px-4 py-3 text-left font-semibold text-[var(--color-text)]">Owner</th>
                <th scope="col" class="px-4 py-3 text-left font-semibold text-[var(--color-text)]">Users</th>
                <th scope="col" class="px-4 py-3 text-left font-semibold text-[var(--color-text)]">Consequences</th>
                <th scope="col" class="px-4 py-3 text-left font-semibold text-[var(--color-text)]">{{ _('bia.components.table.headers.environments') }}</th>
                <th scope="col" class="px-4 py-3 text-left font-semibold text-[var(--color-text)]">AI</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-[var(--color-border)]">
              {% for component in item.components %}
              <tr>
                <td class="px-4 py-3 font-medium">{{ component.name }}</td>
                <td class="px-4 py-3">{{ component.info_owner or 'Not set' }}</td>
                <td class="px-4 py-3">{{ component.user_type or 'Not set' }}</td>
                <td class="px-4 py-3">{{ component.consequences | length }}</td>
                <td class="px-4 py-3">
                  <div class="flex flex-wrap gap-1">
                    {% for environment_type in bia_environment_types %}
                      {% set env_assignment = bia_component_environment(component, environment_type) %}
                      {% set environment_label = bia_environment_label(environment_type) %}
                      {% if env_assignment and env_assignment.is_enabled %}
                        {% set env_auth = bia_environment_authentication(env_assignment) %}
                        <span class="env-badge env-badge-enabled">{{ environment_label }} · {{ env_auth or _('bia.components.environments.badge_no_auth') }}</span>
                      {% else %}
                        <span class="env-badge env-badge-disabled">{{ environment_label }} · {{ _('bia.components.environments.badge_not_used') }}</span>
                      {% endif %}
                    {% endfor %}
                  </div>
                </td>
                <td class="px-4 py-3">
                  {% set ai_record = ai_identifications.get(component.id) %}
                  {% if ai_record %}
                    {% set ai_label = ai_record.category or 'No AI' %}
                    <span class="bia-ai-badge" data-ai="{{ ai_label | lower }}">{{ ai_label }}</span>
                  {% else %}
                    <span class="bia-ai-badge" data-ai="no ai">No AI</span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="p-6 text-center text-[var(--color-muted)]">No components linked yet.</div>
        {% endif %}
      </div>
    </div>

    <!-- Availability -->
    <div class="bg-[var(--color-card)] border border-[var(--color-border)] rounded-xl shadow-card h-full mb-6">
      <div class="px-5 py-4 border-b border-[var(--color-border)] flex justify-between items-center">
        <span class="font-semibold text-lg">{{ _('bia.context_detail.sections.availability') }}</span>
        {% if can_edit_context|default(False) and not export_mode|default(False) and not item.is_archived %}
        <a href="{{ url_for('bia.manage_item_availability', item_id=item.id) }}" class="inline-flex items-center justify-center font-medium rounded-md px-4 py-2 text-sm transition-colors border border-transparent {{ outline_inverse }} px-2.5 py-1 text-xs">{{ _('bia.context_detail.actions.manage') }}</a>
        {% endif %}
      </div>
      <div class="p-0">
        {% if item.components %}
        <div class="overflow-x-auto w-full">
          <table class="w-full text-sm border-collapse bg-[var(--color-card)] [&_tbody_tr]:hover:bg-primary-500/5 align-middle mb-0">
            <thead class="bg-[var(--color-surface)]">
              <tr>
                <th scope="col" class="px-4 py-3 text-left font-semibold text-[var(--color-text)]">Component</th>
                <th scope="col" class="px-4 py-3 text-left font-semibold text-[var(--color-text)]">MTD</th>
                <th scope="col" class="px-4 py-3 text-left font-semibold text-[var(--color-text)]">RTO</th>
                <th scope="col" class="px-4 py-3 text-left font-semibold text-[var(--color-text)]">RPO</th>
                <th scope="col" class="px-4 py-3 text-left font-semibold text-[var(--color-text)]">MAMSL</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-[var(--color-border)]">
              {% for component in item.components %}
              {% set availability = component.availability_requirement %}
              <tr>
                <td class="px-4 py-3 font-medium">{{ component.name }}</td>
                <td class="px-4 py-3">{{ availability.mtd if availability else 'Not set' }}</td>
                <td class="px-4 py-3">{{ availability.rto if availability else 'Not set' }}</td>
                <td class="px-4 py-3">{{ availability.rpo if availability else 'Not set' }}</td>
                <td class="px-4 py-3">{{ availability.masl if availability else 'Not set' }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
          <div class="p-6 text-center text-[var(--color-muted)]">No availability requirements captured yet.</div>
        {% endif %}
      </div>
    </div>

    <!-- Dependencies -->
    <div class="bg-[var(--color-card)] border border-[var(--color-border)] rounded-xl shadow-card h-full mb-6">
      <div class="px-5 py-4 border-b border-[var(--color-border)] flex justify-between items-center">
        <span class="font-semibold text-lg">{{ _('bia.context_detail.sections.dependencies') }}</span>
        {% if can_edit_context|default(False) and not export_mode|default(False) and not item.is_archived %}
        <a href="{{ url_for('bia.view_components', scope=item.name, bia_id=item.id) }}" class="inline-flex items-center justify-center font-medium rounded-md px-4 py-2 text-sm transition-colors border border-transparent {{ outline_inverse }} px-2.5 py-1 text-xs">{{ _('bia.context_detail.actions.manage') }}</a>
        {% endif %}
      </div>
      <div class="p-0">
        {% if item.components %}
        <div class="overflow-x-auto w-full">
          <table class="w-full text-sm border-collapse bg-[var(--color-card)] [&_tbody_tr]:hover:bg-primary-500/5 align-middle mb-0">
            <thead class="bg-[var(--color-surface)]">
              <tr>
                <th scope="col" class="px-4 py-3 text-left font-semibold text-[var(--color-text)]">Component</th>
                <th scope="col" class="px-4 py-3 text-left font-semibold text-[var(--color-text)]">IT Systems</th>
                <th scope="col" class="px-4 py-3 text-left font-semibold text-[var(--color-text)]">Equipment</th>
                <th scope="col" class="px-4 py-3 text-left font-semibold text-[var(--color-text)]">Suppliers</th>
                <th scope="col" class="px-4 py-3 text-left font-semibold text-[var(--color-text)]">People</th>
                <th scope="col" class="px-4 py-3 text-left font-semibold text-[var(--color-text)]">Facilities</th>
                <th scope="col" class="px-4 py-3 text-left font-semibold text-[var(--color-text)]">Others</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-[var(--color-border)]">
              {% for component in item.components %}
              <tr>
                <td class="px-4 py-3 font-medium">{{ component.name }}</td>
                <td class="px-4 py-3">{{ component.dependencies_it_systems_applications or '-' }}</td>
                <td class="px-4 py-3">{{ component.dependencies_equipment or '-' }}</td>
                <td class="px-4 py-3">{{ component.dependencies_suppliers or '-' }}</td>
                <td class="px-4 py-3">{{ component.dependencies_people or '-' }}</td>
                <td class="px-4 py-3">{{ component.dependencies_facilities or '-' }}</td>
                <td class="px-4 py-3">{{ component.dependencies_others or '-' }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
          <div class="p-6 text-center text-[var(--color-muted)]">No components to show dependencies for.</div>
        {% endif %}
      </div>
    </div>

    <!-- Consequences -->
    <div class="bg-[var(--color-card)] border border-[var(--color-border)] rounded-xl shadow-card h-full">
      <div class="px-5 py-4 border-b border-[var(--color-border)] flex justify-between items-center">
        <span class="font-semibold text-lg">{{ _('bia.context_detail.sections.consequences') }}</span>
        {% if can_edit_context|default(False) and not export_mode|default(False) and not item.is_archived %}
        <a href="{{ url_for('bia.manage_item_consequences', item_id=item.id) }}" class="inline-flex items-center justify-center font-medium rounded-md px-4 py-2 text-sm transition-colors border border-transparent {{ outline_inverse }} px-2.5 py-1 text-xs">{{ _('bia.context_detail.actions.manage') }}</a>
        {% endif %}
      </div>
      <div class="p-0">
        {% if consequences %}
        <div class="overflow-x-auto w-full">
          <table class="w-full text-sm border-collapse bg-[var(--color-card)] [&_tbody_tr]:hover:bg-primary-500/5 align-middle mb-0">
            <thead class="bg-[var(--color-surface)]">
              <tr>
                <th scope="col" class="px-5 py-3 text-left font-semibold text-[var(--color-text)]">{{ _('bia.manage_consequences.table.component') }}</th>
                <th scope="col" class="px-5 py-3 text-left font-semibold text-[var(--color-text)]">{{ _('bia.manage_consequences.table.categories') }}</th>
                <th scope="col" class="px-5 py-3 text-left font-semibold text-[var(--color-text)]">{{ _('bia.manage_consequences.table.security_property') }}</th>
                <th scope="col" class="px-5 py-3 text-left font-semibold text-[var(--color-text)]">{{ _('bia.view_consequences.table.worst_case') }}</th>
                <th scope="col" class="px-5 py-3 text-left font-semibold text-[var(--color-text)]">{{ _('bia.view_consequences.table.realistic_case') }}</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-[var(--color-border)]">
              {% for consequence in consequences %}
              <tr>
                <td class="px-5 py-3 font-medium">{{ consequence.component.name }}</td>
                <td class="px-5 py-3">{{ consequence.consequence_category }}</td>
                <td class="px-5 py-3 uppercase">
                  {% set prop_val = consequence.security_property %}
                  <span class="inline-flex items-center rounded-md bg-slate-50 px-2 py-1 text-xs font-medium text-slate-700 ring-1 ring-inset ring-slate-600/20 dark:bg-slate-400/10 dark:text-slate-400 dark:ring-slate-400/20">{{ prop_val }}</span>
                </td>
                <td class="px-5 py-3">
                  {% set worst = consequence.consequence_worstcase or 'N/A' %}
                  <span class="bia-impact-badge" data-impact="{{ worst | lower }}">{{ worst }}</span>
                </td>
                <td class="px-5 py-3">
                  {% set realistic = consequence.consequence_realisticcase or 'N/A' %}
                  <span class="bia-impact-badge" data-impact="{{ realistic | lower }}">{{ realistic }}</span>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
          <div class="p-6 text-center text-[var(--color-muted)]">No consequences recorded yet.</div>
        {% endif %}
      </div>
    </div>

  </div>

  <div class="shrink-0 w-full lg:w-auto" style="min-width: 280px; max-width: 100%; lg:max-width: 320px;">
    <div class="bg-[var(--color-card)] border border-[var(--color-border)] rounded-xl shadow-card mb-4">
      <div class="px-5 py-4 border-b border-[var(--color-border)] font-semibold">Risk Assessment</div>
      <div class="px-5 py-4 flex flex-col gap-4">
        <div class="flex justify-between items-center">
          <span>Process</span>
          <span class="inline-flex items-center text-xs font-semibold uppercase tracking-wide rounded-full px-3 py-0.5 {{ 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300' if item.risk_assessment_process else 'bg-slate-100 text-slate-800 dark:bg-slate-700 dark:text-slate-300' }}">
            {{ 'Yes' if item.risk_assessment_process else 'No' }}
          </span>
        </div>
        <div class="flex justify-between items-center">
          <span>People</span>
          <span class="inline-flex items-center text-xs font-semibold uppercase tracking-wide rounded-full px-3 py-0.5 {{ 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300' if item.risk_assessment_human else 'bg-slate-100 text-slate-800 dark:bg-slate-700 dark:text-slate-300' }}">
            {{ 'Yes' if item.risk_assessment_human else 'No' }}
          </span>
        </div>
        <div class="flex justify-between items-center">
          <span>Technical</span>
          <span class="inline-flex items-center text-xs font-semibold uppercase tracking-wide rounded-full px-3 py-0.5 {{ 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300' if item.risk_assessment_technological else 'bg-slate-100 text-slate-800 dark:bg-slate-700 dark:text-slate-300' }}">
            {{ 'Yes' if item.risk_assessment_technological else 'No' }}
          </span>
        </div>
      </div>
    </div>

    {% if item.ai_model and can_edit_context|default(False) and not export_mode|default(False) and not item.is_archived %}
    <div class="bg-[var(--color-card)] border border-[var(--color-border)] rounded-xl shadow-card">
      <div class="px-5 py-4 border-b border-[var(--color-border)] flex justify-between items-center">
        <span class="font-semibold">AI Assessment</span>
        <a href="{{ url_for('bia.manage_item_ai', item_id=item.id) }}" class="inline-flex items-center justify-center font-medium rounded-md px-3 py-1.5 text-xs transition-colors border border-transparent {{ outline_inverse }}">{{ _('Manage') }}</a>
      </div>
      <div class="px-5 py-4">
        {% set high_risk_ai_count = ai_identifications.values() | selectattr('category', 'in', ['High risk', 'Unacceptable risk', 'Critical']) | list | length %}
        <div class="flex justify-between items-center mb-1">
          <span class="text-sm">High Risk Components</span>
          <span class="font-bold {{ 'text-red-500' if high_risk_ai_count > 0 else 'text-[var(--color-muted)]' }}">{{ high_risk_ai_count }}</span>
        </div>
      </div>
    </div>
    {% endif %}
    
    <!-- Contact persons & roles -->
    <div class="bg-[var(--color-card)] border border-[var(--color-border)] rounded-xl shadow-card mt-4">
      <div class="px-5 py-4 border-b border-[var(--color-border)]">
        <h3 class="font-semibold text-lg m-0">{{ _('bia.context_detail.sections.roles') }}</h3>
      </div>
      <div class="p-0">
        <div class="overflow-x-auto w-full">
          <table class="w-full text-sm border-collapse bg-[var(--color-card)] align-middle mb-0">
            <tbody class="divide-y divide-[var(--color-border)]">
              <tr>
                <td class="px-5 py-2 font-medium text-[var(--color-muted)] block sm:table-cell sm:w-1/3">{{ _('bia.context_detail.roles.responsible') }}</td>
                <td class="px-5 py-2 block sm:table-cell">{{ item.responsible or '-' }}</td>
              </tr>
              <tr>
                <td class="px-5 py-2 font-medium text-[var(--color-muted)] block sm:table-cell sm:w-1/3">{{ _('bia.context_detail.roles.coordinator') }}</td>
                <td class="px-5 py-2 block sm:table-cell">{{ item.coordinator or '-' }}</td>
              </tr>
              <tr>
                 <td class="px-5 py-2 font-medium text-[var(--color-muted)] block sm:table-cell sm:w-1/3">{{ _('bia.context_detail.roles.project_leader') }}</td>
                 <td class="px-5 py-2 block sm:table-cell">{{ item.project_leader or '-' }}</td>
              </tr>
              <tr>
                 <td class="px-5 py-2 font-medium text-[var(--color-muted)] block sm:table-cell sm:w-1/3">{{ _('bia.context_detail.roles.product_owner') }}</td>
                 <td class="px-5 py-2 block sm:table-cell">{{ item.product_owner or '-' }}</td>
              </tr>
              <tr>
                 <td class="px-5 py-2 font-medium text-[var(--color-muted)] block sm:table-cell sm:w-1/3">{{ _('bia.context_detail.roles.risk_owner') }}</td>
                 <td class="px-5 py-2 block sm:table-cell">{{ item.risk_owner or '-' }}</td>
              </tr>
              <tr>
                 <td class="px-5 py-2 font-medium text-[var(--color-muted)] block sm:table-cell sm:w-1/3">{{ _('bia.context_detail.roles.technical_administrator') }}</td>
                 <td class="px-5 py-2 block sm:table-cell">{{ item.technical_administrator or '-' }}</td>
              </tr>
              <tr>
                 <td class="px-5 py-2 font-medium text-[var(--color-muted)] block sm:table-cell sm:w-1/3">{{ _('bia.context_detail.roles.security_manager') }}</td>
                 <td class="px-5 py-2 block sm:table-cell">{{ item.security_manager or '-' }}</td>
              </tr>
              <tr>
                 <td class="px-5 py-2 font-medium text-[var(--color-muted)] block sm:table-cell sm:w-1/3">{{ _('bia.context_detail.roles.incident_contact') }}</td>
                 <td class="px-5 py-2 block sm:table-cell">{{ item.incident_contact or '-' }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
