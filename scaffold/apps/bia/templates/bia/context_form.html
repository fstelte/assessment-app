{% extends "base.html" %}
{% from "partials/forms.html" import render_field_with_tooltip %}
{% block title %}{% if item %}{{ _('bia.context_form.title_edit') }}{% else %}{{ _('bia.context_form.title_new') }}{% endif %}{% endblock %}
{% block content %}
{% set is_dark = theme != 'light' %}
{% set border_class = 'border-secondary' if is_dark else 'border-secondary-subtle' %}
{% set card_surface = 'bg-dark ' ~ border_class if is_dark else 'bg-white ' ~ border_class %}
{% set outline_inverse = 'btn-outline-light' if is_dark else 'btn-outline-dark' %}
{% set text_muted = 'text-secondary' if is_dark else 'text-muted' %}
<div class="mb-4">
  <a href="{{ url_for('bia.dashboard') }}" class="{{ text_muted }} text-decoration-none">&larr; {{ _('bia.context_form.back') }}</a>
</div>

<div class="row justify-content-center">
  <div class="col-lg-9 col-xl-8">
    <div class="card {{ card_surface }} mb-4">
      <div class="card-body p-4">
  <h1 class="h3 mb-4">{% if item %}{{ _('bia.context_form.heading_edit', name=item.name) }}{% else %}{{ _('bia.context_form.heading_new') }}{% endif %}</h1>
        <form method="post">
          {{ form.hidden_tag() }}

          <h2 class="h5 text-uppercase {{ text_muted }} mb-3">{{ _('bia.context_form.section.general') }}</h2>
          <div class="row g-3">
            {{ render_field_with_tooltip(form.name, _('bia.context_form.fields.name.label'), _('bia.context_form.tooltips.name'), container_class='col-md-6', input_class='form-control') }}
            <div class="col-md-6">{{ form.user_amount.label(_('bia.context_form.fields.user_amount.label'), class="form-label") }}{{ form.user_amount(class="form-control") }}</div>
          </div>
          <div class="row g-3 mt-1">
            <div class="col-md-6">{{ form.start_date.label(_('bia.context_form.fields.start_date.label'), class="form-label") }}{{ form.start_date(class="form-control", type="date") }}</div>
            <div class="col-md-6">{{ form.end_date.label(_('bia.context_form.fields.end_date.label'), class="form-label") }}{{ form.end_date(class="form-control", type="date") }}</div>
          </div>
          <div class="mt-3">{{ form.service_description.label(_('bia.context_form.fields.service_description.label'), class="form-label") }}{{ form.service_description(class="form-control", rows=3) }}</div>
          <div class="mt-3">{{ form.scope_description.label(_('bia.context_form.fields.scope_description.label'), class="form-label") }}{{ form.scope_description(class="form-control", rows=3) }}</div>

          <h2 class="h5 text-uppercase {{ text_muted }} mt-4 mb-3">{{ _('bia.context_form.section.contacts') }}</h2>
          <div class="row g-3">
            <div class="col-md-6">
              {{ form.responsible.label(_('bia.context_form.fields.responsible.label'), class="form-label") }}
              {% if can_assign_owner|default(False) %}
                {{ form.responsible(class="form-control") }}
              {% else %}
                {{ form.responsible(class="form-control", readonly=True) }}
                <div class="form-text {{ text_muted }}">{{ _('bia.context_form.responsible_hint') }}</div>
              {% endif %}
            </div>
            <div class="col-md-6">{{ form.coordinator.label(_('bia.context_form.fields.coordinator.label'), class="form-label") }}{{ form.coordinator(class="form-control") }}</div>
            <div class="col-md-6">{{ form.project_leader.label(_('bia.context_form.fields.project_leader.label'), class="form-label") }}{{ form.project_leader(class="form-control") }}</div>
            <div class="col-md-6">{{ form.product_owner.label(_('bia.context_form.fields.product_owner.label'), class="form-label") }}{{ form.product_owner(class="form-control") }}</div>
            <div class="col-md-6">{{ form.risk_owner.label(_('bia.context_form.fields.risk_owner.label'), class="form-label") }}{{ form.risk_owner(class="form-control") }}</div>
            <div class="col-md-6">{{ form.technical_administrator.label(_('bia.context_form.fields.technical_administrator.label'), class="form-label") }}{{ form.technical_administrator(class="form-control") }}</div>
            <div class="col-md-6">{{ form.security_manager.label(_('bia.context_form.fields.security_manager.label'), class="form-label") }}{{ form.security_manager(class="form-control") }}</div>
            <div class="col-md-6">{{ form.incident_contact.label(_('bia.context_form.fields.incident_contact.label'), class="form-label") }}{{ form.incident_contact(class="form-control") }}</div>
          </div>

          <h2 class="h5 text-uppercase {{ text_muted }} mt-4 mb-3">{{ _('bia.context_form.section.dependencies') }}</h2>
          <div class="mt-3">{{ form.mission_critical.label(_('bia.context_form.fields.mission_critical.label'), class="form-label") }}{{ form.mission_critical(class="form-control", rows=2) }}</div>
          <div class="mt-3">{{ form.knowledge.label(_('bia.context_form.fields.knowledge.label'), class="form-label") }}{{ form.knowledge(class="form-control", rows=2) }}</div>
          <div class="mt-3">{{ form.interfaces.label(_('bia.context_form.fields.interfaces.label'), class="form-label") }}{{ form.interfaces(class="form-control", rows=2) }}</div>
          <div class="mt-3">{{ form.support_contracts.label(_('bia.context_form.fields.support_contracts.label'), class="form-label") }}{{ form.support_contracts(class="form-control") }}</div>
          <div class="mt-3">{{ form.security_supplier.label(_('bia.context_form.fields.security_supplier.label'), class="form-label") }}{{ form.security_supplier(class="form-control") }}</div>

          <h2 class="h5 text-uppercase {{ text_muted }} mt-4 mb-3">{{ _('bia.context_form.section.risk') }}</h2>
          <div class="row g-3">
            <div class="col-md-6">
              <div class="form-check form-switch">
                {{ form.risk_assessment_human(class="form-check-input", role="switch") }}
                {{ form.risk_assessment_human.label(_('bia.context_form.fields.risk_assessment_human.label'), class="form-check-label") }}
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-check form-switch">
                {{ form.risk_assessment_process(class="form-check-input", role="switch") }}
                {{ form.risk_assessment_process.label(_('bia.context_form.fields.risk_assessment_process.label'), class="form-check-label") }}
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-check form-switch">
                {{ form.risk_assessment_technological(class="form-check-input", role="switch") }}
                {{ form.risk_assessment_technological.label(_('bia.context_form.fields.risk_assessment_technological.label'), class="form-check-label") }}
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-check form-switch">
                {{ form.ai_model(class="form-check-input", role="switch") }}
                {{ form.ai_model.label(_('bia.context_form.fields.ai_model.label'), class="form-check-label") }}
              </div>
            </div>
          </div>

          <div class="d-flex justify-content-end gap-2 mt-4">
            <a href="{{ url_for('bia.dashboard') }}" class="btn btn-outline-secondary">{{ _('actions.cancel') }}</a>
            {{ form.submit(class="btn btn-primary", value=_('bia.context_form.submit')) }}
          </div>
        </form>
      </div>
    </div>

    {% if item %}
  <div class="card {{ card_surface }} mb-4">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h2 class="h5 mb-0">{{ _('bia.context_form.components.title') }}</h2>
          <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#biaAddComponentModal">
            <i class="fas fa-plus me-1"></i>{{ _('bia.context_form.components.add') }}
          </button>
        </div>
        <div class="row g-3" id="bia-component-list">
          {% for component in item.components %}
          <div class="col-md-6 col-xl-4" data-component-id="{{ component.id }}">
            <div class="card {{ card_surface }} h-100">
              <div class="card-body">
                <h3 class="h6 text-uppercase {{ text_muted }}">{{ component.name }}</h3>
                <p class="{{ text_muted }} small mb-3">{{ _('bia.context_form.components.linked_to', context=item.name) }}</p>
                <div class="d-flex flex-wrap gap-1 mb-3" data-environment-summary>
                  {% for environment_type in bia_environment_types %}
                    {% set env_assignment = bia_component_environment(component, environment_type) %}
                    {% set env_label = bia_environment_label(environment_type) %}
                    {% if env_assignment and env_assignment.is_enabled %}
                      {% set env_auth = bia_environment_authentication(env_assignment) %}
                      <span class="badge bg-success">{{ env_label }}{% if env_auth %} · {{ env_auth }}{% else %} · {{ _('bia.components.environments.badge_no_auth') }}{% endif %}</span>
                    {% else %}
                      <span class="badge bg-secondary">{{ env_label }} · {{ _('bia.components.environments.badge_not_used') }}</span>
                    {% endif %}
                  {% endfor %}
                </div>
                <div class="d-flex gap-2">
                  <button type="button" class="btn {{ outline_inverse }} btn-sm w-50 bia-view-component" data-component-id="{{ component.id }}">
                              <i class="fas fa-eye me-1"></i>{{ _('actions.view') }}
                  </button>
                  <button type="button" class="btn btn-outline-danger btn-sm w-50 bia-delete-component" data-component-id="{{ component.id }}">
                    <i class="fas fa-trash me-1"></i>{{ _('actions.delete') }}
                  </button>
                </div>
              </div>
            </div>
          </div>
          {% else %}
          <div class="col-12" id="bia-no-components">
            <div class="alert alert-secondary mb-0">{{ _('bia.context_form.components.empty') }}</div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <div class="card {{ card_surface }}">
      <div class="card-body">
        <h2 class="h5 mb-3">{{ _('bia.context_form.next_steps.title') }}</h2>
        <p class="{{ text_muted }} mb-3">{{ _('bia.context_form.next_steps.subtitle', context=item.name) }}</p>
        <div class="d-flex flex-wrap gap-2">
          <a href="{{ url_for('bia.view_item', item_id=item.id) }}" class="btn {{ outline_inverse }} btn-sm">{{ _('bia.context_form.next_steps.view') }}</a>
          <a href="{{ url_for('bia.manage_summary', item_id=item.id) }}" class="btn {{ outline_inverse }} btn-sm">{{ _('bia.context_form.next_steps.summary') }}</a>
          <a href="{{ url_for('bia.export_item', item_id=item.id) }}" class="btn {{ outline_inverse }} btn-sm">{{ _('bia.context_form.next_steps.export_html') }}</a>
          <a href="{{ url_for('bia.export_csv', item_id=item.id) }}" class="btn {{ outline_inverse }} btn-sm">{{ _('bia.context_form.next_steps.export_csv') }}</a>
        </div>
      </div>
    </div>

    <!-- View component modal -->
    <div class="modal fade" id="biaViewComponentModal" tabindex="-1" aria-labelledby="biaViewComponentModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content {{ card_surface }}">
          <div class="modal-header {{ border_class }}">
            <h2 class="modal-title h5" id="biaViewComponentModalLabel">{{ _('bia.context_form.modals.view.title') }}</h2>
            <button type="button" class="btn-close{% if is_dark %} btn-close-white{% endif %}" data-bs-dismiss="modal" aria-label="{{ _('actions.close') }}"></button>
          </div>
          <div class="modal-body">
            <dl class="row mb-0">
              <dt class="col-sm-4 {{ text_muted }}">{{ _('bia.context_form.modals.view.name') }}</dt>
              <dd class="col-sm-8" id="bia-view-component-name"></dd>
              <dt class="col-sm-4 {{ text_muted }}">{{ _('bia.context_form.modals.view.info_type') }}</dt>
              <dd class="col-sm-8" id="bia-view-component-info-type"></dd>
              <dt class="col-sm-4 {{ text_muted }}">{{ _('bia.context_form.modals.view.info_owner') }}</dt>
              <dd class="col-sm-8" id="bia-view-component-info-owner"></dd>
              <dt class="col-sm-4 {{ text_muted }}">{{ _('bia.context_form.modals.view.user_type') }}</dt>
              <dd class="col-sm-8" id="bia-view-component-user-type"></dd>
              <dt class="col-sm-4 {{ text_muted }}">{{ _('bia.context_form.modals.view.environments') }}</dt>
              <dd class="col-sm-8" id="bia-view-component-environments"></dd>
              <dt class="col-sm-4 {{ text_muted }}">{{ _('bia.context_form.modals.view.dependencies') }}</dt>
              <dd class="col-sm-8" id="bia-view-component-process"></dd>
              <dt class="col-sm-4 {{ text_muted }}">{{ _('bia.context_form.modals.view.description') }}</dt>
              <dd class="col-sm-8" id="bia-view-component-description"></dd>
              <dt class="col-sm-4 {{ text_muted }}">{{ _('bia.context_form.modals.view.consequences') }}</dt>
              <dd class="col-sm-8"><span id="bia-view-component-consequences"></span></dd>
            </dl>
          </div>
          <div class="modal-footer {{ border_class }}">
            <a class="btn {{ outline_inverse }}" id="bia-view-consequences-link" target="_blank" rel="noopener">{{ _('bia.context_form.modals.view.consequence_link') }}</a>
            <button type="button" class="btn btn-primary" id="bia-edit-component-launch" data-component-id="">
              <i class="fas fa-edit me-1"></i>{{ _('actions.edit') }}
            </button>
            <button type="button" class="btn btn-danger" id="bia-delete-component-launch" data-component-id="">
              <i class="fas fa-trash me-1"></i>{{ _('actions.delete') }}
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Add component modal -->
    <div class="modal fade" id="biaAddComponentModal" tabindex="-1" aria-labelledby="biaAddComponentModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content {{ card_surface }}">
          <div class="modal-header {{ border_class }}">
            <h2 class="modal-title h5" id="biaAddComponentModalLabel">{{ _('bia.context_form.modals.add.title') }}</h2>
            <button type="button" class="btn-close{% if is_dark %} btn-close-white{% endif %}" data-bs-dismiss="modal" aria-label="{{ _('actions.close') }}"></button>
          </div>
          <div class="modal-body">
            <form id="bia-component-form">
              {{ component_form.hidden_tag() }}
              {{ render_field_with_tooltip(component_form.name, _('bia.context_form.component_fields.name.label'), _('bia.components.tooltips.name'), container_class='mb-3', input_class='form-control', id='bia-component-name') }}
              <div class="mb-3">
                {{ component_form.info_type.label(_('bia.context_form.component_fields.info_type.label'), class="form-label") }}
                {{ component_form.info_type(class="form-control", id="bia-component-info-type") }}
              </div>
              <div class="mb-3">
                {{ component_form.info_owner.label(_('bia.context_form.component_fields.info_owner.label'), class="form-label") }}
                {{ component_form.info_owner(class="form-control", id="bia-component-info-owner") }}
              </div>
              <div class="mb-3">
                {{ component_form.user_type.label(_('bia.context_form.component_fields.user_type.label'), class="form-label") }}
                {{ component_form.user_type(class="form-control", id="bia-component-user-type") }}
              </div>
              <div class="mb-3">
                {{ component_form.process_dependencies.label(_('bia.context_form.component_fields.process_dependencies.label'), class="form-label") }}
                {{ component_form.process_dependencies(class="form-control", id="bia-component-process-dependencies", rows=3) }}
              </div>
              <fieldset class="border rounded p-3 mb-3">
                <legend class="float-none w-auto px-2 h6 mb-0">{{ _('bia.components.environments.section_title') }}</legend>
                <p class="text-secondary small mb-3">{{ _('bia.components.environments.section_help') }}</p>
                <div class="table-responsive">
                  <table class="table table-sm table-dark align-middle mb-0">
                    <thead>
                      <tr>
                        <th scope="col">{{ _('bia.components.environments.columns.environment') }}</th>
                        <th scope="col">{{ _('bia.components.environments.columns.used') }}</th>
                        <th scope="col">{{ _('bia.components.environments.columns.authentication') }}</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for environment_type in bia_environment_types %}
                        {% set checkbox_id = 'bia-component-environment-enabled-' ~ loop.index0 %}
                        {% set select_id = 'bia-component-environment-auth-' ~ loop.index0 %}
                        <tr>
                          <td class="text-nowrap">
                            <input type="hidden" id="bia-component-environment-type-{{ loop.index0 }}" name="environments-{{ loop.index0 }}-environment_type" value="{{ environment_type }}">
                            {{ bia_environment_label(environment_type) }}
                          </td>
                          <td>
                            <div class="form-check">
                              <input type="checkbox" class="form-check-input" id="{{ checkbox_id }}" name="environments-{{ loop.index0 }}-is_enabled">
                              <label class="form-check-label" for="{{ checkbox_id }}">{{ _('bia.components.environments.toggle_label') }}</label>
                            </div>
                          </td>
                          <td>
                            <select class="form-select" id="{{ select_id }}" name="environments-{{ loop.index0 }}-authentication_method">
                              {% for value, label in component_form.environment_authentication_choices %}
                                <option value="{{ value }}"{% if loop.first %} selected{% endif %}>{{ label }}</option>
                              {% endfor %}
                            </select>
                          </td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </fieldset>
              <div class="mb-3">
                {{ component_form.description.label(_('bia.context_form.component_fields.description.label'), class="form-label") }}
                {{ component_form.description(class="form-control", id="bia-component-description", rows=3) }}
              </div>
            </form>
          </div>
          <div class="modal-footer {{ border_class }}">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">{{ _('actions.cancel') }}</button>
            <button type="button" class="btn btn-primary" id="bia-save-component">{{ _('bia.context_form.modals.add.submit') }}</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit component modal -->
    <div class="modal fade" id="biaEditComponentModal" tabindex="-1" aria-labelledby="biaEditComponentModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content {{ card_surface }}">
          <div class="modal-header {{ border_class }}">
            <h2 class="modal-title h5" id="biaEditComponentModalLabel">{{ _('bia.context_form.modals.edit.title') }}</h2>
            <button type="button" class="btn-close{% if is_dark %} btn-close-white{% endif %}" data-bs-dismiss="modal" aria-label="{{ _('actions.close') }}"></button>
          </div>
          <div class="modal-body">
            <form id="bia-edit-component-form">
              {{ component_form.hidden_tag() }}
              <input type="hidden" name="component_id" id="bia-edit-component-id">
              {{ render_field_with_tooltip(component_form.name, _('bia.context_form.component_fields.name.label'), _('bia.components.tooltips.name'), container_class='mb-3', input_class='form-control', id='bia-edit-component-name') }}
              <div class="mb-3">
                {{ component_form.info_type.label(_('bia.context_form.component_fields.info_type.label'), class="form-label") }}
                {{ component_form.info_type(class="form-control", id="bia-edit-component-info-type") }}
              </div>
              <div class="mb-3">
                {{ component_form.info_owner.label(_('bia.context_form.component_fields.info_owner.label'), class="form-label") }}
                {{ component_form.info_owner(class="form-control", id="bia-edit-component-info-owner") }}
              </div>
              <div class="mb-3">
                {{ component_form.user_type.label(_('bia.context_form.component_fields.user_type.label'), class="form-label") }}
                {{ component_form.user_type(class="form-control", id="bia-edit-component-user-type") }}
              </div>
              <div class="mb-3">
                {{ component_form.process_dependencies.label(_('bia.context_form.component_fields.process_dependencies.label'), class="form-label") }}
                {{ component_form.process_dependencies(class="form-control", id="bia-edit-component-process-dependencies", rows=3) }}
              </div>
              <fieldset class="border rounded p-3 mb-3">
                <legend class="float-none w-auto px-2 h6 mb-0">{{ _('bia.components.environments.section_title') }}</legend>
                <p class="text-secondary small mb-3">{{ _('bia.components.environments.section_help') }}</p>
                <div class="table-responsive">
                  <table class="table table-sm table-dark align-middle mb-0">
                    <thead>
                      <tr>
                        <th scope="col">{{ _('bia.components.environments.columns.environment') }}</th>
                        <th scope="col">{{ _('bia.components.environments.columns.used') }}</th>
                        <th scope="col">{{ _('bia.components.environments.columns.authentication') }}</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for environment_type in bia_environment_types %}
                        {% set checkbox_id = 'bia-edit-environment-enabled-' ~ loop.index0 %}
                        {% set select_id = 'bia-edit-environment-auth-' ~ loop.index0 %}
                        <tr>
                          <td class="text-nowrap">
                            <input type="hidden" id="bia-edit-environment-type-{{ loop.index0 }}" name="environments-{{ loop.index0 }}-environment_type" value="{{ environment_type }}">
                            {{ bia_environment_label(environment_type) }}
                          </td>
                          <td>
                            <div class="form-check">
                              <input type="checkbox" class="form-check-input" id="{{ checkbox_id }}" name="environments-{{ loop.index0 }}-is_enabled">
                              <label class="form-check-label" for="{{ checkbox_id }}">{{ _('bia.components.environments.toggle_label') }}</label>
                            </div>
                          </td>
                          <td>
                            <select class="form-select" id="{{ select_id }}" name="environments-{{ loop.index0 }}-authentication_method">
                              {% for value, label in component_form.environment_authentication_choices %}
                                <option value="{{ value }}"{% if loop.first %} selected{% endif %}>{{ label }}</option>
                              {% endfor %}
                            </select>
                          </td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </fieldset>
              <div class="mb-3">
                {{ component_form.description.label(_('bia.context_form.component_fields.description.label'), class="form-label") }}
                {{ component_form.description(class="form-control", id="bia-edit-component-description", rows=3) }}
              </div>
            </form>
          </div>
          <div class="modal-footer {{ border_class }}">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">{{ _('actions.cancel') }}</button>
            <button type="button" class="btn btn-primary" id="bia-save-edit-component">{{ _('bia.context_form.modals.edit.submit') }}</button>
          </div>
        </div>
      </div>
    </div>

    <div id="bia-component-translations"
      data-empty="{{ _('bia.context_form.components.empty') }}"
      data-linked="{{ _('bia.context_form.components.linked_to', context=item.name)|e }}"
      data-view="{{ _('actions.view') }}"
      data-delete="{{ _('actions.delete') }}"
      data-env-not-used="{{ _('bia.components.environments.badge_not_used') }}"
      data-env-no-auth="{{ _('bia.components.environments.badge_no_auth') }}"
      data-env-order='{{ bia_environment_types | tojson | e }}'
      {% for environment_type in bia_environment_types %}
      data-env-{{ environment_type }}="{{ bia_environment_label(environment_type) }}"
      {% endfor %}>
    </div>

  <script nonce="{{ csp_nonce }}">
    document.addEventListener('DOMContentLoaded', () => {
      const componentList = document.getElementById('bia-component-list');
      if (!componentList) {
        return;
      }

      const translationNode = document.getElementById('bia-component-translations');
      if (!translationNode) {
        console.error('Translation node missing for component form.');
        return;
      }
      const translations = {
        componentsEmpty: translationNode.dataset.empty || '',
        componentsLinkedTo: translationNode.dataset.linked || '',
        actionsView: translationNode.dataset.view || '',
        actionsDelete: translationNode.dataset.delete || '',
        environmentNotUsed: translationNode.dataset.envNotUsed || '',
        environmentNoAuth: translationNode.dataset.envNoAuth || ''
      };

      const environmentTypes = JSON.parse(translationNode.dataset.envOrder || '[]');
      const environmentLabels = environmentTypes.reduce((accumulator, type) => {
        const datasetKey = `env${type.charAt(0).toUpperCase()}${type.slice(1)}`;
        accumulator[type] = translationNode.dataset[datasetKey] || type;
        return accumulator;
      }, {});

      const buildEnvironmentBadges = (environments = []) => {
        const environmentMap = new Map(environments.map((environment) => [environment.environment_type, environment]));
        return environmentTypes.map((type) => {
          const label = environmentLabels[type] || type;
          const environment = environmentMap.get(type);
          if (environment && environment.is_enabled) {
            const authenticationLabel = environment.authentication_method_label || translations.environmentNoAuth;
            return `<span class="badge bg-success">${label} · ${authenticationLabel}</span>`;
          }
          return `<span class="badge bg-secondary">${label} · ${translations.environmentNotUsed}</span>`;
        }).join(' ');
      };

      const applyEnvironmentBadges = (container, environments = []) => {
        if (!container) {
          return;
        }
        container.innerHTML = buildEnvironmentBadges(environments);
      };

      const updateEnvironmentForm = (form, prefix, environments = []) => {
        const environmentMap = new Map(environments.map((environment) => [environment.environment_type, environment]));
        environmentTypes.forEach((type, index) => {
          const checkbox = form.querySelector(`#${prefix}-environment-enabled-${index}`);
          const select = form.querySelector(`#${prefix}-environment-auth-${index}`);
          const environment = environmentMap.get(type);
          if (checkbox) {
            checkbox.checked = !!(environment && environment.is_enabled);
          }
          if (select) {
            const value = environment && environment.authentication_method_id != null ? String(environment.authentication_method_id) : '';
            select.value = value;
          }
        });
      };

      const routes = {
        add: '{{ url_for("bia.add_component") }}',
        detail: '{{ url_for("bia.get_component", component_id=0)[:-1] }}',
        update: '{{ url_for("bia.update_component", component_id=0)[:-1] }}',
        remove: '{{ url_for("bia.delete_component", component_id=0)[:-1] }}',
        consequences: '{{ url_for("bia.view_consequences", component_id=0)[:-1] }}'
      };

      const addModal = new bootstrap.Modal(document.getElementById('biaAddComponentModal'));
      const editModal = new bootstrap.Modal(document.getElementById('biaEditComponentModal'));
      const viewModalEl = document.getElementById('biaViewComponentModal');
      const viewModal = new bootstrap.Modal(viewModalEl);

      const detailFields = {
        name: document.getElementById('bia-view-component-name'),
        info_type: document.getElementById('bia-view-component-info-type'),
        info_owner: document.getElementById('bia-view-component-info-owner'),
        user_type: document.getElementById('bia-view-component-user-type'),
        process_dependencies: document.getElementById('bia-view-component-process'),
        description: document.getElementById('bia-view-component-description'),
        consequences: document.getElementById('bia-view-component-consequences'),
        consequencesLink: document.getElementById('bia-view-consequences-link'),
        editTrigger: document.getElementById('bia-edit-component-launch'),
        deleteTrigger: document.getElementById('bia-delete-component-launch'),
        environments: document.getElementById('bia-view-component-environments')
      };

      const addForm = document.getElementById('bia-component-form');
      const editForm = document.getElementById('bia-edit-component-form');
      const addButton = document.getElementById('bia-save-component');
      const editButton = document.getElementById('bia-save-edit-component');
      const noComponentsId = 'bia-no-components';
      const biaId = '{{ item.id }}';

      const addCsrfField = addForm.querySelector('input[name="csrf_token"]');
      const editCsrfField = editForm.querySelector('input[name="csrf_token"]');
      const initialAddCsrf = addCsrfField ? addCsrfField.value : '';
      const initialEditCsrf = editCsrfField ? editCsrfField.value : '';

      const buildUrl = (base, id) => `${base}${id}`;
      const getCsrfToken = () => {
        if (addCsrfField && addCsrfField.value) {
          return addCsrfField.value;
        }
        return initialAddCsrf || (editCsrfField ? editCsrfField.value : initialEditCsrf);
      };

      let activeComponent = null;

      const refreshEmptyState = () => {
        const existingMessage = document.getElementById(noComponentsId);
        const hasComponents = componentList.querySelectorAll('[data-component-id]').length > 0;
        if (!hasComponents && !existingMessage) {
          const placeholder = document.createElement('div');
          placeholder.className = 'col-12';
          placeholder.id = noComponentsId;
          placeholder.innerHTML = `<div class="alert alert-secondary mb-0">${translations.componentsEmpty}</div>`;
          componentList.appendChild(placeholder);
        } else if (hasComponents && existingMessage) {
          existingMessage.remove();
        }
      };

      const renderComponentCard = (component) => {
        const wrapper = document.createElement('div');
        wrapper.className = 'col-md-6 col-xl-4';
        wrapper.dataset.componentId = component.id;
        const environmentMarkup = buildEnvironmentBadges(component.environments || []);
        wrapper.innerHTML = `
          <div class="card {{ card_surface }} h-100">
            <div class="card-body">
              <h3 class="h6 text-uppercase {{ text_muted }}">
                ${component.name}
              </h3>
              <p class="{{ text_muted }} small mb-3">${translations.componentsLinkedTo}</p>
              <div class="d-flex flex-wrap gap-1 mb-3" data-environment-summary>
                ${environmentMarkup}
              </div>
              <div class="d-flex gap-2">
                <button type="button" class="btn {{ outline_inverse }} btn-sm w-50 bia-view-component" data-component-id="${component.id}">
                  <i class="fas fa-eye me-1"></i>${translations.actionsView}
                </button>
                <button type="button" class="btn btn-outline-danger btn-sm w-50 bia-delete-component" data-component-id="${component.id}">
                  <i class="fas fa-trash me-1"></i>${translations.actionsDelete}
                </button>
              </div>
            </div>
          </div>`;
        return wrapper;
      };

      const populateDetail = (data) => {
        const fallback = (value) => (value && value.trim()) ? value : '—';
        detailFields.name.textContent = fallback(data.name);
        detailFields.info_type.textContent = fallback(data.info_type || '');
        detailFields.info_owner.textContent = fallback(data.info_owner || '');
        detailFields.user_type.textContent = fallback(data.user_type || '');
          applyEnvironmentBadges(detailFields.environments, data.environments || []);
        detailFields.process_dependencies.textContent = fallback(data.process_dependencies || '');
        detailFields.description.textContent = fallback(data.description || '');
        detailFields.consequences.textContent = data.consequences_count ?? 0;
        detailFields.consequencesLink.href = buildUrl(routes.consequences, data.id);
        detailFields.editTrigger.dataset.componentId = data.id;
        detailFields.deleteTrigger.dataset.componentId = data.id;
      };

      const populateEditForm = (data) => {
        editForm.querySelector('#bia-edit-component-id').value = data.id;
        editForm.querySelector('#bia-edit-component-name').value = data.name || '';
        editForm.querySelector('#bia-edit-component-info-type').value = data.info_type || '';
        editForm.querySelector('#bia-edit-component-info-owner').value = data.info_owner || '';
        editForm.querySelector('#bia-edit-component-user-type').value = data.user_type || '';
        editForm.querySelector('#bia-edit-component-process-dependencies').value = data.process_dependencies || '';
        editForm.querySelector('#bia-edit-component-description').value = data.description || '';
        updateEnvironmentForm(editForm, 'bia-edit', data.environments || []);
        if (editCsrfField) {
          editCsrfField.value = initialEditCsrf || editCsrfField.value;
        }
      };

      const openViewModal = (componentId) => {
        fetch(buildUrl(routes.detail, componentId), { credentials: 'same-origin' })
          .then((response) => response.ok ? response.json() : Promise.reject(response))
          .then((data) => {
            activeComponent = { ...data, id: componentId };
            populateDetail(activeComponent);
            viewModal.show();
          })
          .catch(() => {
            alert('Unable to load component details.');
          });
      };

      const deleteComponent = (componentId) => {
        if (!confirm('Are you sure you want to delete this component?')) {
          return;
        }
        fetch(buildUrl(routes.remove, componentId), {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
          },
          credentials: 'same-origin'
        })
          .then((response) => response.ok ? response.json() : Promise.reject(response))
          .then((data) => {
            if (!data.success) {
              throw new Error('Server reported a problem.');
            }
            const card = componentList.querySelector(`[data-component-id="${componentId}"]`);
            if (card) {
              card.remove();
            }
            refreshEmptyState();
            if (viewModalEl.classList.contains('show')) {
              viewModal.hide();
            }
          })
          .catch(() => {
            alert('Error while deleting the component.');
          });
      };

      refreshEmptyState();

      addButton.addEventListener('click', () => {
        const formData = new FormData(addForm);
        formData.append('bia_id', biaId);
        const csrfValue = formData.get('csrf_token');
        fetch(routes.add, {
          method: 'POST',
          body: formData,
          headers: csrfValue ? { 'X-CSRFToken': csrfValue } : {},
          credentials: 'same-origin'
        })
          .then((response) => response.ok ? response.json() : response.json().then((data) => Promise.reject(data)))
          .then((data) => {
            if (!data.success) {
              throw data;
            }
            const card = renderComponentCard(data);
            const placeholder = document.getElementById(noComponentsId);
            if (placeholder) {
              placeholder.remove();
            }
            componentList.appendChild(card);
            refreshEmptyState();
            addModal.hide();
            addForm.reset();
            updateEnvironmentForm(addForm, 'bia-component', []);
            if (addCsrfField) {
              addCsrfField.value = initialAddCsrf;
            }
          })
          .catch((error) => {
            if (error && error.errors) {
              const messages = Object.entries(error.errors).map(([field, issues]) => `${field}: ${issues.join(', ')}`).join('\n');
              alert(`Unable to add component:\n${messages}`);
            } else {
              alert('Unable to add component.');
            }
          });
      });

      editButton.addEventListener('click', () => {
        const formData = new FormData(editForm);
        const componentId = formData.get('component_id');
        if (!componentId) {
          alert('Component identifier missing.');
          return;
        }
        const csrfValue = formData.get('csrf_token');
        fetch(buildUrl(routes.update, componentId), {
          method: 'POST',
          body: formData,
          headers: csrfValue ? { 'X-CSRFToken': csrfValue } : {},
          credentials: 'same-origin'
        })
          .then((response) => response.ok ? response.json() : response.json().then((data) => Promise.reject(data)))
          .then((data) => {
            if (!data.success) {
              throw data;
            }
            const card = componentList.querySelector(`[data-component-id="${componentId}"]`);
            if (card) {
              const title = card.querySelector('.card-body h3');
              if (title) {
                title.textContent = data.name;
              }
              const environmentSummary = card.querySelector('[data-environment-summary]');
              if (environmentSummary) {
                environmentSummary.innerHTML = buildEnvironmentBadges(data.environments || []);
              }
            }
            if (activeComponent && String(activeComponent.id) === String(componentId)) {
              activeComponent = {
                ...activeComponent,
                name: data.name,
                authentication_method_id: data.authentication_method_id,
                authentication_method_label: data.authentication_method_label,
                authentication_method_slug: data.authentication_method_slug,
                environments: data.environments || []
              };
              populateDetail(activeComponent);
            }
            editModal.hide();
          })
          .catch((error) => {
            if (error && error.errors) {
              const messages = Object.entries(error.errors).map(([field, issues]) => `${field}: ${issues.join(', ')}`).join('\n');
              alert(`Unable to update component:\n${messages}`);
            } else {
              alert('Unable to update component.');
            }
          });
      });

      detailFields.editTrigger.addEventListener('click', () => {
        if (!activeComponent) {
          return;
        }
        populateEditForm(activeComponent);
        viewModal.hide();
        editModal.show();
      });

      detailFields.deleteTrigger.addEventListener('click', () => {
        if (activeComponent) {
          deleteComponent(activeComponent.id);
        }
      });

      componentList.addEventListener('click', (event) => {
        const button = event.target.closest('button[data-component-id]');
        if (!button) {
          return;
        }
        const componentId = button.dataset.componentId;
        if (button.classList.contains('bia-view-component')) {
          openViewModal(componentId);
        }
        if (button.classList.contains('bia-delete-component')) {
          deleteComponent(componentId);
        }
      });
    });
    </script>
    {% endif %}
  </div>
</div>
{% endblock %}
