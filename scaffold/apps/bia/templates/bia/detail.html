{% extends "base.html" %}
{% block title %}{{ context.name }} | BIA{% endblock %}
{% block content %}
<a class="inline-flex items-center justify-center font-medium rounded-md px-4 py-2 text-sm transition-colors border border-transparent hover:text-[var(--color-text)] no-underline text-[var(--color-muted)] mb-3 pl-0" href="{{ dashboard_url }}">&larr; {{ _('bia.detail.back') }}</a>

<div class="flex flex-col lg:flex-row justify-between items-start gap-4 mb-4">
	<div>
		<h1 class="mb-1 text-2xl font-bold">{{ context.name }}</h1>
		<p class="text-[var(--color-muted)] mb-0">{{ _('bia.detail.header.last_updated', date=context.last_update or '–') }}</p>
	</div>
	<div class="text-right">
		<span class="text-[var(--color-muted)] text-sm block">{{ _('bia.detail.header.owner') }}</span>
		<div class="font-semibold">{{ context.responsible or _('bia.detail.header.not_set') }}</div>
		{% if context.coordinator %}
			<div class="text-[var(--color-muted)] text-sm">{{ _('bia.detail.header.coordinator_label') }} {{ context.coordinator }}</div>
		{% endif %}
	</div>
</div>

<div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-5">
	{% for card in impact_cards.values() %}
	<div class="h-full">
		<div class="bg-[var(--color-card)] border border-[var(--color-border)] rounded-xl shadow-card h-full">
			<div class="px-5 py-4">
				<div class="flex justify-between items-start">
					<div>
						<p class="text-[var(--color-muted)] uppercase text-xs font-semibold tracking-wider mb-1">{{ card.label }}</p>
						<span class="{{ card.badge_class }}">{{ card.level }}</span>
					</div>
					<span class="text-[var(--color-muted)] text-sm">{{ _('bia.detail.sections.cia_impact') }}</span>
				</div>
			</div>
		</div>
	</div>
	{% endfor %}
	<div class="h-full">
		<div class="bg-[var(--color-card)] border border-[var(--color-border)] rounded-xl shadow-card h-full">
			<div class="px-5 py-4">
				<p class="text-[var(--color-muted)] uppercase text-xs font-semibold tracking-wider mb-1">{{ _('bia.detail.sections.components') }}</p>
				<p class="text-3xl font-bold mb-0 text-[var(--color-text)]">{{ component_count }}</p>
			</div>
		</div>
	</div>
</div>


<div class="flex flex-col lg:flex-row items-start gap-4">
	<div class="grow w-full">
		<div class="bg-[var(--color-card)] border border-[var(--color-border)] rounded-xl shadow-card h-full">
			<div class="px-5 py-4 border-b border-[var(--color-border)] flex justify-between items-center">
				<span class="font-semibold text-lg">Components</span>
				<a href="{{ url_for('bia.view_components', scope=context.name, bia_id=context.id) }}#add-component-panel" class="inline-flex items-center justify-center font-medium rounded-md px-4 py-2 text-sm transition-colors border border-transparent bg-primary-600 text-white hover:bg-primary-700 px-2.5 py-1 text-xs">
					<i class="fas fa-plus mr-1"></i>{{ _('bia.context_form.components.add') }}
				</a>
			</div>
			<div class="px-5 py-4 p-0">
				{% if components %}
				<div class="overflow-x-auto w-full">
					<table class="w-full text-sm border-collapse bg-[var(--color-card)] [&_tbody_tr]:hover:bg-primary-500/5 align-middle mb-0">
						<thead class="bg-[var(--color-surface)]">
							<tr>
								<th scope="col" class="px-4 py-3 text-left font-semibold text-[var(--color-text)]">Name</th>
								<th scope="col" class="px-4 py-3 text-left font-semibold text-[var(--color-text)]">Information Owner</th>
								<th scope="col" class="px-4 py-3 text-left font-semibold text-[var(--color-text)]">Users</th>
								<th scope="col" class="px-4 py-3 text-left font-semibold text-[var(--color-text)]">Consequences</th>
								<th scope="col" class="px-4 py-3 text-left font-semibold text-[var(--color-text)]">AI</th>
							</tr>
						</thead>
						<tbody class="divide-y divide-[var(--color-border)]">
							{% for component in components %}
							<tr>
								<td class="px-4 py-3 font-semibold">{{ component.name }}</td>
								<td class="px-4 py-3">{{ component.info_owner or "–" }}</td>
								<td class="px-4 py-3">{{ component.user_type or "–" }}</td>
								<td class="px-4 py-3">{{ component.consequences | length }}</td>
								<td class="px-4 py-3">
									{% set ai_entries = ai_flags.get(component.id, []) %}
									{% if ai_entries %}
										<span class="inline-flex items-center text-xs font-semibold uppercase tracking-wide rounded-full px-2 py-0.5 bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300">{{ ai_entries | join(', ') }}</span>
									{% else %}
										<span class="text-[var(--color-muted)]">None</span>
									{% endif %}
								</td>
							</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>
				{% else %}
					<div class="p-4 text-[var(--color-muted)]">No components captured yet.</div>
				{% endif %}
			</div>
		</div>
	</div>
	<div class="shrink-0 w-full lg:w-auto" style="min-width: 280px; max-width: 100%; lg:max-width: 320px;">
		<div class="bg-[var(--color-card)] border border-[var(--color-border)] rounded-xl shadow-card mb-4">
			<div class="px-5 py-4 border-b border-[var(--color-border)] font-semibold">Mission & Scope</div>
			<div class="px-5 py-4">
				<p class="mb-4"><span class="text-[var(--color-muted)] text-sm block uppercase tracking-wide font-semibold mb-1">Mission Criticality</span>{{ context.mission_critical or "Not defined" }}</p>
				<p class="mb-4"><span class="text-[var(--color-muted)] text-sm block uppercase tracking-wide font-semibold mb-1">Scope</span>{{ context.scope_description or "Not documented" }}</p>
				{% if context.summary and context.summary.content %}
					<div>
						<span class="text-[var(--color-muted)] text-sm block uppercase tracking-wide font-semibold mb-1">Executive Summary</span>
						<p class="mb-0 text-sm whitespace-pre-wrap">{{ context.summary.content }}</p>
					</div>
				{% endif %}
			</div>
		</div>
		<div class="bg-[var(--color-card)] border border-[var(--color-border)] rounded-xl shadow-card">
			<div class="px-5 py-4 border-b border-[var(--color-border)] font-semibold">Key Contacts</div>
			<div class="px-5 py-4">
				<div class="grid grid-cols-2 gap-4 text-sm">
					<div>
						<div class="uppercase text-xs text-[var(--color-muted)] font-semibold tracking-wide mb-0.5">Product Owner</div>
						<div class="text-[var(--color-text)] font-medium">{{ context.product_owner or "–" }}</div>
					</div>
					<div>
						<div class="uppercase text-xs text-[var(--color-muted)] font-semibold tracking-wide mb-0.5">Risk Owner</div>
						<div class="text-[var(--color-text)] font-medium">{{ context.risk_owner or "–" }}</div>
					</div>
					<div>
						<div class="uppercase text-xs text-[var(--color-muted)] font-semibold tracking-wide mb-0.5">Security Mgr</div>
						<div class="text-[var(--color-text)] font-medium">{{ context.security_manager or "–" }}</div>
					</div>
					<div>
						<div class="uppercase text-xs text-[var(--color-muted)] font-semibold tracking-wide mb-0.5">Incident Contact</div>
						<div class="text-[var(--color-text)] font-medium">{{ context.incident_contact or "–" }}</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
{% endblock %}
