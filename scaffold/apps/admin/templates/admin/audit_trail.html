{% extends "base.html" %}
{% block title %}{{ _('admin.audit.title') }}{% endblock %}
{% block main_container_class %}container-fluid px-3 px-lg-4{% endblock %}
{% block content %}
<div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-3 mb-4">
  <div>
    <h1 class="mb-1">{{ _('admin.audit.heading') }}</h1>
    <p class="text-secondary mb-0">{{ _('admin.audit.subtitle') }}</p>
  </div>
  <a class="btn btn-outline-light" href="{{ url_for('admin.list_users') }}">{{ _('admin.audit.link_back') }}</a>
</div>

<form method="get" class="row g-3 align-items-end mb-4">
  <div class="col-12 col-md-3 col-xl-2">
    <label for="filter-start-date" class="form-label">{{ _('admin.audit.filters.start_date') }}</label>
    <input type="date" class="form-control" id="filter-start-date" name="start_date" value="{{ filters.start_date }}">
  </div>
  <div class="col-12 col-md-3 col-xl-2">
    <label for="filter-end-date" class="form-label">{{ _('admin.audit.filters.end_date') }}</label>
    <input type="date" class="form-control" id="filter-end-date" name="end_date" value="{{ filters.end_date }}">
  </div>
  <div class="col-12 col-md-3 col-xl-2">
    <label for="filter-event-type" class="form-label">{{ _('admin.audit.filters.event_type') }}</label>
    <select class="form-select" id="filter-event-type" name="event_type">
      <option value="">{{ _('admin.audit.filters.event_type_all') }}</option>
      {% for option in event_types %}
        <option value="{{ option }}"{% if filters.event_type == option %} selected{% endif %}>{{ option }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-12 col-md-3 col-xl-2">
    <label for="filter-action" class="form-label">{{ _('admin.audit.filters.action') }}</label>
    <input type="text" class="form-control" id="filter-action" name="action" value="{{ filters.action }}">
  </div>
  <div class="col-12 col-md-3 col-xl-2">
    <label for="filter-actor" class="form-label">{{ _('admin.audit.filters.actor') }}</label>
    <input type="text" class="form-control" id="filter-actor" name="actor" value="{{ filters.actor }}" placeholder="{{ _('admin.audit.filters.actor_placeholder') }}" list="actor-email-options">
    {% if actor_options %}
      <datalist id="actor-email-options">
        {% for option in actor_options %}
          <option value="{{ option }}">
        {% endfor %}
      </datalist>
    {% endif %}
  </div>
  <div class="col-12 col-md-3 col-xl-2">
    <label for="filter-entity" class="form-label">{{ _('admin.audit.filters.entity') }}</label>
    <input type="text" class="form-control" id="filter-entity" name="entity_type" value="{{ filters.entity_type }}">
  </div>
  <div class="col-6 col-md-3 col-xl-2">
    <label for="filter-per-page" class="form-label">{{ _('admin.audit.filters.per_page') }}</label>
    <select class="form-select" id="filter-per-page" name="per_page">
      {% for option in [25, 50, 100] %}
        <option value="{{ option }}"{% if pagination.per_page == option %} selected{% endif %}>{{ option }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-6 col-md-3 col-xl-2 d-grid">
    <button type="submit" class="btn btn-outline-light">{{ _('admin.audit.filters.submit') }}</button>
  </div>
  <div class="col-12 col-md-3 col-xl-2 d-grid">
    <a href="{{ url_for('admin.audit_trail') }}" class="btn btn-outline-secondary">{{ _('admin.audit.filters.reset') }}</a>
  </div>
</form>

{% if entries %}
  <div class="table-responsive">
    <table class="table table-dark table-striped align-middle">
      <thead>
        <tr>
          <th scope="col">{{ _('admin.audit.table.timestamp') }}</th>
          <th scope="col">{{ _('admin.audit.table.user') }}</th>
          <th scope="col">{{ _('admin.audit.table.action') }}</th>
          <th scope="col">{{ _('admin.audit.table.entity') }}</th>
          <th scope="col">{{ _('admin.audit.table.details') }}</th>
          <th scope="col">{{ _('admin.audit.table.ip') }}</th>
          <th scope="col">{{ _('admin.audit.table.user_agent') }}</th>
        </tr>
      </thead>
      <tbody>
        {% for entry in entries %}
          {% set actor = entry.actor %}
          {% set actor_name = entry.actor_name or (actor.full_name if actor else '') %}
          {% set actor_email = entry.actor_email or (actor.email if actor else '') %}
          <tr>
            <td class="text-nowrap">{{ entry.created_at.strftime('%Y-%m-%d %H:%M:%S %Z') if entry.created_at else '-' }}</td>
            <td>
              {% if actor_name or actor_email %}
                {% if actor_name %}
                  <div class="fw-semibold">{{ actor_name }}</div>
                {% endif %}
                {% if actor_email %}
                  <div class="text-secondary small">{{ actor_email }}</div>
                {% endif %}
              {% else %}
                <span class="badge bg-secondary">{{ _('admin.audit.table.anonymous') }}</span>
              {% endif %}
            </td>
            <td>
              <span class="badge bg-info text-dark text-uppercase">{{ entry.event_type }}</span>
            </td>
            <td>
              <div class="fw-semibold">{{ entry.target_type }}</div>
              {% if entry.target_id %}
                <div class="text-secondary small">{{ _('admin.audit.table.entity_id', identifier=entry.target_id) }}</div>
              {% endif %}
            </td>
            <td class="text-break">
              {% if entry.payload %}
                <pre class="bg-black text-light p-2 rounded small mb-0">{{ entry.payload | tojson(indent=2) }}</pre>
              {% else %}
                <span class="text-secondary">{{ _('admin.audit.table.no_details') }}</span>
              {% endif %}
            </td>
            <td class="text-nowrap">{{ entry.actor_ip or '-' }}</td>
            <td class="text-break">{{ entry.actor_user_agent or '-' }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="d-flex flex-column flex-sm-row align-items-sm-center justify-content-between gap-3 mt-3">
    <div class="text-secondary small flex-grow-1">
      {{ _('admin.audit.pagination.summary', start=pagination.first_item or 0, end=pagination.last_item or 0, total=pagination.total) }}
    </div>
    <nav class="flex-shrink-0" aria-label="{{ _('admin.audit.pagination.aria') }}">
      <ul class="pagination pagination-sm mb-0 flex-nowrap gap-1">
        <li class="page-item{% if not pagination.has_prev %} disabled{% endif %}">
            {% if pagination.has_prev %}
              <a class="page-link" href="{{ url_for('admin.audit_trail', page=pagination.prev_num, per_page=pagination.per_page, action=filters.action, entity_type=filters.entity_type, actor=filters.actor, event_type=filters.event_type, start_date=filters.start_date, end_date=filters.end_date) }}" aria-label="{{ _('admin.audit.pagination.previous') }}">&laquo;</a>
            {% else %}
              <span class="page-link">&laquo;</span>
            {% endif %}
        </li>
        <li class="page-item active"><span class="page-link">{{ pagination.page }}</span></li>
        <li class="page-item{% if not pagination.has_next %} disabled{% endif %}">
            {% if pagination.has_next %}
              <a class="page-link" href="{{ url_for('admin.audit_trail', page=pagination.next_num, per_page=pagination.per_page, action=filters.action, entity_type=filters.entity_type, actor=filters.actor, event_type=filters.event_type, start_date=filters.start_date, end_date=filters.end_date) }}" aria-label="{{ _('admin.audit.pagination.next') }}">&raquo;</a>
            {% else %}
              <span class="page-link">&raquo;</span>
            {% endif %}
        </li>
      </ul>
    </nav>
  </div>
{% else %}
  <div class="alert alert-secondary" role="alert">
    {{ _('admin.audit.empty') }}
  </div>
{% endif %}
{% endblock %}
