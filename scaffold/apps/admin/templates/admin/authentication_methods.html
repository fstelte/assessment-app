{% extends "base.html" %}
{% block title %}{{ _('admin.authentication_methods.title') }}{% endblock %}
{% block content %}
{% set is_dark = theme != 'light' %}
{% set border_class = 'border-secondary' if is_dark else 'border-secondary-subtle' %}
{% set card_surface = 'card ' + ('bg-dark ' + border_class if is_dark else 'bg-white ' + border_class) %}
<div class="mb-3">
  <a href="{{ url_for('admin.list_users') }}" class="text-secondary text-decoration-none">&larr; {{ _('admin.authentication_methods.back_to_admin') }}</a>
</div>

<div class="row g-4">
  <div class="col-lg-5 col-xl-4">
    <div class="{{ card_surface }}">
      <div class="card-header {{ border_class }}">
        <h1 class="h5 mb-0">{{ _('admin.authentication_methods.create.title') }}</h1>
      </div>
      <div class="card-body">
        <form method="post" action="{{ url_for('admin.list_authentication_methods') }}" class="vstack gap-3">
          {{ create_form.hidden_tag() }}
          <div>
            {{ create_form.slug.label(_('admin.authentication_methods.create.fields.slug'), class_='form-label') }}
            {{ create_form.slug(class_='form-control') }}
          </div>
          <div class="text-secondary small">
            {{ _('admin.authentication_methods.create.translation_hint') }}
          </div>
          <div class="text-end">
            {{ create_form.submit(class_='btn btn-primary', value=_('admin.authentication_methods.create.submit')) }}
          </div>
        </form>
      </div>
    </div>
  </div>
  <div class="col-lg-7 col-xl-8">
    <div class="{{ card_surface }}">
      <div class="card-header {{ border_class }} d-flex justify-content-between align-items-center">
        <div>
          <h2 class="h5 mb-0">{{ _('admin.authentication_methods.list.title') }}</h2>
          <p class="text-secondary mb-0">{{ _('admin.authentication_methods.list.subtitle') }}</p>
        </div>
      </div>
      <div class="card-body p-0">
        {% if methods %}
        <div class="table-responsive">
          <table class="table table-dark table-striped align-middle mb-0">
            <thead>
              <tr>
                <th scope="col">{{ _('admin.authentication_methods.list.columns.slug') }}</th>
                {% for locale in display_locales %}
                <th scope="col">{{ _('admin.authentication_methods.list.columns.label_locale', locale_name=locale_names[locale]) }}</th>
                {% endfor %}
                <th scope="col">{{ _('admin.authentication_methods.list.columns.status') }}</th>
                <th scope="col">{{ _('admin.authentication_methods.list.columns.usage') }}</th>
                <th scope="col" class="text-end">{{ _('admin.authentication_methods.list.columns.actions') }}</th>
              </tr>
            </thead>
            <tbody>
              {% for method in methods %}
              <tr>
                <td><span class="badge text-bg-secondary">{{ method.slug }}</span></td>
                {% set labels = method_labels.get(method.id, {}) %}
                {% for locale in display_locales %}
                {% set value = labels.get(locale) %}
                <td>
                  {% if value %}
                    {{ value }}
                  {% else %}
                    <span class="text-secondary small">{{ _('admin.authentication_methods.list.missing_label') }}</span>
                  {% endif %}
                </td>
                {% endfor %}
                <td>
                  {% if method.is_active %}
                  <span class="badge text-bg-success">{{ _('admin.authentication_methods.state.active') }}</span>
                  {% else %}
                  <span class="badge text-bg-secondary">{{ _('admin.authentication_methods.state.inactive') }}</span>
                  {% endif %}
                </td>
                <td>
                  {% set usage = component_usage.get(method.id, 0) %}
                  {% if usage %}
                    <span class="badge text-bg-warning text-dark">{{ _('admin.authentication_methods.list.in_use', count=usage) }}</span>
                  {% else %}
                    <span class="badge text-bg-success">{{ _('admin.authentication_methods.list.not_in_use') }}</span>
                  {% endif %}
                </td>
                <td class="text-end">
                  <div class="d-inline-flex flex-wrap gap-2 justify-content-end">
                    <button class="btn btn-outline-light btn-sm" type="button" data-modal-target="edit-method-{{ method.id }}">
                      {{ _('admin.authentication_methods.list.actions.edit') }}
                    </button>
                    <form method="post" action="{{ url_for('admin.toggle_authentication_method', method_id=method.id) }}">
                      {{ toggle_forms[method.id].hidden_tag() }}
                      {{ toggle_forms[method.id].submit(class_='btn btn-outline-secondary btn-sm') }}
                    </form>
                    <form method="post" action="{{ url_for('admin.delete_authentication_method', method_id=method.id) }}" data-confirm-message="{{ _('admin.authentication_methods.list.actions.delete_confirm') }}" onsubmit="return confirm(this.dataset.confirmMessage);">
                      {{ delete_forms[method.id].hidden_tag() }}
                      {{ delete_forms[method.id].submit(class_='btn btn-outline-danger btn-sm') }}
                    </form>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% for method in methods %}
        <div class="modal" id="edit-method-{{ method.id }}" tabindex="-1" aria-labelledby="edit-method-label-{{ method.id }}" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content {{ 'bg-dark border-secondary' if is_dark else '' }}">
              <div class="modal-header {{ border_class }}">
                <h3 class="modal-title h5" id="edit-method-label-{{ method.id }}">{{ _('admin.authentication_methods.edit.title', name=method_display_names[method.id]) }}</h3>
                <button type="button" class="btn-close{% if is_dark %} btn-close-white{% endif %}" data-modal-close aria-label="{{ _('actions.close') }}"></button>
              </div>
              <div class="modal-body">
                <form method="post" action="{{ url_for('admin.update_authentication_method', method_id=method.id) }}" class="vstack gap-3">
                  {{ edit_forms[method.id].hidden_tag() }}
                  <div>
                    {{ edit_forms[method.id].slug.label(_('admin.authentication_methods.create.fields.slug'), class_='form-label') }}
                    {{ edit_forms[method.id].slug(class_='form-control') }}
                  </div>
                  <div class="small text-secondary">
                    {{ _('admin.authentication_methods.edit.translation_hint') }}
                  </div>
                  {% set translation_panel_class = 'border rounded p-3 ' + ('bg-dark border-secondary text-light' if is_dark else 'bg-body-secondary border-secondary-subtle text-body') %}
                  <div class="{{ translation_panel_class }}">
                    <dl class="row mb-0">
                      {% for locale in display_locales %}
                      {% set value = method_labels[method.id].get(locale) %}
                      <dt class="col-4 fw-normal">{{ locale_names[locale] }}</dt>
                      <dd class="col-8 mb-0">{{ value or _('admin.authentication_methods.list.missing_label') }}</dd>
                      {% endfor %}
                    </dl>
                  </div>
                  <div class="text-end">
                    {{ edit_forms[method.id].submit(class_='btn btn-primary', value=_('admin.authentication_methods.edit.submit')) }}
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
        {% else %}
          <div class="p-4 text-secondary">{{ _('admin.authentication_methods.list.empty') }}</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}
