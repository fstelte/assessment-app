{% extends "base.html" %}
{% block title %}{{ _('admin.controls.page.title') }}{% endblock %}
{% block content %}
<div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-3 mb-4">
  <div>
    <h1 class="h3 mb-1">{{ _('admin.controls.page.heading') }}</h1>
    <p class="text-secondary mb-0">{{ _('admin.controls.page.subtitle') }}</p>
  </div>
  <span class="badge bg-secondary text-uppercase">{{ _('admin.controls.page.role_hint') }}</span>
</div>

<div class="d-flex flex-column flex-lg-row gap-3 mb-4">
  <div class="flex-fill">
    <div class="card border-0 text-white h-100 shadow" style="background: linear-gradient(135deg, #3559f7, #8c4dff); min-height: 100%;">
      <div class="card-body d-flex flex-column">
        <p class="text-uppercase small text-white-50 mb-1">{{ _('admin.controls.page.stats.total') }}</p>
        <div class="d-flex align-items-baseline gap-2">
          <span class="display-6 fw-bold">{{ control_stats.total }}</span>
          <span class="text-white-50 small">{{ _('admin.controls.list.title') }}</span>
        </div>
        <p class="mb-0 small text-white-75 mt-2">{{ _('admin.controls.page.stats.total_help') }}</p>
      </div>
    </div>
  </div>
  <div class="flex-fill">
    <div class="card border-0 h-100 shadow" style="background: linear-gradient(135deg, #0f172a, #1f2937); min-height: 100%;">
      <div class="card-body d-flex flex-column text-light">
        <p class="text-uppercase small text-secondary mb-1">{{ _('admin.controls.page.stats.templates') }}</p>
        <div class="d-flex align-items-baseline gap-2">
          <span class="display-6 fw-bold">{{ control_stats.templates }}</span>
          <span class="text-secondary small">{{ _('admin.controls.list.templates') }}</span>
        </div>
        <p class="mb-0 small text-secondary mt-2">{{ _('admin.controls.page.stats.templates_help') }}</p>
      </div>
    </div>
  </div>
  <div class="flex-fill">
    <div class="card border-0 h-100 shadow" style="background: linear-gradient(135deg, #0f766e, #0d9488); min-height: 100%;">
      <div class="card-body d-flex flex-column text-white">
        <p class="text-uppercase small text-white-50 mb-1">{{ _('admin.controls.page.stats.described') }}</p>
        <div class="d-flex align-items-baseline gap-2">
          <span class="display-6 fw-bold">{{ control_stats.described }}</span>
          <span class="text-white-50 small">{{ control_stats.described_pct }}%</span>
        </div>
        <p class="mb-0 small text-white-75 mt-2">{{ _('admin.controls.page.stats.described_help', pct=control_stats.described_pct) }}</p>
      </div>
    </div>
  </div>
</div>

<div class="row g-4 align-items-stretch mb-4">
  <div class="col-12 col-xl-6">
      <div class="card bg-dark border-secondary h-100">
        <div class="card-body">
          <h1 class="h4 mb-2">{{ _('admin.controls.manual.title') }}</h1>
          <p class="text-secondary mb-4">{{ _('admin.controls.manual.intro') }}</p>
          <form method="post" action="{{ url_for('admin.create_control') }}" novalidate>
            {{ create_form.hidden_tag() }}
            {% from "partials/forms.html" import render_field_with_help %}
            <div class="mb-3">
              {{ render_field_with_help(create_form.code, class="form-control") }}
            </div>
            <div class="mb-3">
              {{ render_field_with_help(create_form.name, class="form-control") }}
            </div>
            <div class="mb-3">
              {{ render_field_with_help(create_form.description, class="form-control") }}
            </div>
            <div class="text-end">
              {{ create_form.submit(class="btn btn-primary") }}
            </div>
          </form>
        </div>
      </div>
    </div>
    <div class="col-12">
      <div class="card bg-dark border-secondary h-100">
        <div class="card-header border-secondary d-flex justify-content-between align-items-center">
          <span>{{ _('admin.controls.list.title') }}</span>
          <span class="badge bg-secondary">{{ controls|length }}</span>
        </div>
        <div class="card-body p-0">
          {% if controls %}
            <div class="table-responsive">
              <table class="table table-dark table-striped align-middle mb-0">
                <thead>
                  <tr>
                    <th scope="col">{{ _('admin.controls.list.code') }}</th>
                    <th scope="col">{{ _('admin.controls.list.name') }}</th>
                    <th scope="col">{{ _('admin.controls.list.description') }}</th>
                    <th scope="col" class="text-center">{{ _('admin.controls.list.templates') }}</th>
                    <th scope="col" class="text-end">{{ _('admin.controls.list.actions') }}</th>
                  </tr>
                </thead>
                <tbody>
                  {% for control in controls %}
                    {% set delete_form = delete_forms.get(control.id) %}
                    <tr>
                      <td class="text-nowrap">{{ control.section or _('csa.common.unknown') }}</td>
                      <td><strong>{{ control.domain }}</strong></td>
                      <td class="text-secondary small">{{ control.description or _('admin.controls.list.no_description') }}</td>
                      <td class="text-center"><span class="badge bg-secondary">{{ control.templates|length }}</span></td>
                      <td class="text-end">
                        <div class="d-flex flex-wrap gap-2 justify-content-end">
                          <a class="btn btn-sm btn-outline-light" href="{{ url_for('admin.edit_control', control_id=control.id) }}">
                            {{ _('actions.edit') }}
                          </a>
                          {% if delete_form %}
                          <form method="post" action="{{ url_for('admin.delete_control', control_id=control.id) }}" class="d-inline">
                            {{ delete_form.hidden_tag() }}
                            {{ delete_form.control_id() }}
                            {{ delete_form.submit(class="btn btn-sm btn-outline-danger") }}
                          </form>
                          {% endif %}
                        </div>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="p-4 text-secondary">{{ _('admin.controls.list.empty') }}</div>
          {% endif %}
        </div>
      </div>
    </div>

  </div>
{% endblock %}
