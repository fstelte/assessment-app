{% extends "base.html" %}
{% from "partials/forms.html" import render_field_with_tooltip, render_field_with_help %}
{% block extra_css %}
  {{ super() }}
  {% include "bia/_badge_styles.html" %}
  <style nonce="{{ csp_nonce }}">
    .bia-toolbar {
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.08);
    }
    .btn-icon {
      padding: 0.35rem 0.6rem;
      font-size: 0.8rem;
      line-height: 1;
      border-radius: 0.4rem;
    }
    .table-components th {
      text-transform: uppercase;
      font-size: 0.75rem;
      letter-spacing: 0.05em;
    }
    .table-components td {
      vertical-align: middle;
    }
    .table-components td:first-child,
    .table-components th:first-child {
      min-width: 18rem;
    }
    body.page-bia-components main.container {
      max-width: 100%;
      width: 100%;
      padding-left: 1.5rem;
      padding-right: 1.5rem;
    }
    .bia-pagination-footer {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      align-items: center;
      justify-content: center;
    }
    .bia-pagination-footer small {
      text-align: center;
    }
    .bia-pagination-footer nav {
      width: 100%;
      display: flex;
      justify-content: center;
    }
    .bia-pagination-footer .pagination {
      display: inline-flex;
      flex-wrap: nowrap;
      gap: 0.25rem;
      justify-content: center;
    }
    .bia-pagination-footer .page-item {
      display: inline-flex;
    }
    @media (max-width: 767px) {
      .btn-icon {
        width: 100%;
      }
    }
    @media (min-width: 768px) {
      .bia-pagination-footer {
        flex-direction: row;
      }
      .bia-pagination-footer small {
        text-align: left;
      }
      .bia-pagination-footer nav {
        width: auto;
      }
    }
  </style>
{% endblock %}
{% block title %}{{ _('bia.components.page_title') }}{% endblock %}
{% block content %}
<div class="mb-3">
  <a href="{{ url_for('bia.dashboard') }}" class="text-secondary text-decoration-none">&larr; {{ _('bia.components.back') }}</a>
</div>

<div class="d-flex flex-column flex-md-row justify-content-between align-items-start gap-3 mb-4">
  <div>
    <h1 class="mb-1">{{ _('bia.components.heading') }}</h1>
    <p class="text-secondary mb-0">{{ _('Showing %(start)d-%(end)d of %(total)d components', start=page_start, end=page_end, total=pagination.total) }}</p>
  </div>
  <div class="d-flex flex-wrap gap-2">
    <button class="btn btn-primary" type="button" data-collapse-target="add-component-panel" aria-expanded="true" aria-controls="add-component-panel">
      {{ _('bia.components.add.title') }}
    </button>
    <a href="{{ url_for('bia.export_data_inventory') }}" class="btn btn-outline-light">{{ _('Export inventory') }}</a>
  </div>
</div>

<div class="card bg-dark border-secondary mb-4 bia-toolbar" data-toolbar>
  <div class="card-body">
    <form class="row g-3 align-items-end" method="get" action="{{ url_for('bia.view_components') }}">
      <input type="hidden" name="page" value="1">
      <div class="col-md-4">
        <label for="scope-filter" class="form-label text-uppercase small">{{ _('Scope') }}</label>
        <select class="form-select" id="scope-filter" name="scope">
          <option value="all" {% if selected_scope|lower == 'all' %}selected{% endif %}>{{ _('bia.components.filters.all') }}</option>
          {% for context in contexts %}
            <option value="{{ context.name }}" {% if context.name == selected_scope %}selected{% endif %}>{{ context.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-4">
        <label for="component-query" class="form-label text-uppercase small">{{ _('Search components') }}</label>
        <input type="search" id="component-query" name="q" value="{{ search_term }}" class="form-control" placeholder="{{ _('Filter by name...') }}">
      </div>
      <div class="col-md-4 d-flex gap-2 justify-content-md-end">
        <button type="submit" class="btn btn-primary flex-grow-1 flex-md-grow-0">{{ _('Apply filters') }}</button>
        {% if search_term or selected_scope|lower != 'all' %}
          <a href="{{ url_for('bia.view_components') }}" class="btn btn-outline-secondary flex-grow-1 flex-md-grow-0">{{ _('Reset') }}</a>
        {% endif %}
      </div>
    </form>
  </div>
</div>

<div id="add-component-panel" class="collapse show mb-4">
  <div class="card bg-dark border-secondary">
    <div class="card-header border-secondary d-flex justify-content-between align-items-center">
      <span>{{ _('bia.components.add.title') }}</span>
      <small class="text-secondary">Capture ownership, environments, and authentication details for a new component.</small>
    </div>
    <div class="card-body">
      <form id="add-component-form" action="{{ url_for('bia.add_component') }}" method="post" class="row g-3 align-items-end">
      {{ component_form.hidden_tag() }}
      <div class="col-md-4 tooltip-wrapper" data-tooltip="{{ _('bia.components.tooltips.scope') }}">
        <label for="bia-id" class="form-label tooltip-trigger">{{ _('bia.components.add.bia_label') }}</label>
        <span id="bia-id-tooltip" class="visually-hidden">{{ _('bia.components.tooltips.scope') }}</span>
        <select id="bia-id" name="bia_id" class="form-select" required aria-describedby="bia-id-tooltip">
          <option value="" disabled selected>{{ _('bia.components.add.bia_placeholder') }}</option>
          {% for context in contexts %}
            <option value="{{ context.id }}">{{ context.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-4">
        {{ render_field_with_help(component_form.name, class='form-control') }}
      </div>
      <div class="col-md-4">
        {{ render_field_with_help(component_form.info_owner, class='form-control') }}
      </div>
      <div class="col-md-4">
        {{ render_field_with_help(component_form.info_type, class='form-control') }}
      </div>
      <div class="col-md-4">
        {{ render_field_with_help(component_form.user_type, class='form-control') }}
      </div>
      <div class="col-md-4">
        {{ render_field_with_help(component_form.dependencies_it_systems_applications, class='form-control') }}
      </div>
      <div class="col-md-4">
        {{ render_field_with_help(component_form.dependencies_equipment, class='form-control') }}
      </div>
      <div class="col-md-4">
        {{ render_field_with_help(component_form.dependencies_suppliers, class='form-control') }}
      </div>
      <div class="col-md-4">
        {{ render_field_with_help(component_form.dependencies_people, class='form-control') }}
      </div>
      <div class="col-md-4">
        {{ render_field_with_help(component_form.dependencies_facilities, class='form-control') }}
      </div>
      <div class="col-md-4">
        {{ render_field_with_help(component_form.dependencies_others, class='form-control') }}
      </div>
      <div class="col-12">
        <fieldset class="border rounded p-3">
          <legend class="float-none w-auto px-2 h6 mb-0">{{ _('bia.components.environments.section_title') }}</legend>
          <p class="text-secondary small mb-3">{{ _('bia.components.environments.section_help') }}</p>
          <div class="table-responsive">
            <table class="table table-sm table-dark align-middle mb-0">
              <thead>
                <tr>
                  <th scope="col">{{ _('bia.components.environments.columns.environment') }}</th>
                  <th scope="col">{{ _('bia.components.environments.columns.used') }}</th>
                  <th scope="col">{{ _('bia.components.environments.columns.authentication') }}</th>
                </tr>
              </thead>
              <tbody>
                {% for environment_field in component_form.environments %}
                  {% set environment_form = environment_field.form %}
                  <tr>
                    <td class="text-nowrap">
                      {{ environment_form.environment_type() }}
                      {{ bia_environment_label(environment_form.environment_type.data) }}
                    </td>
                    <td>
                      {% set checkbox_id = 'environment-enabled-add-' ~ loop.index0 %}
                      <div class="form-check">
                        {{ environment_form.is_enabled(class="form-check-input", id=checkbox_id) }}
                        <label class="form-check-label" for="{{ checkbox_id }}">{{ _('bia.components.environments.toggle_label') }}</label>
                      </div>
                    </td>
                    <td>
                      {% set select_id = 'environment-auth-add-' ~ loop.index0 %}
                      {{ environment_form.authentication_method(class="form-select", id=select_id) }}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </fieldset>
      </div>
      <div class="col-12">
        {{ render_field_with_help(component_form.description, class='form-control', rows=2) }}
      </div>
        <div class="col-12 text-end">
          <button type="submit" class="btn btn-primary">{{ _('bia.components.add.submit') }}</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="card bg-dark border-secondary" id="consequences">
  <div class="card-header border-secondary d-flex justify-content-between align-items-center">
    <span>{{ _('bia.components.table.title') }}</span>
    <span class="text-secondary small">{{ _('Updated %(count)d records', count=pagination.total) }}</span>
  </div>
  <div class="card-body p-0">
    {% if components %}
    <div class="table-responsive">
      <table class="table table-dark table-striped align-middle mb-0 table-components">
        <thead>
          <tr>
            <th scope="col">{{ _('Component') }}</th>
            <th scope="col">{{ _('Context') }}</th>
            <th scope="col">{{ _('Owner / Users') }}</th>
            <th scope="col">{{ _('Environments') }}</th>
            <th scope="col">{{ _('Availability') }}</th>
            <th scope="col">{{ _('Consequences') }}</th>
            <th scope="col">{{ _('Intelligence') }}</th>
            <th scope="col" class="text-end">{{ _('Actions') }}</th>
          </tr>
        </thead>
        <tbody>
          {% for component in components %}
          {% set availability = component.availability_requirement %}
          {% set ai_record = component.ai_identificaties[-1] if component.ai_identificaties else None %}
          {% set dpia_count = component.dpia_assessments | length %}
          <tr>
            <td>
              <div class="fw-semibold">{{ component.name }}</div>
              {% if component.info_type %}
                <div class="text-secondary small">{{ component.info_type }}</div>
              {% endif %}
            </td>
            <td>
              {% if component.context_scope %}
                <span class="badge bg-secondary component-badge">{{ component.context_scope.name }}</span>
              {% else %}
                <span class="text-secondary">{{ _('bia.components.table.not_linked') }}</span>
              {% endif %}
            </td>
            <td>
              <div>{{ component.info_owner or _('bia.components.table.not_set') }}</div>
              <div class="text-secondary small">{{ component.user_type or _('bia.components.table.not_set') }}</div>
            </td>
            <td>
              <div class="d-flex flex-wrap gap-1">
                {% for environment_type in bia_environment_types %}
                  {% set env_assignment = bia_component_environment(component, environment_type) %}
                  {% set environment_label = bia_environment_label(environment_type) %}
                  {% if env_assignment and env_assignment.is_enabled %}
                    {% set env_auth = bia_environment_authentication(env_assignment) %}
                    <span class="env-badge env-badge-enabled">
                      {{ environment_label }} · {{ env_auth or _('bia.components.environments.badge_no_auth') }}
                    </span>
                  {% else %}
                    <span class="env-badge env-badge-disabled">
                      {{ environment_label }} · {{ _('bia.components.environments.badge_not_used') }}
                    </span>
                  {% endif %}
                {% endfor %}
              </div>
            </td>
            <td>
              {% set metrics = [('MTD', availability.mtd if availability else None), ('RTO', availability.rto if availability else None), ('RPO', availability.rpo if availability else None), ('MAMSL', availability.masl if availability else None)] %}
              <div class="d-flex flex-wrap gap-1">
                {% for label, value in metrics %}
                  <span class="badge availability-badge">
                    <strong>{{ label }}</strong>
                    <span class="ms-1">{{ value or '—' }}</span>
                  </span>
                {% endfor %}
              </div>
            </td>
            <td>
              <a href="{{ url_for('bia.view_consequences', component_id=component.id) }}" class="badge bg-info text-dark text-decoration-none">
                {{ component.consequences | length }} {{ _('records') }}
              </a>
            </td>
            <td>
              <div class="d-flex flex-column gap-2">
                <div class="d-flex align-items-center gap-2">
                  {% if ai_record %}
                    {% set ai_label = ai_record.category or _('No AI profile') %}
                    <span class="bia-ai-badge" data-ai="{{ ai_label | lower }}">{{ ai_label }}</span>
                  {% else %}
                    <span class="bia-ai-badge text-secondary small" data-ai="no ai">{{ _('No AI profile') }}</span>
                  {% endif %}
                  <button class="btn btn-outline-light btn-icon" type="button" data-ai-manage data-component-id="{{ component.id }}" title="{{ _('Manage AI classification') }}" aria-label="{{ _('Manage AI classification') }}">AI</button>
                </div>
                {% if dpia_enabled %}
                  {% if dpia_count %}
                    <span class="badge bg-success text-dark">{{ _('DPIA active: %(count)d', count=dpia_count) }}</span>
                  {% else %}
                    <span class="badge bg-secondary">{{ _('DPIA pending') }}</span>
                  {% endif %}
                {% else %}
                  <span class="text-secondary small">{{ _('bia.components.dpia.unavailable') }}</span>
                {% endif %}
              </div>
            </td>
            <td class="text-end">
              <div class="d-flex flex-wrap gap-2 justify-content-end">
                <a href="{{ url_for('bia.edit_component_form', component_id=component.id) }}" class="btn btn-outline-light btn-icon" title="{{ _('Edit component') }}" aria-label="{{ _('Edit component') }}">{{ _('Edit') }}</a>
                <a href="{{ url_for('bia.manage_component_availability', component_id=component.id, return_to=current_view_url) }}" class="btn btn-outline-primary btn-icon" title="{{ _('Availability requirements') }}" aria-label="{{ _('Availability requirements') }}">{{ _('Avail') }}</a>
                <a href="{{ url_for('bia.add_component_consequence_view', component_id=component.id, return_to=current_view_url) }}" class="btn btn-outline-secondary btn-icon" title="{{ _('Add consequences') }}" aria-label="{{ _('Add consequences') }}">{{ _('Cons') }}</a>
                {% if dpia_enabled %}
                  {% if dpia_count %}
                    <a href="{{ url_for('dpia.dashboard') }}" class="btn btn-outline-light btn-icon" data-dpia-action="view" title="{{ _('View DPIA assessments') }}" aria-label="{{ _('View DPIA assessments') }}">{{ _('DPIA') }}</a>
                  {% else %}
                    <a href="{{ url_for('dpia.start_from_component', component_id=component.id) }}" class="btn btn-outline-light btn-icon" data-dpia-action="start" title="{{ _('Start DPIA') }}" aria-label="{{ _('Start DPIA') }}">{{ _('DPIA') }}</a>
                  {% endif %}
                {% endif %}
                <button class="btn btn-outline-danger btn-icon" type="button" data-delete-url="{{ url_for('bia.delete_component', component_id=component.id) }}" title="{{ _('Delete component') }}" aria-label="{{ _('Delete component') }}">{{ _('Delete') }}</button>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div class="bia-pagination-footer px-3 py-2 border-top border-secondary">
      <small class="text-secondary mb-0">
        {% if pagination.pages > 1 %}
          {{ _('bia.components.table.pagination_with_pages', start=page_start, end=page_end, total=pagination.total, page=pagination.page, pages=pagination.pages) }}
        {% else %}
          {{ _('bia.components.table.pagination', start=page_start, end=page_end, total=pagination.total) }}
        {% endif %}
      </small>
      {% if pagination.pages > 1 %}
      <nav aria-label="Component pagination">
        <ul class="pagination pagination-sm mb-0">
          <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('bia.view_components', page=pagination.prev_num, scope=selected_scope) }}" aria-label="Previous" tabindex="-1">&laquo;</a>
          </li>
          {% for p in pagination.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
            {% if p %}
              <li class="page-item {% if p == pagination.page %}active{% endif %}">
                <a class="page-link" href="{{ url_for('bia.view_components', page=p, scope=selected_scope) }}">{{ p }}</a>
              </li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">&hellip;</span></li>
            {% endif %}
          {% endfor %}
          <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('bia.view_components', page=pagination.next_num, scope=selected_scope) }}" aria-label="Next">&raquo;</a>
          </li>
        </ul>
      </nav>
      {% endif %}
    </div>
    {% else %}
      <div class="p-4 text-secondary">{{ _('bia.components.table.empty') }}</div>
    {% endif %}
  </div>
  </div>

{% include "bia/_component_action_modals.html" %}
<script nonce="{{ csp_nonce }}">
if (document?.body) {
  document.body.classList.add('page-bia-components');
}
</script>
{% endblock %}
