{% extends "base.html" %}
{% block title %}{{ _('bia.dashboard.title') }}{% endblock %}
{% block extra_css %}
<style nonce="{{ csp_nonce }}">
.bia-dashboard {
	display: flex;
	flex-direction: column;
	gap: 2rem;
}
.bia-dashboard-hero {
	background: linear-gradient(130deg, rgba(13, 110, 253, 0.95), rgba(111, 66, 193, 0.95));
	border-radius: 1.5rem;
	padding: clamp(1.75rem, 4vw, 2.5rem);
	box-shadow: 0 1.25rem 3rem rgba(15, 23, 42, 0.25);
	color: #fff;
	position: relative;
	overflow: hidden;
}
body[data-theme="dark"] .bia-dashboard-hero {
	background: linear-gradient(130deg, rgba(13, 110, 253, 0.6), rgba(111, 66, 193, 0.7));
	box-shadow: 0 1rem 2.5rem rgba(0, 0, 0, 0.45);
	border: 1px solid rgba(255, 255, 255, 0.08);
}
.bia-dashboard-hero::after {
	content: "";
	position: absolute;
	width: 320px;
	height: 320px;
	background: radial-gradient(circle, rgba(255, 255, 255, 0.2), transparent 65%);
	right: -80px;
	top: -60px;
	filter: blur(4px);
}
.bia-dashboard-hero__body {
	position: relative;
	z-index: 1;
}
.bia-dashboard-hero__metrics {
	display: grid;
	grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
	gap: 1.25rem;
	margin-top: 1.5rem;
}
.bia-dashboard-hero__metric {
	background: rgba(255, 255, 255, 0.08);
	border-radius: 1rem;
	padding: 1rem 1.25rem;
	backdrop-filter: blur(6px);
}
.bia-dashboard-hero__metric strong {
	font-size: clamp(1.5rem, 4vw, 2.5rem);
	line-height: 1;
}
.bia-dashboard-hero__metric small {
	color: rgba(255, 255, 255, 0.8);
}
.bia-quick-card {
	border: none;
	border-radius: 1.25rem;
	background: var(--bs-body-bg);
	box-shadow: 0 0.5rem 1.5rem rgba(15, 23, 42, 0.08);
	padding: 1.5rem;
	height: 100%;
}
body[data-theme="dark"] .bia-quick-card {
	background: rgba(18, 18, 18, 0.8);
	border: 1px solid rgba(255, 255, 255, 0.08);
	box-shadow: 0 0.5rem 1.5rem rgba(0, 0, 0, 0.65);
}
.bia-quick-card h2 {
	font-size: 0.75rem;
	letter-spacing: 0.1em;
	text-transform: uppercase;
	color: var(--bs-secondary-color);
	margin-bottom: 1rem;
}
.bia-quick-nav .nav-link {
	border-radius: 0.75rem;
	padding: 0.65rem 0.75rem;
	font-weight: 500;
	color: inherit;
	transition: background 0.2s ease, transform 0.2s ease;
}
.bia-quick-nav .nav-link:hover {
	background: rgba(13, 110, 253, 0.08);
	transform: translateX(4px);
}
.bia-dashboard-actions {
	display: grid;
	gap: 1.5rem;
}
@media (min-width: 768px) {
	.bia-dashboard-actions {
		grid-template-columns: repeat(3, minmax(0, 1fr));
	}
}
.bia-dashboard-actions__item {
	display: flex;
}
.bia-dashboard-actions__item .bia-quick-card {
	width: 100%;
}
.bia-dashboard-actions .btn {
	border-radius: 999px;
}
.bia-dashboard-actions .btn.btn-sm {
	padding-inline: 1.25rem;
	font-weight: 500;
}
.bia-context-grid article {
	height: 100%;
}
.bia-context-card {
	border-radius: 1.25rem;
	border: 1px solid var(--bs-border-color-translucent);
	background: var(--bs-body-bg);
	box-shadow: 0 1rem 2rem rgba(15, 23, 42, 0.12);
	padding: 1.5rem;
	display: flex;
	flex-direction: column;
	gap: 1.25rem;
	transition: transform 0.2s ease, box-shadow 0.2s ease;
}
body[data-theme="dark"] .bia-context-card {
	background: rgba(23, 23, 23, 0.9);
	border-color: rgba(255, 255, 255, 0.06);
	box-shadow: 0 1rem 2.5rem rgba(0, 0, 0, 0.55);
}
.bia-context-card:hover {
	transform: translateY(-4px);
	box-shadow: 0 1.5rem 3rem rgba(15, 23, 42, 0.16);
}
.bia-context-card__owner form {
	max-width: 360px;
}
.bia-chip {
	display: inline-flex;
	align-items: center;
	gap: 0.35rem;
	padding: 0.2rem 0.9rem;
	border-radius: 999px;
	font-size: 0.75rem;
	font-weight: 600;
	background: rgba(13, 110, 253, 0.1);
	color: var(--bs-primary);
}
body[data-theme="dark"] .bia-chip {
	color: #9cc1ff;
	background: rgba(13, 110, 253, 0.18);
}
.bia-chip--muted {
	background: rgba(108, 117, 125, 0.15);
	color: var(--bs-secondary-color);
}
.bia-dashboard-empty {
	border-radius: 1rem;
	padding: 2rem;
	background: rgba(13, 110, 253, 0.05);
	border: 1px dashed rgba(13, 110, 253, 0.4);
}
</style>
{% endblock %}
{% block content %}
{% set is_dark = theme != 'light' %}
{% set nav_link_color = 'text-slate-100' if is_dark else 'text-slate-900' %}
{% set outline_inverse = 'border-slate-200 text-slate-100 hover:bg-slate-800' if is_dark else 'border-slate-300 text-slate-700 hover:bg-slate-50' %}
{% set badge_muted = 'bg-slate-100 text-slate-800 dark:bg-slate-700 dark:text-slate-300' %}
{% set context_list = contexts or [] %}
{% set contexts_count = context_list | length %}
{% set assigned_contexts = context_list | selectattr('author') | list %}
{% set assigned_count = assigned_contexts | length %}
{% set stats = namespace(components=0, most_recent=None) %}
{% for ctx in context_list %}
	{% set stats.components = stats.components + (ctx.components | length) %}
	{% if ctx.last_update %}
		{% if stats.most_recent is none or ctx.last_update > stats.most_recent %}
			{% set stats.most_recent = ctx.last_update %}
		{% endif %}
	{% endif %}
{% endfor %}
{% set last_updated_display = stats.most_recent or _('bia.dashboard.card.never') %}

<div class="bia-dashboard">
	<section class="bia-dashboard-hero">
		<div class="bia-dashboard-hero__body flex flex-col lg:flex-row items-start lg:items-center gap-4">
			<div class="grow">
				<p class="uppercase text-sm text-white/50 mb-2">{{ _('bia.dashboard.header.subtitle') }}</p>
				<h1 class="text-4xl font-bold mb-3">{{ _('bia.dashboard.header.title') }}</h1>
				<div class="flex flex-wrap gap-2">
					<span class="bia-chip bia-chip--muted">{{ _('bia.dashboard.sidebar.navigate') }}</span>
					<span class="bia-chip bia-chip--muted">{{ _('bia.dashboard.sidebar.manage') }}</span>
					<span class="bia-chip bia-chip--muted">{{ _('bia.dashboard.sidebar.exports') }}</span>
				</div>
			</div>
		</div>
		<div class="bia-dashboard-hero__metrics">
			<div class="bia-dashboard-hero__metric">
				<p class="uppercase text-sm text-white/50 mb-1">{{ _('bia.dashboard.sidebar.overview') }}</p>
				<strong>{{ contexts_count }}</strong>
				<small>{{ _('bia.dashboard.header.subtitle') }}</small>
			</div>
			<div class="bia-dashboard-hero__metric">
				<p class="uppercase text-sm text-white/50 mb-1">{{ _('bia.dashboard.sidebar.components') }}</p>
				<strong>{{ stats.components }}</strong>
				<small>{{ _('bia.dashboard.card.components', count=stats.components) }}</small>
			</div>
			<div class="bia-dashboard-hero__metric">
				<p class="uppercase text-sm text-white/50 mb-1">{{ _('bia.dashboard.card.risk_owner') }}</p>
				<strong>{{ assigned_count }}</strong>
				<small>{{ _('bia.dashboard.card.last_updated', date=last_updated_display) }}</small>
			</div>
		</div>
	</section>

	<section class="bia-dashboard-actions">
		<div class="bia-dashboard-actions__item">
			<div class="bia-quick-card h-full">
				<h2>{{ _('bia.dashboard.sidebar.navigate') }}</h2>
				<ul class="flex flex-col gap-2 bia-quick-nav">
					<li class="nav-item">
						<a class="text-sm font-medium text-[var(--color-muted)] hover:text-[var(--color-text)] px-2 py-1 rounded-md transition-colors {{ nav_link_color }} flex items-center" href="{{ url_for('bia.dashboard') }}">
							<i class="fas fa-chart-line mr-2 text-primary-400"></i>
							{{ _('bia.dashboard.sidebar.overview') }}
						</a>
					</li>
					<li class="nav-item">
						<a class="text-sm font-medium text-[var(--color-muted)] hover:text-[var(--color-text)] px-2 py-1 rounded-md transition-colors {{ nav_link_color }} flex items-center" href="{{ url_for('bia.view_components') }}">
							<i class="fas fa-layer-group mr-2 text-primary-400"></i>
							{{ _('bia.dashboard.sidebar.components') }}
						</a>
					</li>
				</ul>
			</div>
		</div>
		<div class="bia-dashboard-actions__item">
			<div class="bia-quick-card h-full flex flex-col gap-3">
				<h2>{{ _('bia.dashboard.sidebar.manage') }}</h2>
				<div class="flex flex-wrap gap-2">
					<a href="{{ url_for('bia.new_item') }}" class="inline-flex items-center justify-center font-medium rounded-md px-4 py-2 text-sm transition-colors border border-transparent bg-primary-600 text-white hover:bg-primary-700 px-2.5 py-1 text-xs">{{ _('bia.dashboard.sidebar.new_bia') }}</a>
					<a href="{{ url_for('bia.import_csv_view') }}" class="inline-flex items-center justify-center font-medium rounded-md px-4 py-2 text-sm transition-colors border border-transparent {{ outline_inverse }} px-2.5 py-1 text-xs">{{ _('bia.dashboard.sidebar.import_csv') }}</a>
					<a href="{{ url_for('bia.import_sql_form') }}" class="inline-flex items-center justify-center font-medium rounded-md px-4 py-2 text-sm transition-colors border border-transparent border-[var(--color-border)] text-[var(--color-muted)] hover:bg-slate-500/10 px-2.5 py-1 text-xs">{{ _('bia.dashboard.sidebar.import_sql') }}</a>
					<a href="{{ url_for('bia.archived_list') }}" class="inline-flex items-center justify-center font-medium rounded-md px-4 py-2 text-sm transition-colors border border-transparent border-[var(--color-border)] text-[var(--color-muted)] hover:bg-slate-500/10 px-2.5 py-1 text-xs">{{ _('bia.dashboard.sidebar.archived') }}</a>
				</div>
				<div class="text-sm text-[var(--color-muted)]">
					{{ _('bia.dashboard.header.subtitle') }}
				</div>
			</div>
		</div>
		<div class="bia-dashboard-actions__item">
			<div class="bia-quick-card h-full flex flex-col gap-2">
				<h2>{{ _('bia.dashboard.sidebar.exports') }}</h2>
				<div class="grid gap-2">
					<a href="{{ url_for('bia.export_data_inventory') }}" class="inline-flex items-center justify-center font-medium rounded-md px-4 py-2 text-sm transition-colors border border-transparent border-[var(--color-border)] text-[var(--color-muted)] hover:bg-slate-500/10 px-2.5 py-1 text-xs">{{ _('bia.dashboard.sidebar.export_inventory') }}</a>
					<a href="{{ url_for('bia.export_all_consequences') }}" class="inline-flex items-center justify-center font-medium rounded-md px-4 py-2 text-sm transition-colors border border-transparent border-[var(--color-border)] text-[var(--color-muted)] hover:bg-slate-500/10 px-2.5 py-1 text-xs">{{ _('bia.dashboard.sidebar.export_cia_detailed') }}</a>
					<a href="{{ url_for('bia.export_all_consequences', type='summary') }}" class="inline-flex items-center justify-center font-medium rounded-md px-4 py-2 text-sm transition-colors border border-transparent border-[var(--color-border)] text-[var(--color-muted)] hover:bg-slate-500/10 px-2.5 py-1 text-xs">{{ _('bia.dashboard.sidebar.export_cia_summary') }}</a>
					<a href="{{ url_for('bia.export_availability_requirements') }}" class="inline-flex items-center justify-center font-medium rounded-md px-4 py-2 text-sm transition-colors border border-transparent border-[var(--color-border)] text-[var(--color-muted)] hover:bg-slate-500/10 px-2.5 py-1 text-xs">{{ _('bia.dashboard.sidebar.export_availability_detailed') }}</a>
					<a href="{{ url_for('bia.export_availability_requirements', type='summary') }}" class="inline-flex items-center justify-center font-medium rounded-md px-4 py-2 text-sm transition-colors border border-transparent border-[var(--color-border)] text-[var(--color-muted)] hover:bg-slate-500/10 px-2.5 py-1 text-xs">{{ _('bia.dashboard.sidebar.export_availability_summary') }}</a>
					<a href="{{ url_for('bia.export_all_dependencies') }}" class="inline-flex items-center justify-center font-medium rounded-md px-4 py-2 text-sm transition-colors border border-transparent border-[var(--color-border)] text-[var(--color-muted)] hover:bg-slate-500/10 px-2.5 py-1 text-xs">Export Dependencies</a>
					<a href="{{ url_for('bia.export_all_tiers') }}" class="inline-flex items-center justify-center font-medium rounded-md px-4 py-2 text-sm transition-colors border border-transparent border-[var(--color-border)] text-[var(--color-muted)] hover:bg-slate-500/10 px-2.5 py-1 text-xs">Export Tiers</a>
					<a href="{{ url_for('bia.export_authentication_overview') }}" class="inline-flex items-center justify-center font-medium rounded-md px-4 py-2 text-sm transition-colors border border-transparent border-[var(--color-border)] text-[var(--color-muted)] hover:bg-slate-500/10 px-2.5 py-1 text-xs">{{ _('bia.dashboard.sidebar.export_authentication') }}</a>
				</div>
			</div>
		</div>
	</section>

	<section>
		<div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-3 gap-3">
			<div>
				<h2 class="text-lg font-semibold mb-1">{{ _('bia.dashboard.header.title') }}</h2>
				<p class="text-[var(--color-muted)] mb-0">{{ _('bia.dashboard.header.subtitle') }}</p>
			</div>
			<div class="flex flex-wrap gap-2">
				<span class="bia-chip">{{ _('bia.dashboard.card.components', count=stats.components) }}</span>
				<span class="bia-chip bia-chip--muted">{{ _('bia.dashboard.card.last_updated', date=last_updated_display) }}</span>
			</div>
		</div>

		{% if context_list %}
		<div class="grid grid-cols-1 md:grid-cols-2 xxl:grid-cols-3 gap-4 bia-context-grid">
			{% for context in context_list %}
			<article class="h-full">
				<div class="bia-context-card h-full">
					<div class="flex justify-between items-start gap-3">
						<div>
							<h3 class="text-lg font-semibold mb-1">{{ context.name }}</h3>
							<p class="text-[var(--color-muted)] text-sm mb-0">
								{{ _('bia.context_form.fields.coordinator.label') }}: {{ context.coordinator or (context.author.full_name if context.author) or _('bia.dashboard.card.not_assigned') }}
							</p>
							{% if context.last_update %}
							<p class="text-[var(--color-muted)] text-sm mb-0">
								{{ _('bia.dashboard.card.last_updated', date=context.last_update) }}
							</p>
							{% endif %}
						</div>
						<span class="inline-flex items-center text-xs font-semibold uppercase tracking-wide rounded-full px-3 py-0.5 {{ badge_muted }}">{{ _('bia.dashboard.card.components', count=context.components | length) }}</span>
					</div>
					{% if can_manage_owner|default(False) %}
					<div class="bia-context-card__owner">
						<form class="mt-3" method="post" action="{{ url_for('bia.update_owner', item_id=context.id) }}">
							{% if csrf_token is defined %}
							<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
							{% endif %}
							<div class="flex">
								<select class="w-full bg-[var(--color-surface)] border border-[var(--color-border)] rounded-l-lg px-3 py-2 text-sm text-[var(--color-text)] transition focus:outline-none focus:border-primary-500 focus:ring-1 focus:ring-primary-500/30" name="owner_id" aria-label="{{ _('bia.dashboard.card.owner_aria') }}">
									<option value="" {% if not context.author %}selected{% endif %}>{{ _('bia.dashboard.card.owner_unassigned') }}</option>
									{% for user in possible_owners|default([]) %}
										<option value="{{ user.id }}" {% if context.author_id == user.id %}selected{% endif %}>{{ user.full_name }}</option>
									{% endfor %}
								</select>
								<button class="inline-flex items-center justify-center font-medium rounded-r-lg px-3 py-2 text-sm transition-colors border border-l-0 border-[var(--color-border)] bg-[var(--color-surface-hover)] text-[var(--color-text)] hover:bg-[var(--color-surface-active)]" type="submit">{{ _('bia.dashboard.card.action_save') }}</button>
							</div>
						</form>
					</div>
					{% endif %}
					<div class="mt-auto pt-3 flex flex-col gap-2">
						<div class="grid grid-cols-2 gap-2">
							<a href="{{ url_for('bia.view_item', item_id=context.id) }}" class="inline-flex items-center justify-center font-medium rounded-lg px-2.5 py-1.5 text-xs transition-colors border border-[var(--color-border)] text-[var(--color-text)] hover:bg-[var(--color-surface-hover)]">
								<i class="fas fa-eye mr-2"></i> {{ _('bia.dashboard.card.action_view') }}
							</a>
							<div class="dropdown relative">
								<button class="inline-flex items-center justify-center w-full font-medium rounded-lg px-2.5 py-1.5 text-xs transition-colors border border-[var(--color-border)] text-[var(--color-text)] hover:bg-[var(--color-surface-hover)] dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
									<i class="fas fa-download mr-2"></i> {{ _('bia.dashboard.sidebar.exports') }}
								</button>
								<ul class="dropdown-menu absolute z-50 hidden min-w-[10rem] py-1 m-0 text-base rounded-md shadow-lg bg-[var(--color-surface)] border border-[var(--color-border)]">
									<li><a class="dropdown-item block px-4 py-2 text-sm text-[var(--color-text)] hover:bg-[var(--color-surface-hover)]" href="{{ url_for('bia.export_item', item_id=context.id) }}"><i class="fas fa-file-code mr-2 w-5"></i> HTML</a></li>
									<li><a class="dropdown-item block px-4 py-2 text-sm text-[var(--color-text)] hover:bg-[var(--color-surface-hover)]" href="{{ url_for('bia.export_csv', item_id=context.id) }}"><i class="fas fa-file-csv mr-2 w-5"></i> CSV</a></li>
									<li><a class="dropdown-item block px-4 py-2 text-sm text-[var(--color-text)] hover:bg-[var(--color-surface-hover)]" href="{{ url_for('bia.export_bia_sql', item_id=context.id) }}"><i class="fas fa-database mr-2 w-5"></i> SQL</a></li>
								</ul>
							</div>
						</div>
						{% if context.id in editable_context_ids %}
						<div class="grid grid-cols-2 lg:grid-cols-4 gap-2 mt-2">
							<a href="{{ url_for('bia.edit_item', item_id=context.id) }}" class="inline-flex items-center justify-center font-medium rounded-lg px-2 py-1.5 text-xs transition-colors border border-[var(--color-border)] text-[var(--color-text)] hover:bg-[var(--color-surface-hover)]">
								<i class="fas fa-edit mr-1.5"></i> {{ _('bia.actions.edit') }}
							</a>
							<form method="post" action="{{ url_for('bia.copy_item', item_id=context.id) }}">
								{% if csrf_token is defined %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}
								<button type="submit" class="w-full inline-flex items-center justify-center font-medium rounded-lg px-2 py-1.5 text-xs transition-colors border border-[var(--color-border)] text-[var(--color-text)] hover:bg-[var(--color-surface-hover)]" onclick="return confirm('{{ _('bia.actions.confirm_copy') }}');">
									<i class="fas fa-copy mr-1.5"></i> {{ _('bia.actions.copy') }}
								</button>
							</form>
							<form method="post" action="{{ url_for('bia.archive_item', item_id=context.id) }}">
								{% if csrf_token is defined %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}
								<button type="submit" class="w-full inline-flex items-center justify-center font-medium rounded-lg px-2 py-1.5 text-xs transition-colors border border-[var(--color-border)] text-[var(--color-text)] hover:bg-[var(--color-surface-hover)]" onclick="return confirm('{{ _('bia.actions.confirm_archive') }}');">
									<i class="fas fa-archive mr-1.5"></i> {{ _('bia.actions.archive') }}
								</button>
							</form>
							<form method="post" action="{{ url_for('bia.delete_item', item_id=context.id) }}">
								{% if csrf_token is defined %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}
								<button type="submit" class="w-full inline-flex items-center justify-center font-medium rounded-lg px-2 py-1.5 text-xs transition-colors border border-transparent bg-red-100 text-red-700 hover:bg-red-200 dark:bg-red-900/30 dark:text-red-400 dark:hover:bg-red-900/50" onclick="return confirm('{{ _('bia.actions.confirm_delete') }}');">
									<i class="fas fa-trash-alt mr-1.5"></i> {{ _('bia.actions.delete') }}
								</button>
							</form>
						</div>
						{% endif %}
					</div>
				</div>
			</article>
			{% endfor %}
		</div>
		{% else %}
			<div class="bia-dashboard-empty text-center">
				<h3 class="text-lg font-semibold text-primary-600 mb-2">{{ _('bia.dashboard.empty.title') }}</h3>
				<p class="text-[var(--color-muted)] mb-4">{{ _('bia.dashboard.empty.subtitle') }}</p>
				<a href="{{ url_for('bia.new_item') }}" class="inline-flex items-center justify-center font-medium rounded-md px-4 py-2 text-sm transition-colors border border-transparent bg-primary-600 text-white hover:bg-primary-700">{{ _('bia.dashboard.sidebar.new_bia') }}</a>
			</div>
		{% endif %}
	</section>
</div>
{% endblock %}
