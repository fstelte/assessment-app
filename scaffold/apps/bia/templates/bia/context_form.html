{% extends "base.html" %}
{% block title %}{% if item %}Edit BIA{% else %}New BIA{% endif %}{% endblock %}
{% block content %}
<div class="mb-4">
  <a href="{{ url_for('bia.dashboard') }}" class="text-secondary text-decoration-none">&larr; Back to dashboard</a>
</div>

<div class="row justify-content-center">
  <div class="col-lg-9 col-xl-8">
    <div class="card bg-dark border-secondary mb-4">
      <div class="card-body p-4">
        <h1 class="h3 mb-4">{% if item %}Edit {{ item.name }}{% else %}Create a new BIA{% endif %}</h1>
        <form method="post">
          {{ form.hidden_tag() }}

          <h2 class="h5 text-uppercase text-secondary mb-3">General information</h2>
          <div class="row g-3">
            <div class="col-md-6">{{ form.name.label(class="form-label") }}{{ form.name(class="form-control") }}</div>
            <div class="col-md-6">{{ form.user_amount.label(class="form-label") }}{{ form.user_amount(class="form-control") }}</div>
          </div>
          <div class="row g-3 mt-1">
            <div class="col-md-6">{{ form.start_date.label(class="form-label") }}{{ form.start_date(class="form-control", type="date") }}</div>
            <div class="col-md-6">{{ form.end_date.label(class="form-label") }}{{ form.end_date(class="form-control", type="date") }}</div>
          </div>
          <div class="mt-3">{{ form.service_description.label(class="form-label") }}{{ form.service_description(class="form-control", rows=3) }}</div>
          <div class="mt-3">{{ form.scope_description.label(class="form-label") }}{{ form.scope_description(class="form-control", rows=3) }}</div>

          <h2 class="h5 text-uppercase text-secondary mt-4 mb-3">Contacts</h2>
          <div class="row g-3">
            <div class="col-md-6">{{ form.responsible.label(class="form-label") }}{{ form.responsible(class="form-control") }}</div>
            <div class="col-md-6">{{ form.coordinator.label(class="form-label") }}{{ form.coordinator(class="form-control") }}</div>
            <div class="col-md-6">{{ form.project_leader.label(class="form-label") }}{{ form.project_leader(class="form-control") }}</div>
            <div class="col-md-6">{{ form.product_owner.label(class="form-label") }}{{ form.product_owner(class="form-control") }}</div>
            <div class="col-md-6">{{ form.risk_owner.label(class="form-label") }}{{ form.risk_owner(class="form-control") }}</div>
            <div class="col-md-6">{{ form.technical_administrator.label(class="form-label") }}{{ form.technical_administrator(class="form-control") }}</div>
            <div class="col-md-6">{{ form.security_manager.label(class="form-label") }}{{ form.security_manager(class="form-control") }}</div>
            <div class="col-md-6">{{ form.incident_contact.label(class="form-label") }}{{ form.incident_contact(class="form-control") }}</div>
          </div>

          <h2 class="h5 text-uppercase text-secondary mt-4 mb-3">Dependencies & contracts</h2>
          <div class="mt-3">{{ form.mission_critical.label(class="form-label") }}{{ form.mission_critical(class="form-control", rows=2) }}</div>
          <div class="mt-3">{{ form.knowledge.label(class="form-label") }}{{ form.knowledge(class="form-control", rows=2) }}</div>
          <div class="mt-3">{{ form.interfaces.label(class="form-label") }}{{ form.interfaces(class="form-control", rows=2) }}</div>
          <div class="mt-3">{{ form.support_contracts.label(class="form-label") }}{{ form.support_contracts(class="form-control") }}</div>
          <div class="mt-3">{{ form.security_supplier.label(class="form-label") }}{{ form.security_supplier(class="form-control") }}</div>

          <h2 class="h5 text-uppercase text-secondary mt-4 mb-3">Risk posture</h2>
          <div class="row g-3">
            <div class="col-md-6">
              <div class="form-check form-switch">
                {{ form.risk_assessment_human(class="form-check-input", role="switch") }}
                {{ form.risk_assessment_human.label(class="form-check-label") }}
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-check form-switch">
                {{ form.risk_assessment_process(class="form-check-input", role="switch") }}
                {{ form.risk_assessment_process.label(class="form-check-label") }}
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-check form-switch">
                {{ form.risk_assessment_technological(class="form-check-input", role="switch") }}
                {{ form.risk_assessment_technological.label(class="form-check-label") }}
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-check form-switch">
                {{ form.ai_model(class="form-check-input", role="switch") }}
                {{ form.ai_model.label(class="form-check-label") }}
              </div>
            </div>
          </div>

          <div class="d-flex justify-content-end gap-2 mt-4">
            <a href="{{ url_for('bia.dashboard') }}" class="btn btn-outline-secondary">Cancel</a>
            {{ form.submit(class="btn btn-primary") }}
          </div>
        </form>
      </div>
    </div>

    {% if item %}
    <div class="card bg-dark border-secondary mb-4">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h2 class="h5 mb-0">Related components</h2>
          <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#biaAddComponentModal">
            <i class="fas fa-plus me-1"></i>Add component
          </button>
        </div>
        <div class="row g-3" id="bia-component-list">
          {% for component in item.components %}
          <div class="col-md-6 col-xl-4" data-component-id="{{ component.id }}">
            <div class="card border-secondary h-100">
              <div class="card-body">
                <h3 class="h6 text-uppercase text-secondary">{{ component.name }}</h3>
                <p class="text-secondary small mb-3">Linked to {{ item.name }}</p>
                <div class="d-flex gap-2">
                  <button type="button" class="btn btn-outline-light btn-sm w-50 bia-view-component" data-component-id="{{ component.id }}">
                    <i class="fas fa-eye me-1"></i>View
                  </button>
                  <button type="button" class="btn btn-outline-danger btn-sm w-50 bia-delete-component" data-component-id="{{ component.id }}">
                    <i class="fas fa-trash me-1"></i>Delete
                  </button>
                </div>
              </div>
            </div>
          </div>
          {% else %}
          <div class="col-12" id="bia-no-components">
            <div class="alert alert-secondary mb-0">No components added yet.</div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <div class="card bg-dark border-secondary">
      <div class="card-body">
        <h2 class="h5 mb-3">Next steps</h2>
        <p class="text-secondary mb-3">Use these quick links to continue refining {{ item.name }}.</p>
        <div class="d-flex flex-wrap gap-2">
          <a href="{{ url_for('bia.view_item', item_id=item.id) }}" class="btn btn-outline-light btn-sm">View BIA</a>
          <a href="{{ url_for('bia.manage_summary', item_id=item.id) }}" class="btn btn-outline-light btn-sm">Manage summary</a>
          <a href="{{ url_for('bia.export_item', item_id=item.id) }}" class="btn btn-outline-light btn-sm">Export HTML</a>
          <a href="{{ url_for('bia.export_csv', item_id=item.id) }}" class="btn btn-outline-light btn-sm">Export CSV</a>
        </div>
      </div>
    </div>

    <!-- View component modal -->
    <div class="modal fade" id="biaViewComponentModal" tabindex="-1" aria-labelledby="biaViewComponentModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content bg-dark border-secondary">
          <div class="modal-header border-secondary">
            <h2 class="modal-title h5" id="biaViewComponentModalLabel">Component details</h2>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <dl class="row mb-0">
              <dt class="col-sm-4 text-secondary">Name</dt>
              <dd class="col-sm-8" id="bia-view-component-name"></dd>
              <dt class="col-sm-4 text-secondary">Information type</dt>
              <dd class="col-sm-8" id="bia-view-component-info-type"></dd>
              <dt class="col-sm-4 text-secondary">Owner</dt>
              <dd class="col-sm-8" id="bia-view-component-info-owner"></dd>
              <dt class="col-sm-4 text-secondary">User type</dt>
              <dd class="col-sm-8" id="bia-view-component-user-type"></dd>
              <dt class="col-sm-4 text-secondary">Dependencies</dt>
              <dd class="col-sm-8" id="bia-view-component-process"></dd>
              <dt class="col-sm-4 text-secondary">Description</dt>
              <dd class="col-sm-8" id="bia-view-component-description"></dd>
              <dt class="col-sm-4 text-secondary">Consequences</dt>
              <dd class="col-sm-8"><span id="bia-view-component-consequences"></span></dd>
            </dl>
          </div>
          <div class="modal-footer border-secondary">
            <a class="btn btn-outline-light" id="bia-view-consequences-link" target="_blank" rel="noopener">View consequences</a>
            <button type="button" class="btn btn-primary" id="bia-edit-component-launch" data-component-id="">
              <i class="fas fa-edit me-1"></i>Edit
            </button>
            <button type="button" class="btn btn-danger" id="bia-delete-component-launch" data-component-id="">
              <i class="fas fa-trash me-1"></i>Delete
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Add component modal -->
    <div class="modal fade" id="biaAddComponentModal" tabindex="-1" aria-labelledby="biaAddComponentModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content bg-dark border-secondary">
          <div class="modal-header border-secondary">
            <h2 class="modal-title h5" id="biaAddComponentModalLabel">Add new component</h2>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="bia-component-form">
              {{ component_form.hidden_tag() }}
              <div class="mb-3">
                {{ component_form.name.label(class="form-label") }}
                {{ component_form.name(class="form-control", id="bia-component-name") }}
              </div>
              <div class="mb-3">
                {{ component_form.info_type.label(class="form-label") }}
                {{ component_form.info_type(class="form-control", id="bia-component-info-type") }}
              </div>
              <div class="mb-3">
                {{ component_form.info_owner.label(class="form-label") }}
                {{ component_form.info_owner(class="form-control", id="bia-component-info-owner") }}
              </div>
              <div class="mb-3">
                {{ component_form.user_type.label(class="form-label") }}
                {{ component_form.user_type(class="form-control", id="bia-component-user-type") }}
              </div>
              <div class="mb-3">
                {{ component_form.process_dependencies.label(class="form-label") }}
                {{ component_form.process_dependencies(class="form-control", id="bia-component-process-dependencies", rows=3) }}
              </div>
              <div class="mb-3">
                {{ component_form.description.label(class="form-label") }}
                {{ component_form.description(class="form-control", id="bia-component-description", rows=3) }}
              </div>
            </form>
          </div>
          <div class="modal-footer border-secondary">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" id="bia-save-component">Save component</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit component modal -->
    <div class="modal fade" id="biaEditComponentModal" tabindex="-1" aria-labelledby="biaEditComponentModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content bg-dark border-secondary">
          <div class="modal-header border-secondary">
            <h2 class="modal-title h5" id="biaEditComponentModalLabel">Edit component</h2>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="bia-edit-component-form">
              {{ component_form.hidden_tag() }}
              <input type="hidden" name="component_id" id="bia-edit-component-id">
              <div class="mb-3">
                {{ component_form.name.label(class="form-label") }}
                {{ component_form.name(class="form-control", id="bia-edit-component-name") }}
              </div>
              <div class="mb-3">
                {{ component_form.info_type.label(class="form-label") }}
                {{ component_form.info_type(class="form-control", id="bia-edit-component-info-type") }}
              </div>
              <div class="mb-3">
                {{ component_form.info_owner.label(class="form-label") }}
                {{ component_form.info_owner(class="form-control", id="bia-edit-component-info-owner") }}
              </div>
              <div class="mb-3">
                {{ component_form.user_type.label(class="form-label") }}
                {{ component_form.user_type(class="form-control", id="bia-edit-component-user-type") }}
              </div>
              <div class="mb-3">
                {{ component_form.process_dependencies.label(class="form-label") }}
                {{ component_form.process_dependencies(class="form-control", id="bia-edit-component-process-dependencies", rows=3) }}
              </div>
              <div class="mb-3">
                {{ component_form.description.label(class="form-label") }}
                {{ component_form.description(class="form-control", id="bia-edit-component-description", rows=3) }}
              </div>
            </form>
          </div>
          <div class="modal-footer border-secondary">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" id="bia-save-edit-component">Save changes</button>
          </div>
        </div>
      </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
      const componentList = document.getElementById('bia-component-list');
      if (!componentList) {
        return;
      }

      const routes = {
        add: '{{ url_for("bia.add_component") }}',
        detail: '{{ url_for("bia.get_component", component_id=0)[:-1] }}',
        update: '{{ url_for("bia.update_component", component_id=0)[:-1] }}',
        remove: '{{ url_for("bia.delete_component", component_id=0)[:-1] }}',
        consequences: '{{ url_for("bia.view_consequences", component_id=0)[:-1] }}'
      };

      const addModal = new bootstrap.Modal(document.getElementById('biaAddComponentModal'));
      const editModal = new bootstrap.Modal(document.getElementById('biaEditComponentModal'));
      const viewModalEl = document.getElementById('biaViewComponentModal');
      const viewModal = new bootstrap.Modal(viewModalEl);

      const detailFields = {
        name: document.getElementById('bia-view-component-name'),
        info_type: document.getElementById('bia-view-component-info-type'),
        info_owner: document.getElementById('bia-view-component-info-owner'),
        user_type: document.getElementById('bia-view-component-user-type'),
        process_dependencies: document.getElementById('bia-view-component-process'),
        description: document.getElementById('bia-view-component-description'),
        consequences: document.getElementById('bia-view-component-consequences'),
        consequencesLink: document.getElementById('bia-view-consequences-link'),
        editTrigger: document.getElementById('bia-edit-component-launch'),
        deleteTrigger: document.getElementById('bia-delete-component-launch')
      };

      const addForm = document.getElementById('bia-component-form');
      const editForm = document.getElementById('bia-edit-component-form');
      const addButton = document.getElementById('bia-save-component');
      const editButton = document.getElementById('bia-save-edit-component');
      const noComponentsId = 'bia-no-components';
      const biaId = '{{ item.id }}';

      const addCsrfField = addForm.querySelector('input[name="csrf_token"]');
      const editCsrfField = editForm.querySelector('input[name="csrf_token"]');
      const initialAddCsrf = addCsrfField ? addCsrfField.value : '';
      const initialEditCsrf = editCsrfField ? editCsrfField.value : '';

      const buildUrl = (base, id) => `${base}${id}`;
      const getCsrfToken = () => {
        if (addCsrfField && addCsrfField.value) {
          return addCsrfField.value;
        }
        return initialAddCsrf || (editCsrfField ? editCsrfField.value : initialEditCsrf);
      };

      let activeComponent = null;

      const refreshEmptyState = () => {
        const existingMessage = document.getElementById(noComponentsId);
        const hasComponents = componentList.querySelectorAll('[data-component-id]').length > 0;
        if (!hasComponents && !existingMessage) {
          const placeholder = document.createElement('div');
          placeholder.className = 'col-12';
          placeholder.id = noComponentsId;
          placeholder.innerHTML = '<div class="alert alert-secondary mb-0">No components added yet.</div>';
          componentList.appendChild(placeholder);
        } else if (hasComponents && existingMessage) {
          existingMessage.remove();
        }
      };

      const renderComponentCard = (component) => {
        const wrapper = document.createElement('div');
        wrapper.className = 'col-md-6 col-xl-4';
        wrapper.dataset.componentId = component.id;
        wrapper.innerHTML = `
          <div class="card border-secondary h-100">
            <div class="card-body">
              <h3 class="h6 text-uppercase text-secondary">${component.name}</h3>
              <p class="text-secondary small mb-3">Linked to {{ item.name }}</p>
              <div class="d-flex gap-2">
                <button type="button" class="btn btn-outline-light btn-sm w-50 bia-view-component" data-component-id="${component.id}">
                  <i class="fas fa-eye me-1"></i>View
                </button>
                <button type="button" class="btn btn-outline-danger btn-sm w-50 bia-delete-component" data-component-id="${component.id}">
                  <i class="fas fa-trash me-1"></i>Delete
                </button>
              </div>
            </div>
          </div>`;
        return wrapper;
      };

      const populateDetail = (data) => {
        const fallback = (value) => (value && value.trim()) ? value : 'â€”';
        detailFields.name.textContent = fallback(data.name);
        detailFields.info_type.textContent = fallback(data.info_type || '');
        detailFields.info_owner.textContent = fallback(data.info_owner || '');
        detailFields.user_type.textContent = fallback(data.user_type || '');
        detailFields.process_dependencies.textContent = fallback(data.process_dependencies || '');
        detailFields.description.textContent = fallback(data.description || '');
        detailFields.consequences.textContent = data.consequences_count ?? 0;
        detailFields.consequencesLink.href = buildUrl(routes.consequences, data.id);
        detailFields.editTrigger.dataset.componentId = data.id;
        detailFields.deleteTrigger.dataset.componentId = data.id;
      };

      const populateEditForm = (data) => {
        editForm.querySelector('#bia-edit-component-id').value = data.id;
        editForm.querySelector('#bia-edit-component-name').value = data.name || '';
        editForm.querySelector('#bia-edit-component-info-type').value = data.info_type || '';
        editForm.querySelector('#bia-edit-component-info-owner').value = data.info_owner || '';
        editForm.querySelector('#bia-edit-component-user-type').value = data.user_type || '';
        editForm.querySelector('#bia-edit-component-process-dependencies').value = data.process_dependencies || '';
        editForm.querySelector('#bia-edit-component-description').value = data.description || '';
        if (editCsrfField) {
          editCsrfField.value = initialEditCsrf || editCsrfField.value;
        }
      };

      const openViewModal = (componentId) => {
        fetch(buildUrl(routes.detail, componentId), { credentials: 'same-origin' })
          .then((response) => response.ok ? response.json() : Promise.reject(response))
          .then((data) => {
            activeComponent = { ...data, id: componentId };
            populateDetail(activeComponent);
            viewModal.show();
          })
          .catch(() => {
            alert('Unable to load component details.');
          });
      };

      const deleteComponent = (componentId) => {
        if (!confirm('Are you sure you want to delete this component?')) {
          return;
        }
        fetch(buildUrl(routes.remove, componentId), {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
          },
          credentials: 'same-origin'
        })
          .then((response) => response.ok ? response.json() : Promise.reject(response))
          .then((data) => {
            if (!data.success) {
              throw new Error('Server reported a problem.');
            }
            const card = componentList.querySelector(`[data-component-id="${componentId}"]`);
            if (card) {
              card.remove();
            }
            refreshEmptyState();
            if (viewModalEl.classList.contains('show')) {
              viewModal.hide();
            }
          })
          .catch(() => {
            alert('Error while deleting the component.');
          });
      };

      refreshEmptyState();

      addButton.addEventListener('click', () => {
        const formData = new FormData(addForm);
        formData.append('bia_id', biaId);
        const csrfValue = formData.get('csrf_token');
        fetch(routes.add, {
          method: 'POST',
          body: formData,
          headers: csrfValue ? { 'X-CSRFToken': csrfValue } : {},
          credentials: 'same-origin'
        })
          .then((response) => response.ok ? response.json() : response.json().then((data) => Promise.reject(data)))
          .then((data) => {
            if (!data.success) {
              throw data;
            }
            const card = renderComponentCard({ id: data.id, name: data.name });
            const placeholder = document.getElementById(noComponentsId);
            if (placeholder) {
              placeholder.remove();
            }
            componentList.appendChild(card);
            refreshEmptyState();
            addModal.hide();
            addForm.reset();
            if (addCsrfField) {
              addCsrfField.value = initialAddCsrf;
            }
          })
          .catch((error) => {
            if (error && error.errors) {
              const messages = Object.entries(error.errors).map(([field, issues]) => `${field}: ${issues.join(', ')}`).join('\n');
              alert(`Unable to add component:\n${messages}`);
            } else {
              alert('Unable to add component.');
            }
          });
      });

      editButton.addEventListener('click', () => {
        const formData = new FormData(editForm);
        const componentId = formData.get('component_id');
        if (!componentId) {
          alert('Component identifier missing.');
          return;
        }
        const csrfValue = formData.get('csrf_token');
        fetch(buildUrl(routes.update, componentId), {
          method: 'POST',
          body: formData,
          headers: csrfValue ? { 'X-CSRFToken': csrfValue } : {},
          credentials: 'same-origin'
        })
          .then((response) => response.ok ? response.json() : response.json().then((data) => Promise.reject(data)))
          .then((data) => {
            if (!data.success) {
              throw data;
            }
            const card = componentList.querySelector(`[data-component-id="${componentId}"]`);
            if (card) {
              const title = card.querySelector('.card-body h3');
              if (title) {
                title.textContent = data.name;
              }
            }
            if (activeComponent && String(activeComponent.id) === String(componentId)) {
              activeComponent = { ...activeComponent, name: data.name };
              populateDetail(activeComponent);
            }
            editModal.hide();
          })
          .catch((error) => {
            if (error && error.errors) {
              const messages = Object.entries(error.errors).map(([field, issues]) => `${field}: ${issues.join(', ')}`).join('\n');
              alert(`Unable to update component:\n${messages}`);
            } else {
              alert('Unable to update component.');
            }
          });
      });

      detailFields.editTrigger.addEventListener('click', () => {
        if (!activeComponent) {
          return;
        }
        populateEditForm(activeComponent);
        viewModal.hide();
        editModal.show();
      });

      detailFields.deleteTrigger.addEventListener('click', () => {
        if (activeComponent) {
          deleteComponent(activeComponent.id);
        }
      });

      componentList.addEventListener('click', (event) => {
        const button = event.target.closest('button[data-component-id]');
        if (!button) {
          return;
        }
        const componentId = button.dataset.componentId;
        if (button.classList.contains('bia-view-component')) {
          openViewModal(componentId);
        }
        if (button.classList.contains('bia-delete-component')) {
          deleteComponent(componentId);
        }
      });
    });
    </script>
    {% endif %}
  </div>
</div>
{% endblock %}
