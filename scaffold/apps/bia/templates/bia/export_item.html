<!doctype html>
<html lang="en" data-bs-theme="dark">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>BIA Report â€“ {{ item.name }}</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <style nonce="{{ csp_nonce }}">
      body { font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; }
      .badge-impact { text-transform: capitalize; }
      .section-card { margin-bottom: 1.5rem; }
    </style>
  </head>
  <body class="bg-dark text-light">
    <div class="container my-5">
      <header class="mb-4">
        <h1 class="display-6">Business Impact Analysis</h1>
        <p class="text-secondary mb-0">Report generated from the live application data.</p>
      </header>

      <section class="section-card">
        <div class="card bg-dark border-secondary shadow">
          <div class="card-header border-secondary">
            <h2 class="h4 mb-0">{{ item.name }}</h2>
          </div>
          <div class="card-body row g-4">
            <div class="col-lg-8">
              <h3 class="h5">Executive summary</h3>
              <p class="mb-0">{{ item.summary.content if item.summary else "No summary provided." }}</p>
            </div>
            <div class="col-lg-4">
              <dl class="row mb-0">
                <dt class="col-sm-5">Owner</dt>
                <dd class="col-sm-7">{{ item.responsible or 'N/A' }}</dd>
                <dt class="col-sm-5">Coordinator</dt>
                <dd class="col-sm-7">{{ item.coordinator or 'N/A' }}</dd>
                <dt class="col-sm-5">Project lead</dt>
                <dd class="col-sm-7">{{ item.project_leader or 'N/A' }}</dd>
                <dt class="col-sm-5">Product owner</dt>
                <dd class="col-sm-7">{{ item.product_owner or 'N/A' }}</dd>
                <dt class="col-sm-5">Risk owner</dt>
                <dd class="col-sm-7">{{ item.risk_owner or 'N/A' }}</dd>
              </dl>
            </div>
          </div>
        </div>
      </section>

      <section class="section-card">
        <div class="card bg-dark border-secondary">
          <div class="card-header border-secondary">
            <h2 class="h5 mb-0">Scope & context</h2>
          </div>
          <div class="card-body">
            <div class="row g-4">
              <div class="col-lg-6">
                <h3 class="h6 text-secondary text-uppercase">Service description</h3>
                <p>{{ item.service_description or 'N/A' }}</p>
                <h3 class="h6 text-secondary text-uppercase">Scope</h3>
                <p>{{ item.scope_description or 'N/A' }}</p>
              </div>
              <div class="col-lg-6">
                <table class="table table-dark table-striped mb-0">
                  <tbody>
                    <tr>
                      <th scope="row">Knowledge</th>
                      <td>{{ item.knowledge or 'N/A' }}</td>
                    </tr>
                    <tr>
                      <th scope="row">Interfaces</th>
                      <td>{{ item.interfaces or 'N/A' }}</td>
                    </tr>
                    <tr>
                      <th scope="row">Mission critical</th>
                      <td>{{ item.mission_critical or 'N/A' }}</td>
                    </tr>
                    <tr>
                      <th scope="row">Support contracts</th>
                      <td>{{ item.support_contracts or 'N/A' }}</td>
                    </tr>
                    <tr>
                      <th scope="row">Security supplier</th>
                      <td>{{ item.security_supplier or 'N/A' }}</td>
                    </tr>
                    <tr>
                      <th scope="row">Users</th>
                      <td>{{ item.user_amount or 'Unknown' }}</td>
                    </tr>
                    <tr>
                      <th scope="row">AI model in scope</th>
                      <td>{{ 'Yes' if item.ai_model else 'No' }}</td>
                    </tr>
                    <tr>
                      <th scope="row">Last update</th>
                      <td>{{ item.last_update or 'N/A' }}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="section-card">
        <div class="card bg-dark border-secondary">
          <div class="card-header border-secondary">
            <h2 class="h5 mb-0">Risk assessments</h2>
          </div>
          <div class="card-body">
            <div class="row g-4">
              <div class="col-lg-4">
                <div class="card bg-secondary bg-opacity-25 border-0 h-100">
                  <div class="card-body text-center">
                    <div class="text-secondary text-uppercase mb-2">People</div>
                    <span class="badge {{ 'text-bg-success' if item.risk_assessment_human else 'text-bg-secondary' }}">{{ 'Required' if item.risk_assessment_human else 'Not required' }}</span>
                  </div>
                </div>
              </div>
              <div class="col-lg-4">
                <div class="card bg-secondary bg-opacity-25 border-0 h-100">
                  <div class="card-body text-center">
                    <div class="text-secondary text-uppercase mb-2">Process</div>
                    <span class="badge {{ 'text-bg-success' if item.risk_assessment_process else 'text-bg-secondary' }}">{{ 'Required' if item.risk_assessment_process else 'Not required' }}</span>
                  </div>
                </div>
              </div>
              <div class="col-lg-4">
                <div class="card bg-secondary bg-opacity-25 border-0 h-100">
                  <div class="card-body text-center">
                    <div class="text-secondary text-uppercase mb-2">Technology</div>
                    <span class="badge {{ 'text-bg-success' if item.risk_assessment_technological else 'text-bg-secondary' }}">{{ 'Required' if item.risk_assessment_technological else 'Not required' }}</span>
                  </div>
                </div>
              </div>
            </div>
            <div class="mt-4">
              <h3 class="h6 text-secondary text-uppercase">AI identification</h3>
              {% if ai_identifications %}
                <ul class="list-group list-group-flush">
                  {% for component in item.components %}
                    {% set ai = ai_identifications.get(component.id) %}
                    {% if ai %}
                    <li class="list-group-item bg-dark text-light border-secondary">
                      <div class="d-flex justify-content-between">
                        <span><strong>{{ component.name }}</strong></span>
                        <span class="badge text-bg-info">{{ ai.category }}</span>
                      </div>
                      <p class="mb-0 small text-secondary">{{ ai.motivatie or 'No details provided.' }}</p>
                    </li>
                    {% endif %}
                  {% endfor %}
                </ul>
              {% else %}
                <p class="text-secondary mb-0">No AI risks were identified for the linked components.</p>
              {% endif %}
            </div>
          </div>
        </div>
      </section>

      <section class="section-card">
        <div class="card bg-dark border-secondary">
          <div class="card-header border-secondary d-flex justify-content-between align-items-center">
            <h2 class="h5 mb-0">Consequences</h2>
            <div class="d-flex gap-2">
              {% for prop, label in {'confidentiality': 'Confidentiality', 'integrity': 'Integrity', 'availability': 'Availability'}.items() %}
              {% set value = max_cia_impact.get(prop) %}
              <span class="badge badge-impact {{ bia_get_impact_color(value) }}">{{ label[0] }}: {{ value or 'n/a' }}</span>
              {% endfor %}
            </div>
          </div>
          <div class="card-body">
            {% if consequences %}
            <div class="table-responsive">
              <table class="table table-dark table-striped align-middle">
                <thead>
                  <tr>
                    <th scope="col">Component</th>
                    <th scope="col">Category</th>
                    <th scope="col">Security property</th>
                    <th scope="col">Worst case</th>
                    <th scope="col">Realistic case</th>
                    <th scope="col">CIA impact (realistic)</th>
                  </tr>
                </thead>
                <tbody>
                  {% for consequence in consequences %}
                  <tr>
                    <td>{{ consequence.component.name }}</td>
                    <td>{{ consequence.consequence_category }}</td>
                    <td class="text-uppercase">{{ consequence.security_property }}</td>
                    <td>
                      {% set worst = consequence.consequence_worstcase or 'N/A' %}
                      <span class="badge badge-impact {{ bia_get_impact_color(worst) }}">{{ worst }}</span>
                    </td>
                    <td>
                      {% set realistic = consequence.consequence_realisticcase or 'N/A' %}
                      <span class="badge badge-impact {{ bia_get_impact_color(realistic) }}">{{ realistic }}</span>
                    </td>
                    <td>
                      C: <span class="badge badge-impact {{ bia_get_impact_color(bia_get_cia_impact(consequence, 'confidentiality')) }}">{{ bia_get_cia_impact(consequence, 'confidentiality') }}</span><br>
                      I: <span class="badge badge-impact {{ bia_get_impact_color(bia_get_cia_impact(consequence, 'integrity')) }}">{{ bia_get_cia_impact(consequence, 'integrity') }}</span><br>
                      A: <span class="badge badge-impact {{ bia_get_impact_color(bia_get_cia_impact(consequence, 'availability')) }}">{{ bia_get_cia_impact(consequence, 'availability') }}</span>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% else %}
            <p class="text-secondary mb-0">No consequences have been recorded for this BIA.</p>
            {% endif %}
          </div>
        </div>
      </section>

      <section class="section-card">
        <div class="card bg-dark border-secondary">
          <div class="card-header border-secondary">
            <h2 class="h5 mb-0">Components</h2>
          </div>
          <div class="card-body">
            {% if item.components %}
            <div class="table-responsive">
              <table class="table table-dark table-striped align-middle">
                <thead>
                  <tr>
                    <th scope="col">Component</th>
                    <th scope="col">Information type</th>
                    <th scope="col">Owner</th>
                    <th scope="col">Description</th>
                  </tr>
                </thead>
                <tbody>
                  {% for component in item.components %}
                  <tr>
                    <td>{{ component.name }}</td>
                    <td>{{ component.info_type or 'N/A' }}</td>
                    <td>{{ component.info_owner or 'N/A' }}</td>
                    <td>{{ component.description or 'N/A' }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% else %}
            <p class="text-secondary mb-0">No components are linked to this BIA.</p>
            {% endif %}
          </div>
        </div>
      </section>

      <section class="section-card">
        <div class="card bg-dark border-secondary">
          <div class="card-header border-secondary">
            <h2 class="h5 mb-0">Availability requirements</h2>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-dark table-striped align-middle">
                <thead>
                  <tr>
                    <th scope="col">Component</th>
                    <th scope="col">MTD</th>
                    <th scope="col">RTO</th>
                    <th scope="col">RPO</th>
                    <th scope="col">MASL</th>
                  </tr>
                </thead>
                <tbody>
                  {% for component in item.components %}
                  {% set availability = component.availability_requirement %}
                  <tr>
                    <td>{{ component.name }}</td>
                    <td>{{ availability.mtd if availability else 'N/A' }}</td>
                    <td>{{ availability.rto if availability else 'N/A' }}</td>
                    <td>{{ availability.rpo if availability else 'N/A' }}</td>
                    <td>{{ availability.masl if availability else 'N/A' }}</td>
                  </tr>
                  {% else %}
                  <tr>
                    <td colspan="5" class="text-center text-secondary">No components to display.</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>
    </div>
  </body>
</html>
