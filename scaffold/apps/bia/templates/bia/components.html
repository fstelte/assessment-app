{% extends "base.html" %}
{% from "partials/forms.html" import render_field_with_tooltip %}
{% block title %}{{ _('bia.components.page_title') }}{% endblock %}
{% block content %}
<div class="mb-3">
  <a href="{{ url_for('bia.dashboard') }}" class="text-secondary text-decoration-none">&larr; {{ _('bia.components.back') }}</a>
</div>

<div class="d-flex justify-content-between align-items-center mb-4">
  <h1 class="mb-0">{{ _('bia.components.heading') }}</h1>
  <form class="d-flex gap-2" method="get" action="{{ url_for('bia.view_components') }}">
    <select class="form-select" name="scope">
      <option value="all" {% if selected_scope|lower == 'all' %}selected{% endif %}>{{ _('bia.components.filters.all') }}</option>
      {% for context in contexts %}
        <option value="{{ context.name }}" {% if context.name == selected_scope %}selected{% endif %}>{{ context.name }}</option>
      {% endfor %}
    </select>
    <button type="submit" class="btn btn-outline-light">{{ _('bia.components.filters.button') }}</button>
  </form>
</div>

<div class="card bg-dark border-secondary mb-4">
  <div class="card-header border-secondary">{{ _('bia.components.add.title') }}</div>
  <div class="card-body">
    <form id="add-component-form" action="{{ url_for('bia.add_component') }}" method="post" class="row g-3 align-items-end">
      {{ component_form.hidden_tag() }}
      <div class="col-md-4 tooltip-wrapper" data-tooltip="{{ _('bia.components.tooltips.scope') }}">
        <label for="bia-id" class="form-label tooltip-trigger">{{ _('bia.components.add.bia_label') }}</label>
        <span id="bia-id-tooltip" class="visually-hidden">{{ _('bia.components.tooltips.scope') }}</span>
        <select id="bia-id" name="bia_id" class="form-select" required aria-describedby="bia-id-tooltip">
          <option value="" disabled selected>{{ _('bia.components.add.bia_placeholder') }}</option>
          {% for context in contexts %}
            <option value="{{ context.id }}">{{ context.name }}</option>
          {% endfor %}
        </select>
      </div>
      {{ render_field_with_tooltip(component_form.name, _('bia.components.labels.name'), _('bia.components.tooltips.name'), container_class='col-md-4', input_class='form-control') }}
      <div class="col-md-4">{{ component_form.info_owner.label(_('bia.components.labels.owner'), class="form-label") }}{{ component_form.info_owner(class="form-control") }}</div>
      <div class="col-md-4">{{ component_form.info_type.label(_('bia.components.labels.information_type'), class="form-label") }}{{ component_form.info_type(class="form-control") }}</div>
      <div class="col-md-4">{{ component_form.user_type.label(_('bia.components.labels.user_type'), class="form-label") }}{{ component_form.user_type(class="form-control") }}</div>
      <div class="col-md-4">{{ component_form.authentication_method.label(_('bia.components.labels.authentication'), class="form-label") }}{{ component_form.authentication_method(class="form-select") }}</div>
      <div class="col-md-4">{{ component_form.process_dependencies.label(_('bia.components.labels.process_dependencies'), class="form-label") }}{{ component_form.process_dependencies(class="form-control") }}</div>
      <div class="col-12">{{ component_form.description.label(_('bia.components.labels.description'), class="form-label") }}{{ component_form.description(class="form-control", rows=2) }}</div>
      <div class="col-12 text-end">
        <button type="submit" class="btn btn-primary">{{ _('bia.components.add.submit') }}</button>
      </div>
    </form>
  </div>
</div>

<div class="card bg-dark border-secondary" id="consequences">
  <div class="card-header border-secondary">{{ _('bia.components.table.title') }}</div>
  <div class="card-body p-0">
    {% if components %}
    <div class="table-responsive">
      <table class="table table-dark table-striped align-middle mb-0">
        <thead>
          <tr>
            <th scope="col">{{ _('bia.components.table.headers.component') }}</th>
            <th scope="col">{{ _('bia.components.table.headers.bia') }}</th>
            <th scope="col">{{ _('bia.components.table.headers.owner') }}</th>
            <th scope="col">{{ _('bia.components.table.headers.users') }}</th>
            <th scope="col">{{ _('bia.components.table.headers.authentication') }}</th>
            <th scope="col">{{ _('bia.components.table.headers.consequences') }}</th>
            <th scope="col">{{ _('bia.components.table.headers.dpia') }}</th>
            <th scope="col">{{ _('bia.components.table.headers.actions') }}</th>
          </tr>
        </thead>
        <tbody>
          {% for component in components %}
          <tr>
            <td>{{ component.name }}</td>
            <td>{{ component.context_scope.name if component.context_scope else _('bia.components.table.not_linked') }}</td>
            <td>{{ component.info_owner or _('bia.components.table.not_set') }}</td>
            <td>{{ component.user_type or _('bia.components.table.not_set') }}</td>
            <td>
              {% set auth_label = bia_component_authentication(component) %}
              {% if auth_label %}
                <span class="badge bg-info text-dark">{{ auth_label }}</span>
              {% else %}
                <span class="badge bg-secondary">{{ _('bia.components.authentication.unset_badge') }}</span>
              {% endif %}
            </td>
            <td>{{ component.consequences | length }}</td>
            <td>
              {% if dpia_enabled %}
                {% set dpia_count = component.dpia_assessments | length %}
                {% if dpia_count %}
                  <div class="d-flex flex-column gap-1">
                    <span class="badge bg-success">{{ _('bia.components.dpia.active_badge', count=dpia_count) }}</span>
                    <a href="{{ url_for('dpia.dashboard') }}" class="btn btn-outline-light btn-sm">{{ _('bia.components.dpia.view_all') }}</a>
                  </div>
                {% else %}
                  <a href="{{ url_for('dpia.start_from_component', component_id=component.id) }}" class="btn btn-primary btn-sm">
                    {{ _('bia.components.dpia.start_button') }}
                  </a>
                {% endif %}
              {% else %}
                <span class="text-secondary small">{{ _('bia.components.dpia.unavailable') }}</span>
              {% endif %}
            </td>
            <td>
              <div class="d-flex flex-wrap gap-2">
                <button class="btn btn-outline-light btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#edit-component-{{ component.id }}" aria-expanded="false" aria-controls="edit-component-{{ component.id }}">{{ _('bia.components.buttons.edit') }}</button>
                <button class="btn btn-outline-primary btn-sm" type="button" data-ai-manage data-component-id="{{ component.id }}">{{ _('bia.components.ai.identify') }}</button>
                <a href="{{ url_for('bia.view_consequences', component_id=component.id) }}" class="btn btn-outline-secondary btn-sm">{{ _('bia.components.buttons.consequences') }}</a>
                <button class="btn btn-outline-danger btn-sm" type="button" data-delete-url="{{ url_for('bia.delete_component', component_id=component.id) }}">{{ _('bia.components.buttons.delete') }}</button>
              </div>
            </td>
          </tr>
          <tr class="collapse" id="edit-component-{{ component.id }}">
            <td colspan="7" class="bg-secondary bg-opacity-10">
              <form class="component-edit-form row g-3" data-action="{{ url_for('bia.update_component', component_id=component.id) }}">
                {{ component_form.hidden_tag() }}
                <div class="col-md-4 tooltip-wrapper" data-tooltip="{{ _('bia.components.tooltips.name') }}">
                  <label class="form-label tooltip-trigger" for="name-{{ component.id }}">{{ _('bia.components.labels.name') }}</label>
                  <span id="name-{{ component.id }}-tooltip" class="visually-hidden">{{ _('bia.components.tooltips.name') }}</span>
                  <input type="text" id="name-{{ component.id }}" name="name" class="form-control" value="{{ component.name }}" required aria-describedby="name-{{ component.id }}-tooltip">
                </div>
                <div class="col-md-4 tooltip-wrapper" data-tooltip="{{ _('bia.components.tooltips.scope') }}">
                  <label class="form-label tooltip-trigger" for="bia_id-{{ component.id }}">{{ _('bia.components.add.bia_label') }}</label>
                  <span id="bia_id-{{ component.id }}-tooltip" class="visually-hidden">{{ _('bia.components.tooltips.scope') }}</span>
                  <select id="bia_id-{{ component.id }}" name="bia_id" class="form-select" required aria-describedby="bia_id-{{ component.id }}-tooltip">
                    {% for context in contexts %}
                      <option value="{{ context.id }}" {% if component.context_scope and component.context_scope.id == context.id %}selected{% endif %}>{{ context.name }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-4">
                  <label class="form-label" for="info_owner-{{ component.id }}">{{ _('bia.components.labels.owner') }}</label>
                  <input type="text" id="info_owner-{{ component.id }}" name="info_owner" class="form-control" value="{{ component.info_owner }}">
                </div>
                <div class="col-md-4">
                  <label class="form-label" for="info_type-{{ component.id }}">{{ _('bia.components.labels.information_type') }}</label>
                  <input type="text" id="info_type-{{ component.id }}" name="info_type" class="form-control" value="{{ component.info_type }}">
                </div>
                <div class="col-md-4">
                  <label class="form-label" for="user_type-{{ component.id }}">{{ _('bia.components.labels.user_type') }}</label>
                  <input type="text" id="user_type-{{ component.id }}" name="user_type" class="form-control" value="{{ component.user_type }}">
                </div>
                <div class="col-md-4">
                  <label class="form-label" for="authentication_method-{{ component.id }}">{{ _('bia.components.labels.authentication') }}</label>
                  {% set selected_value = component.authentication_method_id|string if component.authentication_method_id is not none else '' %}
                  <select id="authentication_method-{{ component.id }}" name="authentication_method" class="form-select">
                    {% for value, label in component_form.authentication_method.choices %}
                      <option value="{{ value }}" {% if value == selected_value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-4">
                  <label class="form-label" for="process_dependencies-{{ component.id }}">{{ _('bia.components.labels.process_dependencies') }}</label>
                  <input type="text" id="process_dependencies-{{ component.id }}" name="process_dependencies" class="form-control" value="{{ component.process_dependencies }}">
                </div>
                <div class="col-md-12">
                  <label class="form-label" for="description-{{ component.id }}">{{ _('bia.components.labels.description') }}</label>
                  <textarea id="description-{{ component.id }}" name="description" class="form-control" rows="2">{{ component.description }}</textarea>
                </div>
                <div class="col-12 text-end">
                  <button type="submit" class="btn btn-outline-light btn-sm">{{ _('bia.components.buttons.save_changes') }}</button>
                </div>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div class="d-flex flex-column flex-md-row align-items-center justify-content-between gap-2 px-3 py-2 border-top border-secondary">
      <small class="text-secondary mb-0">
        {% if pagination.pages > 1 %}
          {{ _('bia.components.table.pagination_with_pages', start=page_start, end=page_end, total=pagination.total, page=pagination.page, pages=pagination.pages) }}
        {% else %}
          {{ _('bia.components.table.pagination', start=page_start, end=page_end, total=pagination.total) }}
        {% endif %}
      </small>
      {% if pagination.pages > 1 %}
      <nav aria-label="Component pagination">
        <ul class="pagination pagination-sm mb-0">
          <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('bia.view_components', page=pagination.prev_num, scope=selected_scope) }}" aria-label="Previous" tabindex="-1">&laquo;</a>
          </li>
          {% for p in pagination.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
            {% if p %}
              <li class="page-item {% if p == pagination.page %}active{% endif %}">
                <a class="page-link" href="{{ url_for('bia.view_components', page=p, scope=selected_scope) }}">{{ p }}</a>
              </li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">&hellip;</span></li>
            {% endif %}
          {% endfor %}
          <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('bia.view_components', page=pagination.next_num, scope=selected_scope) }}" aria-label="Next">&raquo;</a>
          </li>
        </ul>
      </nav>
      {% endif %}
    </div>
    {% else %}
      <div class="p-4 text-secondary">{{ _('bia.components.table.empty') }}</div>
    {% endif %}
  </div>
  </div>

  <div class="modal fade" id="ai-identification-modal" tabindex="-1" aria-labelledby="ai-identification-label" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content bg-dark border-secondary">
        <div class="modal-header border-secondary">
          <h2 class="modal-title h5" id="ai-identification-label">{{ _('bia.components.modal.title') }}</h2>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="ai-identification-form" class="vstack gap-3">
            <input type="hidden" id="ai-component-id" name="component_id">
            <div>
              <label class="form-label" for="ai-category">{{ _('bia.components.modal.category') }}</label>
              <select id="ai-category" name="category" class="form-select">
                <option value="No AI">{{ _('bia.components.ai.options.no_ai') }}</option>
                <option value="Unacceptable risk">{{ _('bia.components.ai.options.unacceptable') }}</option>
                <option value="High risk">{{ _('bia.components.ai.options.high') }}</option>
                <option value="Limited risk">{{ _('bia.components.ai.options.limited') }}</option>
                <option value="Minimal risk">{{ _('bia.components.ai.options.minimal') }}</option>
              </select>
            </div>
            <div>
              <label class="form-label" for="ai-motivation">{{ _('bia.components.modal.motivation') }}</label>
              <textarea id="ai-motivation" name="motivatie" class="form-control" rows="3" placeholder="{{ _('bia.components.modal.placeholder') }}"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer border-secondary">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">{{ _('bia.components.modal.buttons.cancel') }}</button>
          <button type="button" class="btn btn-primary" data-ai-save>{{ _('bia.components.modal.buttons.save') }}</button>
        </div>
      </div>
    </div>
</div>

<script nonce="{{ csp_nonce }}">
(function () {
  const addForm = document.getElementById('add-component-form');
  const csrfTokenInput = document.querySelector('input[name="csrf_token"]');
  const csrfToken = csrfTokenInput ? csrfTokenInput.value : null;
  const aiModalElement = document.getElementById('ai-identification-modal');
  const aiForm = document.getElementById('ai-identification-form');
  const aiComponentIdField = document.getElementById('ai-component-id');
  const aiCategoryField = document.getElementById('ai-category');
  const aiMotivationField = document.getElementById('ai-motivation');
  const aiSaveTrigger = document.querySelector('[data-ai-save]');
  const i18n = {
    errorUnexpected: "{{ _('bia.components.messages.error_unexpected') }}",
    validationFailed: "{{ _('bia.components.messages.validation_failed') }}",
    componentMissing: "{{ _('bia.components.messages.component_reference_missing') }}",
    saveFailed: "{{ _('bia.components.messages.save_failed') }}",
    addFailed: "{{ _('bia.components.messages.add_failed') }}",
    updateFailed: "{{ _('bia.components.messages.update_failed') }}",
    deleteFailed: "{{ _('bia.components.messages.delete_failed') }}",
    confirmDelete: "{{ _('bia.components.table.confirm_delete') }}"
  };
  const aiRoutes = {
    detail: '{{ url_for("bia.get_ai_identification", component_id=0)[:-1] }}',
    upsert: '{{ url_for("bia.add_ai_identification", component_id=0)[:-1] }}'
  };
  const handleErrors = (messages) => {
    if (!messages) {
      window.alert(i18n.errorUnexpected);
      return;
    }
    const details = Object.entries(messages).map(([field, errs]) => `${field}: ${errs.join(', ')}`).join('\n');
    window.alert(`${i18n.validationFailed}\n${details}`);
  };

  const openAiModal = (componentId) => {
    if (!aiComponentIdField) {
      return;
    }
    const modalInstance = aiModalElement ? window.bootstrap?.Modal.getOrCreateInstance(aiModalElement) : null;
    aiComponentIdField.value = componentId;
    const targetUrl = aiRoutes.detail + componentId;
    fetch(targetUrl, { credentials: 'same-origin' })
      .then((response) => {
        if (response.status === 404) {
          return { category: 'No AI', motivatie: '' };
        }
        if (!response.ok) {
          throw new Error('Lookup failed');
        }
        return response.json();
      })
      .then((data) => {
        if (aiCategoryField) {
          aiCategoryField.value = data.category || 'No AI';
        }
        if (aiMotivationField) {
          aiMotivationField.value = data.motivatie || '';
        }
        modalInstance?.show();
      })
      .catch(() => {
        if (aiCategoryField) {
          aiCategoryField.value = 'No AI';
        }
        if (aiMotivationField) {
          aiMotivationField.value = '';
        }
        modalInstance?.show();
      });
  };

  document.querySelectorAll('[data-ai-manage]').forEach((button) => {
    button.addEventListener('click', () => {
      const componentId = button.getAttribute('data-component-id');
      if (componentId) {
        openAiModal(componentId);
      }
    });
  });

  aiModalElement?.addEventListener('hidden.bs.modal', () => {
    if (aiForm) {
      aiForm.reset();
    }
  });

  aiSaveTrigger?.addEventListener('click', () => {
    if (!aiForm || !aiComponentIdField) {
      return;
    }
    const componentId = aiComponentIdField.value;
    if (!componentId) {
      window.alert(i18n.componentMissing);
      return;
    }
    const formData = new FormData();
    if (csrfToken) {
      formData.append('csrf_token', csrfToken);
    }
    formData.append('category', aiCategoryField ? aiCategoryField.value : 'No AI');
    formData.append('motivatie', aiMotivationField ? aiMotivationField.value : '');

    fetch(aiRoutes.upsert + componentId, {
      method: 'POST',
      body: formData,
      credentials: 'same-origin',
    })
      .then((response) => {
        if (!response.ok) {
          throw new Error('Save failed');
        }
        return response.json();
      })
      .then((data) => {
        if (!data.success) {
          throw new Error('Server rejected the request');
        }
        const modalInstance = aiModalElement ? window.bootstrap?.Modal.getInstance(aiModalElement) : null;
        modalInstance?.hide();
        window.location.reload();
      })
      .catch(() => {
        window.alert(i18n.saveFailed);
      });
  });

  if (addForm) {
    addForm.addEventListener('submit', function (event) {
      event.preventDefault();
      const formData = new FormData(addForm);
      fetch(addForm.action, {
        method: 'POST',
        body: formData,
      }).then((response) => response.json())
        .then((data) => {
          if (data.success) {
            window.location.reload();
          } else {
            handleErrors(data.errors);
          }
        })
        .catch(() => window.alert(i18n.addFailed));
    });
  }

  document.querySelectorAll('.component-edit-form').forEach((form) => {
    form.addEventListener('submit', function (event) {
      event.preventDefault();
      const formData = new FormData(form);
      fetch(form.dataset.action, {
        method: 'POST',
        body: formData,
      }).then((response) => response.json())
        .then((data) => {
          if (data.success) {
            window.location.reload();
          } else {
            handleErrors(data.errors);
          }
        })
        .catch(() => window.alert(i18n.updateFailed));
    });
  });

  document.querySelectorAll('[data-delete-url]').forEach((button) => {
    button.addEventListener('click', function () {
      if (!window.confirm(i18n.confirmDelete)) {
        return;
      }
      const payload = new FormData();
      if (csrfToken) {
        payload.append('csrf_token', csrfToken);
      }
      fetch(this.dataset.deleteUrl, {
        method: 'POST',
        body: payload,
      }).then((response) => response.json())
        .then((data) => {
          if (data.success) {
            window.location.reload();
          } else {
            window.alert(i18n.deleteFailed);
          }
        })
        .catch(() => window.alert(i18n.deleteFailed));
    });
  });
})();
</script>
{% endblock %}
