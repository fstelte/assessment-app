{% extends "base.html" %}
{% block title %}{{ _('csa.dashboard.title') }}{% endblock %}
{% block extra_css %}
<style nonce="{{ csp_nonce }}">
.csa-dashboard {
	display: flex;
	flex-direction: column;
	gap: 2rem;
}
.csa-dashboard-hero {
	background: linear-gradient(130deg, rgba(13, 110, 253, 0.95), rgba(111, 66, 193, 0.95));
	border-radius: 1.5rem;
	padding: clamp(1.75rem, 4vw, 2.5rem);
	box-shadow: 0 1.25rem 3rem rgba(15, 23, 42, 0.25);
	color: #fff;
	position: relative;
	overflow: hidden;
}
body[data-theme="dark"] .csa-dashboard-hero {
	background: linear-gradient(130deg, rgba(13, 110, 253, 0.6), rgba(111, 66, 193, 0.7));
	box-shadow: 0 1rem 2.5rem rgba(0, 0, 0, 0.45);
	border: 1px solid rgba(255, 255, 255, 0.08);
}
.csa-dashboard-hero::after {
	content: "";
	position: absolute;
	width: 320px;
	height: 320px;
	background: radial-gradient(circle, rgba(255, 255, 255, 0.2), transparent 65%);
	right: -80px;
	top: -60px;
	filter: blur(4px);
}
.csa-dashboard-hero__body {
	position: relative;
	z-index: 1;
}
.csa-dashboard-hero__metrics {
	display: grid;
	grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
	gap: 1.25rem;
	margin-top: 1.5rem;
}
.csa-dashboard-hero__metric {
	background: rgba(255, 255, 255, 0.08);
	border-radius: 1rem;
	padding: 1rem 1.25rem;
	backdrop-filter: blur(6px);
}
.csa-dashboard-hero__metric strong {
	font-size: clamp(1.5rem, 4vw, 2.5rem);
	line-height: 1;
}
.csa-dashboard-hero__metric small {
	color: rgba(255, 255, 255, 0.8);
}
.csa-quick-card {
	border: none;
	border-radius: 1.25rem;
	background: var(--bs-body-bg);
	box-shadow: 0 0.5rem 1.5rem rgba(15, 23, 42, 0.08);
	padding: 1.5rem;
	height: 100%;
}
body[data-theme="dark"] .csa-quick-card {
	background: rgba(18, 18, 18, 0.8);
	border: 1px solid rgba(255, 255, 255, 0.08);
	box-shadow: 0 0.5rem 1.5rem rgba(0, 0, 0, 0.65);
}
.csa-quick-card h2 {
	font-size: 0.75rem;
	letter-spacing: 0.1em;
	text-transform: uppercase;
	color: var(--bs-secondary-color);
	margin-bottom: 1rem;
}
.csa-quick-nav .nav-link {
	border-radius: 0.75rem;
	padding: 0.65rem 0.75rem;
	font-weight: 500;
	color: inherit;
	transition: background 0.2s ease, transform 0.2s ease;
}
.csa-quick-nav .nav-link:hover {
	background: rgba(13, 110, 253, 0.08);
	transform: translateX(4px);
}
.csa-dashboard-actions {
	display: grid;
	gap: 1.5rem;
}
@media (min-width: 768px) {
	.csa-dashboard-actions {
		grid-template-columns: repeat(3, minmax(0, 1fr));
	}
}
</style>
{% endblock %}

{% block content %}
{% set can_manage_assignments = current_user.has_role('admin') or current_user.has_role('manager') or current_user.has_role('control_assigner') %}

<div class="csa-dashboard">
	<div class="csa-dashboard-hero">
		<div class="csa-dashboard-hero__body">
			<h1 class="display-5 fw-bold mb-2">{{ _('csa.dashboard.heading') }}</h1>
			<p class="lead opacity-75 mb-0" style="max-width: 600px;">{{ _('csa.dashboard.lead') }}</p>
			
			<div class="csa-dashboard-hero__metrics">
				<div class="csa-dashboard-hero__metric">
					<strong class="d-block">{{ assessment_count }}</strong>
					<small class="text-uppercase">{{ _('csa.dashboard.cards.assessments.title') }}</small>
				</div>
				<div class="csa-dashboard-hero__metric">
					<strong class="d-block">{{ control_count }}</strong>
					<small class="text-uppercase">{{ _('csa.dashboard.cards.controls.title') }}</small>
				</div>
			</div>
		</div>
	</div>

	<div class="csa-dashboard-actions">
		<div>
			<div class="csa-quick-card">
				<h2>{{ _('csa.dashboard.quick_actions.title') | default('Quick Actions') }}</h2>
				<nav class="nav flex-column csa-quick-nav">
					<a class="nav-link" href="{{ url_for('csa.start_assessment') }}">
						<i class="bi bi-play-circle me-2"></i> {{ _('csa.dashboard.quick_actions.start') }}
					</a>
					{% if can_manage_assignments %}
					<a class="nav-link" href="{{ url_for('csa.assign_assessment') }}">
						<i class="bi bi-person-plus me-2"></i> {{ _('csa.dashboard.quick_actions.assign') }}
					</a>
					<a class="nav-link" href="{{ url_for('csa.overview_assessments') }}">
						<i class="bi bi-list-check me-2"></i> {{ _('csa.dashboard.quick_actions.overview') }}
					</a>
					{% endif %}
				</nav>
			</div>
		</div>

		<div>
			<div class="csa-quick-card">
				<h2>{{ _('csa.dashboard.cards.workflow.title') }}</h2>
				{% set total_status = status_totals.values() | sum %}
				{% for status, label in csa_status_labels.items() %}
					{% set count = status_totals[status] or 0 %}
					<div class="mb-3">
						<div class="d-flex justify-content-between small mb-1">
							<span>{{ label }}</span>
							<span class="text-secondary">{{ count }}</span>
						</div>
						<div class="progress" style="height: 6px;">
							<div class="progress-bar bg-{{ csa_status_badges[status] }}" role="progressbar" style="width: {{ 0 if total_status == 0 else (count / total_status * 100) }}%"></div>
						</div>
					</div>
				{% endfor %}
			</div>
		</div>

		<div>
			<div class="csa-quick-card">
				<h2>{{ _('csa.dashboard.latest.title') }}</h2>
				{% if latest_assessments %}
					<ul class="list-unstyled mb-0 small">
						{% for assessment in latest_assessments[:5] %}
						<li class="d-flex justify-content-between align-items-center py-2 border-bottom border-secondary border-opacity-10">
							<div class="text-truncate me-2">
								<div class="fw-medium">{{ assessment.template.control.section if assessment.template.control else '' }} {{ assessment.template.control.domain if assessment.template.control else assessment.template.name }}</div>
								<div class="text-muted" style="font-size: 0.75em;">{{ assessment.updated_at.strftime('%Y-%m-%d') if assessment.updated_at else '' }}</div>
							</div>
							<span class="badge bg-{{ csa_status_badges.get(assessment.status, 'secondary') }}">{{ csa_status_labels.get(assessment.status, assessment.status.value) }}</span>
						</li>
						{% endfor %}
					</ul>
				{% else %}
					<p class="text-secondary mb-0">{{ _('csa.dashboard.latest.empty') }}</p>
				{% endif %}
			</div>
		</div>
	</div>
</div>
{% endblock %}
