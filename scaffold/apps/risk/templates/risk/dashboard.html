{% extends "base.html" %}
{% block title %}{{ _("Risk workspace") }}{% endblock %}
{% block extra_css %}
<style nonce="{{ csp_nonce }}">
:root {
  --risk-accent: #ff7a18;
  --risk-accent-dark: #c44536;
  --risk-sage: #17bebb;
  --risk-ink: #0f172a;
  --risk-rose-600: #be123c;
  --risk-rose-50: #fff1f2;
  --risk-orange-500: #f97316;
  --risk-orange-950: #431407;
  --risk-amber-400: #fbbf24;
  --risk-amber-950: #451a03;
  --risk-emerald-500: #10b981;
  --risk-emerald-50: #ecfdf5;
  --risk-sky-400: #38bdf8;
  --risk-sky-900: #0c4a6e;
}
body[data-theme="dark"] {
  --risk-accent: #ffb347;
  --risk-accent-dark: #ff7a18;
  --risk-sage: #4cc9f0;
}
.text-white-75 {
  color: rgba(255, 255, 255, 0.75) !important;
}
.risk-dashboard {
  display: flex;
  flex-direction: column;
  gap: 2rem;
}
.risk-hero {
  background: radial-gradient(circle at top right, rgba(255, 255, 255, 0.15), transparent 55%),
    linear-gradient(135deg, var(--risk-accent), var(--risk-accent-dark));
  border-radius: 1.5rem;
  padding: clamp(1.5rem, 4vw, 2.5rem);
  color: #fff;
  box-shadow: 0 1.25rem 2.5rem rgba(15, 23, 42, 0.25);
  position: relative;
  overflow: hidden;
}
body[data-theme="dark"] .risk-hero {
  box-shadow: 0 1.5rem 3rem rgba(0, 0, 0, 0.55);
}
.risk-hero__grid {
  .risk-pill {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 999px;
    padding: 0.25rem 0.85rem;
    font-size: 0.72rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    border: 1px solid rgba(148, 163, 184, 0.35);
    background: rgba(15, 23, 42, 0.65);
    color: rgba(226, 232, 240, 0.85);
  }
  body[data-theme="dark"] .risk-pill {
    border-color: rgba(255, 255, 255, 0.25);
  }
  .risk-pill--muted {
    background: rgba(71, 85, 105, 0.35);
    border-color: rgba(100, 116, 139, 0.5);
    color: rgba(226, 232, 240, 0.78);
  }
  .risk-pill--low {
    background: var(--risk-emerald-500);
    border-color: rgba(16, 185, 129, 0.6);
    color: var(--risk-emerald-50);
  }
  .risk-pill--moderate {
    background: var(--risk-amber-400);
    border-color: rgba(251, 191, 36, 0.7);
    color: var(--risk-amber-950);
  }
  .risk-pill--high {
    background: var(--risk-orange-500);
    border-color: rgba(249, 115, 22, 0.7);
    color: var(--risk-orange-950);
  }
  .risk-pill--critical,
  .risk-pill--overdue {
    background: var(--risk-rose-600);
    border-color: rgba(190, 18, 60, 0.7);
    color: var(--risk-rose-50);
  }
  .risk-pill--archived {
    background: rgba(148, 163, 184, 0.3);
    border-color: rgba(148, 163, 184, 0.5);
    color: #fafafa;
  }
  .risk-pill--scheduled {
    background: rgba(56, 189, 248, 0.12);
    border-color: rgba(56, 189, 248, 0.5);
    color: #e0f2fe;
  }
  .risk-pill--component {
    background: rgba(14, 165, 233, 0.15);
    border-color: rgba(14, 165, 233, 0.4);
    color: #bae6fd;
    letter-spacing: 0.05em;
  }
  .risk-pill--control {
    background: rgba(14, 116, 144, 0.35);
    border-color: rgba(8, 47, 73, 0.6);
    color: #cffafe;
    text-transform: none;
    letter-spacing: 0.02em;
  }
  .risk-chip {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 999px;
    border: 1px solid rgba(56, 189, 248, 0.35);
    padding: 0.2rem 0.85rem;
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-weight: 600;
    background: rgba(56, 189, 248, 0.12);
    color: #bae6fd;
  }
  border: 1px solid var(--bs-border-color-translucent);
  padding: 1.5rem;
  display: flex;
  flex-direction: column;
  gap: 1.25rem;
  box-shadow: 0 1.5rem 3rem rgba(15, 23, 42, 0.12);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}
body[data-theme="dark"] .risk-card {
  background: rgba(20, 22, 30, 0.95);
  border-color: rgba(255, 255, 255, 0.08);
  box-shadow: 0 1.5rem 3.25rem rgba(0, 0, 0, 0.6);
}
.risk-card:hover {
  transform: translateY(-6px);
  box-shadow: 0 2rem 3.25rem rgba(15, 23, 42, 0.18);
}
.risk-card__header {
  display: flex;
  justify-content: space-between;
  gap: 1rem;
  align-items: flex-start;
}
.risk-card__score {
  text-align: right;
}
.risk-card__score strong {
  font-size: 2rem;
}
.risk-pill {
  display: inline-flex;
  align-items: center;
  gap: 0.4rem;
  border-radius: 999px;
  padding: 0.25rem 0.85rem;
  font-size: 0.85rem;
  font-weight: 600;
}
.risk-pill--muted {
  background: rgba(148, 163, 184, 0.2);
  color: var(--bs-secondary-color);
}
.risk-pill--low {
  background: rgba(25, 135, 84, 0.15);
  color: #198754;
}
.risk-pill--moderate {
  background: rgba(13, 110, 253, 0.15);
  color: #0d6efd;
}
.risk-pill--high {
  background: rgba(255, 193, 7, 0.18);
  color: #b67200;
}
.risk-pill--critical {
  background: rgba(220, 53, 69, 0.15);
  color: #dc3545;
}
.risk-pill--overdue {
  background: rgba(220, 53, 69, 0.15);
  color: #ff5f6d;
}
.risk-pill--archived {
  background: rgba(71, 85, 105, 0.15);
  color: rgba(71, 85, 105, 0.9);
}
.risk-pill--scheduled {
  background: rgba(23, 190, 187, 0.15);
  color: var(--risk-sage);
}
.risk-card__scale {
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 1rem;
  padding: 0;
  margin: 0;
  list-style: none;
}
.risk-card__scale li {
  border-radius: 1rem;
  padding: 1rem;
  background: rgba(148, 163, 184, 0.12);
}
body[data-theme="dark"] .risk-card__scale li {
  background: rgba(255, 255, 255, 0.05);
}
.risk-card__scale strong {
  display: block;
  font-size: 1.1rem;
}
.risk-chip-group {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
}
.risk-component-list {
  margin: 0;
  padding: 0;
  list-style: none;
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}
.risk-component-list li {
  display: flex;
  justify-content: space-between;
  gap: 1rem;
  padding-bottom: 0.5rem;
  border-bottom: 1px dashed var(--bs-border-color-translucent);
}
.risk-control-card {
  border-radius: 1rem;
  border: 1px solid rgba(255, 255, 255, 0.08);
  padding: 1rem 1.25rem;
  background: rgba(23, 190, 187, 0.08);
}
body[data-theme="dark"] .risk-control-card {
  background: rgba(23, 190, 187, 0.12);
}
.risk-card__actions {
  display: flex;
  gap: 0.75rem;
  flex-wrap: wrap;
}
.risk-card__actions form {
  display: inline;
  margin: 0;
}
.risk-card__actions form button {
  white-space: nowrap;
}
.risk-empty {
  border: 1px dashed rgba(13, 110, 253, 0.4);
  border-radius: 1.25rem;
  padding: 2rem;
  text-align: center;
  background: rgba(13, 110, 253, 0.05);
}
</style>
{% endblock %}
{% block content %}
{% set metrics = metrics or {} %}
{% set risk_cards = risk_cards or [] %}
{% set status_labels = {
  'overdue': _('Overdue treatment'),
  'scheduled': _('Upcoming treatment'),
  'unscheduled': _('No due date'),
  'archived': _('risk.status.archived')
} %}
<div class="risk-dashboard">
  <section class="risk-hero">
    <div class="row g-4 align-items-center">
      <div class="col-12 col-lg-5">
        <p class="text-uppercase small mb-2">{{ _('Live risk posture') }}</p>
        <h1 class="display-6 fw-semibold mb-3">{{ _('Risk workspace') }}</h1>
        <p class="mb-0 text-white-75">{{ _('Review the most recent impact assessments, treatment plans and linked CSA controls from a single pane.') }}</p>
        {% if metrics.recent_update %}
        <p class="small text-white-50 mt-3">{{ _('Last update on {date}').format(date=metrics.recent_update.strftime('%d %b %Y')) }}</p>
        {% endif %}
      </div>
      <div class="col-12 col-lg-7">
        <div class="risk-hero__grid">
          <article class="risk-hero__metric">
            <p class="text-uppercase small mb-1">{{ _('Tracked risks') }}</p>
            <strong>{{ metrics.total or 0 }}</strong>
            <small>{{ _('Total records in scope') }}</small>
          </article>
          <article class="risk-hero__metric">
            <p class="text-uppercase small mb-1">{{ _('High & critical') }}</p>
            <strong>{{ metrics.high or 0 }}</strong>
            <small>{{ _('Severity-driven follow ups') }}</small>
          </article>
          <article class="risk-hero__metric">
            <p class="text-uppercase small mb-1">{{ _('Mitigation tracks') }}</p>
            <strong>{{ metrics.mitigate or 0 }}</strong>
            <small>{{ _('Risks in mitigate treatment') }}</small>
          </article>
          <article class="risk-hero__metric">
            <p class="text-uppercase small mb-1">{{ _('Overdue plans') }}</p>
            <strong>{{ metrics.overdue or 0 }}</strong>
            <small>{{ _('Past due treatment actions') }}</small>
          </article>
        </div>
      </div>
    </div>
  </section>

  <section class="risk-actions">
    <div>
      <h2 class="h4 mb-1">{{ _('Recorded risks') }}</h2>
      <p class="text-secondary mb-0">{{ _('Components impacted: {count}').format(count=metrics.components or 0) }}</p>
    </div>
    <div class="risk-actions__buttons">
      <a class="btn btn-primary" href="{{ url_for('risk.create') }}">{{ _('New risk') }}</a>
      <a class="btn btn-outline-secondary" href="{{ url_for('risk.dashboard') }}#risk-list">{{ _('Refresh view') }}</a>
      {% if current_user.has_role('admin') %}
      <a class="btn btn-outline-warning" href="{{ url_for('admin.risk_thresholds') }}">{{ _('Severity thresholds') }}</a>
      {% endif %}
    </div>
  </section>

  <section id="risk-list">
    {% if risk_cards %}
    <div class="risk-card-grid">
      {% for card in risk_cards %}
      <article class="risk-card" id="risk-{{ card.id }}">
        <header class="risk-card__header">
          <div>
            <div class="risk-pill {{ card.severity_class }}">
              {% if card.severity %}
              {{ _('risk.severity.' + card.severity.value) }}
              {% else %}
              {{ _('Severity pending') }}
              {% endif %}
            </div>
            <div class="d-flex flex-wrap gap-2 mt-2">
              <span class="risk-pill risk-pill--muted">{{ _('risk.treatment.' + card.treatment.value) }}</span>
              <span class="risk-pill {{ card.status_class }}">{{ status_labels.get(card.status, _('No due date')) }}</span>
            </div>
            <h3 class="h5 mt-3 mb-1">{{ card.title }}</h3>
            <p class="text-secondary small mb-0">{{ card.description }}</p>
            {% if card.is_closed %}
            <div class="text-secondary small mt-2">
              {% if card.closed_at %}
              {{ _('risk.status.closed_on').format(date=card.closed_at.strftime('%d %b %Y')) }}
              {% else %}
              {{ _('risk.status.archived') }}
              {% endif %}
            </div>
            {% endif %}
          </div>
          <div class="risk-card__score">
            <small class="text-secondary d-block">{{ _('Score') }}</small>
            <strong>{{ card.score }}</strong>
            {% if card.discovered_on %}
            <div class="small text-secondary">{{ _('Logged {date}').format(date=card.discovered_on.strftime('%d %b %Y')) }}</div>
            {% endif %}
          </div>
        </header>

        <ul class="risk-card__scale">
          <li>
            <small class="text-secondary text-uppercase">{{ _('Impact') }}</small>
            <strong>{{ _('risk.impact.' + card.impact.value) }}</strong>
            <span class="text-secondary small">{{ _('Weight {value}').format(value=card.impact_weight) }}</span>
          </li>
          <li>
            <small class="text-secondary text-uppercase">{{ _('Chance') }}</small>
            <strong>{{ _('risk.chance.' + card.chance.value) }}</strong>
            <span class="text-secondary small">{{ _('Weight {value}').format(value=card.chance_weight) }}</span>
          </li>
        </ul>

        <div>
          <p class="fw-semibold small text-uppercase text-secondary mb-2">{{ _('Impact areas') }}</p>
          <div class="risk-chip-group">
            {% for area in card.impact_areas %}
            <span class="risk-chip">{{ _('risk.impact_area.' + area) }}</span>
            {% else %}
            <span class="text-secondary small">{{ _('No impact areas selected yet.') }}</span>
            {% endfor %}
          </div>
        </div>

        <div>
          <p class="fw-semibold small text-uppercase text-secondary mb-2">{{ _('Linked components') }}</p>
          <ul class="risk-component-list">
            {% for component in card.components %}
            <li>
              <div>
                <strong>{{ component.name }}</strong>
                <div class="text-secondary small">{{ component.context or _('Standalone scope') }}</div>
              </div>
              <span class="risk-pill risk-pill--component">{{ _('Component #{id}').format(id=component.id) }}</span>
            </li>
            {% else %}
            <li class="text-secondary small">{{ _('No components linked to this risk.') }}</li>
            {% endfor %}
          </ul>
        </div>

        <div class="d-flex flex-column flex-md-row gap-3">
          <div class="flex-grow-1">
            <p class="fw-semibold small text-uppercase text-secondary mb-1">{{ _('Treatment plan') }}</p>
            <p class="mb-0">{{ card.treatment_plan or _('No treatment plan documented yet.') }}</p>
          </div>
          <div>
            <p class="fw-semibold small text-uppercase text-secondary mb-1">{{ _('Owner') }}</p>
            {% if card.owner %}
            <div>{{ card.owner.full_name }}</div>
            <div class="text-secondary small">{{ card.owner.email }}</div>
            {% else %}
            <div class="text-secondary">{{ _('Unassigned owner') }}</div>
            {% endif %}
          </div>
        </div>

        <div class="d-flex flex-column flex-md-row gap-3">
          <div>
            <p class="fw-semibold small text-uppercase text-secondary mb-1">{{ _('Treatment due date') }}</p>
            {% if card.treatment_due_date %}
            <div>{{ card.treatment_due_date.strftime('%d %b %Y') }}</div>
            {% else %}
            <div class="text-secondary">{{ _('Not scheduled') }}</div>
            {% endif %}
          </div>
          <div>
            <p class="fw-semibold small text-uppercase text-secondary mb-1">{{ _('Last updated') }}</p>
            {% if card.updated_at %}
            <div>{{ card.updated_at.strftime('%d %b %Y') }}</div>
            {% else %}
            <div class="text-secondary">{{ _('No updates captured yet.') }}</div>
            {% endif %}
          </div>
        </div>

        {% if card.controls %}
        <div class="risk-control-card">
          <p class="fw-semibold small text-uppercase text-secondary mb-1">{{ _('risk.controls.linked') }}</p>
          <div class="d-flex flex-column gap-2">
            {% for control in card.controls %}
            <div class="d-flex flex-wrap justify-content-between gap-2">
              <div>
                <div class="fw-semibold">{{ control.domain }}</div>
                <div class="text-secondary small">{{ control.section }}</div>
              </div>
              <span class="risk-pill risk-pill--control">{{ _('Mitigation anchor') }}</span>
            </div>
            {% if control.description %}
            <p class="mb-0 small text-secondary">{{ control.description }}</p>
            {% endif %}
            {% if not loop.last %}
            <hr class="my-2">
            {% endif %}
            {% endfor %}
          </div>
        </div>
        {% endif %}

        <div>
          <p class="fw-semibold small text-uppercase text-secondary mb-1">{{ _('risk.ticket.label') }}</p>
          {% if card.ticket_url %}
          <a class="link-primary" href="{{ card.ticket_url }}" target="_blank" rel="noopener">{{ _('risk.ticket.open') }}</a>
          <div class="text-secondary small text-break">{{ card.ticket_url }}</div>
          {% else %}
          <div class="text-secondary small">{{ _('risk.ticket.missing') }}</div>
          {% endif %}
        </div>

        <div class="risk-card__actions">
          <a class="btn btn-sm btn-primary" href="{{ url_for('risk.edit', risk_id=card.id) }}">{{ _('Edit risk') }}</a>
          {% if card.ticket_url %}
          <a class="btn btn-sm btn-outline-secondary" href="{{ card.ticket_url }}" target="_blank" rel="noopener">{{ _('risk.actions.view_ticket') }}</a>
          {% endif %}
          {% if api_endpoint_available %}
          <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('risk_api.get_risk', risk_id=card.id) }}" target="_blank" rel="noopener">{{ _('Open API record') }}</a>
          {% endif %}
          {% if card.is_closed %}
          <form method="post" action="{{ url_for('risk.reopen', risk_id=card.id) }}">
            {{ action_form.csrf_token }}
            <button class="btn btn-sm btn-outline-primary" type="submit">{{ _('risk.actions.reopen') }}</button>
          </form>
          {% else %}
          <form method="post" action="{{ url_for('risk.close', risk_id=card.id) }}">
            {{ action_form.csrf_token }}
            <button class="btn btn-sm btn-outline-warning" type="submit">{{ _('risk.actions.close_archive') }}</button>
          </form>
          {% endif %}
          <form method="post" action="{{ url_for('risk.delete', risk_id=card.id) }}" data-risk-delete-form data-confirm="{{ _('risk.actions.delete_confirm') }}">
            {{ action_form.csrf_token }}
            <button class="btn btn-sm btn-outline-danger" type="submit">{{ _('risk.actions.delete') }}</button>
          </form>
        </div>
      </article>
      {% endfor %}
    </div>
    {% else %}
    <div class="risk-empty">
      <h3 class="h5">{{ _('No risks recorded yet.') }}</h3>
      <p class="text-secondary">{{ _('Link a component, capture potential impact and assign a treatment owner to start tracking.') }}</p>
      <a class="btn btn-primary" href="{{ url_for('risk.create') }}">{{ _('Capture the first risk') }}</a>
    </div>
    {% endif %}
  </section>
</div>
{% endblock %}
{% block extra_js %}
<script nonce="{{ csp_nonce }}">
(function () {
  document.addEventListener('submit', function (event) {
    const target = event.target;
    if (!target || !target.matches('[data-risk-delete-form]')) {
      return;
    }
    const message = target.getAttribute('data-confirm');
    if (message && !window.confirm(message)) {
      event.preventDefault();
    }
  });
})();
</script>
{% endblock %}
