{% extends "base.html" %}
{% block title %}Assessment Overview{% endblock %}
{% block content %}
<div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-3 mb-4">
  <div>
    <h1 class="h3 mb-1">Assessment Overview</h1>
    <p class="text-secondary mb-0">Track every assessment, status, and owner from a single overview.</p>
  </div>
  {% if current_user.has_role('admin') or current_user.has_role('manager') %}
  <a class="btn btn-outline-light" href="{{ url_for('csa.start_assessment') }}">Start assessment</a>
  {% endif %}
</div>

{% if year_groups %}
  {% for grouping in year_groups %}
    <section id="year-{{ grouping.year }}" class="mb-5">
      <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between mb-3 gap-3">
        <h2 class="h4 mb-0">{{ grouping.year }}</h2>
        <div class="d-flex flex-wrap gap-2">
          {% for month in grouping.months %}
            <a class="btn btn-sm btn-outline-secondary" href="#year-{{ grouping.year }}-month-{{ '%02d'|format(month.month) }}">
              {{ month.label }} ({{ month.assessments|length }})
            </a>
          {% endfor %}
        </div>
      </div>

      {% for month in grouping.months %}
        <div id="year-{{ grouping.year }}-month-{{ '%02d'|format(month.month) }}" class="mb-4">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <h3 class="h5 mb-0">{{ month.label }} {{ grouping.year }}</h3>
            <span class="badge bg-dark">{{ month.assessments|length }} assessments</span>
          </div>
          <div class="table-responsive">
            <table class="table table-dark table-striped align-middle">
              <thead>
                <tr>
                  <th scope="col">ID</th>
                  <th scope="col">Template</th>
                  <th scope="col">Primary owner</th>
                  <th scope="col">Status</th>
                  <th scope="col">Last update</th>
                  <th scope="col" class="text-end">Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for assessment in month.assessments %}
                  {% set primary_assignment = (assessment.assignments | selectattr('is_primary') | list | first) %}
                  {% set primary_user = primary_assignment.assignee if primary_assignment else None %}
                  <tr>
                    <td>{{ assessment.id }}</td>
                    <td>
                      {% set control = assessment.template.control %}
                      <strong>
                        {% if control %}
                          {{ (control.section ~ ' ' ~ control.domain).strip() or assessment.template.name }}
                        {% else %}
                          {{ assessment.template.name }}
                        {% endif %}
                      </strong>
                      {% if control and control.section %}
                        <div class="text-secondary small">Code: {{ control.section }}</div>
                      {% endif %}
                      {% if control and control.domain %}
                        <div class="text-secondary small">Control: {{ control.domain }}</div>
                      {% endif %}
                      {% if control and control.description %}
                        <div class="text-secondary small">{{ control.description }}</div>
                      {% endif %}
                    </td>
                    <td>
                      {% if primary_user %}
                        {{ primary_user.full_name }}<br>
                        <span class="text-secondary small">{{ primary_user.email }}</span>
                      {% else %}
                        <span class="text-secondary">Unknown</span>
                      {% endif %}
                    </td>
                    <td>
                      {% set label = status_labels.get(assessment.status, assessment.status.value.replace('_', ' ')|title) %}
                      {% set badge = badge_classes.get(assessment.status, 'secondary') %}
                      <span class="badge bg-{{ badge }}">{{ label }}</span>
                    </td>
                    <td>{{ assessment.updated_at or assessment.created_at or 'Unknown' }}</td>
                    <td class="text-end">
                      <div class="d-inline-flex flex-wrap justify-content-end gap-2">
                        <a class="btn btn-sm btn-outline-light" href="{{ url_for('csa.view_assessment', assessment_id=assessment.id) }}">View</a>
                        <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('csa.export_assessment', assessment_id=assessment.id) }}">Export</a>
                      </div>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      {% endfor %}
    </section>
  {% endfor %}
{% else %}
  <div class="alert alert-info">No assessments available yet.</div>
{% endif %}
{% endblock %}
