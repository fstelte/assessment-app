{% extends "base.html" %}
{% block title %}{{ _('csa.assessments.overview.title') }}{% endblock %}
{% block content %}
<div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-3 mb-4">
  <div>
    <h1 class="h3 mb-1">{{ _('csa.assessments.overview.heading') }}</h1>
    <p class="text-secondary mb-0">{{ _('csa.assessments.overview.intro') }}</p>
  </div>
  {% if current_user.has_role('admin') or current_user.has_role('manager') %}
  <a class="btn btn-outline-light" href="{{ url_for('csa.start_assessment') }}">{{ _('csa.assessments.overview.start_button') }}</a>
  {% endif %}
</div>

{% if year_groups %}
  {% for grouping in year_groups %}
    <section id="year-{{ grouping.year }}" class="mb-5">
      <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between mb-3 gap-3">
        <h2 class="h4 mb-0">{{ grouping.year }}</h2>
        <div class="d-flex flex-wrap gap-2">
          {% for month in grouping.months %}
            <a class="btn btn-sm btn-outline-secondary" href="#year-{{ grouping.year }}-month-{{ '%02d'|format(month.month) }}">
              {{ month.label }} ({{ month.assessments|length }})
            </a>
          {% endfor %}
        </div>
      </div>

      {% for month in grouping.months %}
        <div id="year-{{ grouping.year }}-month-{{ '%02d'|format(month.month) }}" class="mb-4">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <h3 class="h5 mb-0">{{ month.label }} {{ grouping.year }}</h3>
            <span class="badge bg-dark">{{ _('csa.assessments.overview.count_badge', count=month.assessments|length) }}</span>
          </div>
          <div class="table-responsive">
            <table class="table table-dark table-striped align-middle">
              <thead>
                <tr>
                  <th scope="col">{{ _('csa.assessments.overview.table.id') }}</th>
                  <th scope="col">{{ _('csa.assessments.overview.table.template') }}</th>
                  <th scope="col">{{ _('csa.assessments.overview.table.primary_owner') }}</th>
                  <th scope="col">{{ _('csa.assessments.overview.table.status') }}</th>
                  <th scope="col">{{ _('csa.assessments.overview.table.last_update') }}</th>
                  <th scope="col" class="text-end">{{ _('csa.assessments.overview.table.actions') }}</th>
                </tr>
              </thead>
              <tbody>
                {% for assessment in month.assessments %}
                  {% set primary_assignment = (assessment.assignments | selectattr('is_primary') | list | first) %}
                  {% set primary_user = primary_assignment.assignee if primary_assignment else None %}
                  <tr>
                    <td>{{ assessment.id }}</td>
                    <td>
                      {% set control = assessment.template.control %}
                      <strong>
                        {% if control %}
                          {{ (control.section ~ ' ' ~ control.domain).strip() or assessment.template.name }}
                        {% else %}
                          {{ assessment.template.name }}
                        {% endif %}
                      </strong>
                      {% if control and control.section %}
                        <div class="text-secondary small">{{ _('csa.assessments.common.code_label') }} {{ control.section }}</div>
                      {% endif %}
                      {% if control and control.domain %}
                        <div class="text-secondary small">{{ _('csa.assessments.common.control_label') }} {{ control.domain }}</div>
                      {% endif %}
                      {% if control and control.description %}
                        <div class="text-secondary small">{{ control.description }}</div>
                      {% endif %}
                    </td>
                    <td>
                      {% if primary_user %}
                        {{ primary_user.full_name }}<br>
                        <span class="text-secondary small">{{ primary_user.email }}</span>
                      {% else %}
                        <span class="text-secondary">{{ _('csa.common.unknown') }}</span>
                      {% endif %}
                    </td>
                    <td>
                      {% set label = status_labels.get(assessment.status, assessment.status.value.replace('_', ' ')|title) %}
                      {% set badge = badge_classes.get(assessment.status, 'secondary') %}
                      <span class="badge bg-{{ badge }}">{{ label }}</span>
                    </td>
                    <td>{{ assessment.updated_at or assessment.created_at or _('csa.common.unknown') }}</td>
                    <td class="text-end">
                      <div class="d-inline-flex flex-wrap justify-content-end gap-2">
                        <a class="btn btn-sm btn-outline-light" href="{{ url_for('csa.view_assessment', assessment_id=assessment.id) }}">{{ _('actions.view') }}</a>
                        <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('csa.export_assessment', assessment_id=assessment.id) }}">{{ _('actions.export') }}</a>
                        {% if current_user.has_role('admin') or current_user.has_role('manager') %}
                          <form method="post" action="{{ url_for('csa.delete_assessment', assessment_id=assessment.id) }}" class="d-inline">
                            {% if csrf_token is defined %}{{ csrf_token() }}{% endif %}
                            <button type="submit" class="btn btn-sm btn-outline-danger">{{ _('actions.delete') }}</button>
                          </form>
                        {% endif %}
                      </div>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      {% endfor %}
    </section>
  {% endfor %}
{% else %}
  <div class="alert alert-info">{{ _('csa.assessments.overview.empty') }}</div>
{% endif %}
{% endblock %}
