{% extends "base.html" %}
{% block title %}{{ _('bia.manage_availability.title') }} | {{ item.name }}{% endblock %}
{% block content %}
<div class="mb-4">
  <a href="{{ url_for('bia.view_item', item_id=item.id) }}" class="text-[var(--color-muted)] hover:text-[var(--color-text)] no-underline flex items-center gap-1">
    <span>&larr;</span> {{ _('bia.manage_availability.back') }}
  </a>
</div>

<div class="flex flex-wrap -mx-3 items-start">
  <div class="w-full lg:w-1/3 px-3 mb-6 lg:mb-0">
    <div class="bg-[var(--color-card)] border border-[var(--color-border)] rounded-xl shadow-card h-full">
      <div class="px-5 py-4 border-b border-[var(--color-border)] flex justify-between items-center bg-[var(--color-surface)] rounded-t-xl">
        <span class="font-bold text-sm uppercase tracking-wide text-[var(--color-muted)]">{{ _('bia.manage_availability.title') }}</span>
        <span class="inline-flex items-center text-xs font-semibold uppercase tracking-wide rounded-full px-3 py-0.5 bg-primary-100 text-primary-800 dark:bg-primary-900/30 dark:text-primary-300">{{ selected_component.name }}</span>
      </div>
      <div class="p-5">
        <form method="post" class="flex flex-col gap-4">
          {{ form.hidden_tag() }}
          <div>
            {{ form.component_id.label(class="block text-sm font-medium mb-1.5 text-[var(--color-text)]") }}
            {{ form.component_id(class="w-full bg-[var(--color-surface)] border border-[var(--color-border)] rounded-lg px-3.5 py-2.5 text-[var(--color-text)] transition focus:outline-none focus:border-primary-500 focus:ring-2 focus:ring-primary-500/30", data_component_switch=url_for('bia.manage_item_availability', item_id=item.id)) }}
            <div class="text-xs text-[var(--color-muted)] mt-1 flex items-start gap-1">
              <i class="fas fa-info-circle mt-0.5"></i>
              <span>Switching components reloads this page with their current targets.</span>
            </div>
            {% if form.component_id.errors %}
              <div class="text-xs mt-1 text-red-500">{{ form.component_id.errors | join(', ') }}</div>
            {% endif %}
          </div>
          <div>
            {{ form.mtd.label(class="block text-sm font-medium mb-1.5 text-[var(--color-text)]") }}
            {{ form.mtd(class="w-full bg-[var(--color-surface)] border border-[var(--color-border)] rounded-lg px-3.5 py-2.5 text-[var(--color-text)] transition focus:outline-none focus:border-primary-500 focus:ring-2 focus:ring-primary-500/30", placeholder="e.g. 24 hours") }}
            {% if form.mtd.errors %}
              <div class="text-xs mt-1 text-red-500">{{ form.mtd.errors | join(', ') }}</div>
            {% endif %}
          </div>
          <div>
            {{ form.rto.label(class="block text-sm font-medium mb-1.5 text-[var(--color-text)]") }}
            {{ form.rto(class="w-full bg-[var(--color-surface)] border border-[var(--color-border)] rounded-lg px-3.5 py-2.5 text-[var(--color-text)] transition focus:outline-none focus:border-primary-500 focus:ring-2 focus:ring-primary-500/30", placeholder="e.g. 8 hours") }}
            {% if form.rto.errors %}
              <div class="text-xs mt-1 text-red-500">{{ form.rto.errors | join(', ') }}</div>
            {% endif %}
          </div>
          <div>
            {{ form.rpo.label(class="block text-sm font-medium mb-1.5 text-[var(--color-text)]") }}
            {{ form.rpo(class="w-full bg-[var(--color-surface)] border border-[var(--color-border)] rounded-lg px-3.5 py-2.5 text-[var(--color-text)] transition focus:outline-none focus:border-primary-500 focus:ring-2 focus:ring-primary-500/30", placeholder="e.g. 30 minutes") }}
            {% if form.rpo.errors %}
              <div class="text-xs mt-1 text-red-500">{{ form.rpo.errors | join(', ') }}</div>
            {% endif %}
          </div>
          <div>
            {{ form.masl.label(class="block text-sm font-medium mb-1.5 text-[var(--color-text)]") }}
            {{ form.masl(class="w-full bg-[var(--color-surface)] border border-[var(--color-border)] rounded-lg px-3.5 py-2.5 text-[var(--color-text)] transition focus:outline-none focus:border-primary-500 focus:ring-2 focus:ring-primary-500/30", placeholder="Describe the minimum acceptable service level") }}
            {% if form.masl.errors %}
              <div class="text-xs mt-1 text-red-500">{{ form.masl.errors | join(', ') }}</div>
            {% endif %}
          </div>
          <div class="flex justify-end gap-3 pt-2 mt-2 border-t border-[var(--color-border)]">
            <a href="{{ url_for('bia.view_item', item_id=item.id) }}" class="inline-flex items-center justify-center font-medium rounded-md px-4 py-2 text-sm transition-colors border border-transparent border-[var(--color-border)] text-[var(--color-muted)] hover:bg-slate-500/10">{{ _('bia.actions.cancel') }}</a>
            {{ form.submit(class="inline-flex items-center justify-center font-medium rounded-md px-4 py-2 text-sm transition-colors border border-transparent bg-primary-600 text-white hover:bg-primary-700 shadow-sm cursor-pointer") }}
          </div>
        </form>
      </div>
    </div>
  </div>
  <div class="w-full lg:w-2/3 px-3">
    <div class="bg-[var(--color-card)] border border-[var(--color-border)] rounded-xl shadow-card h-full">
      <div class="px-5 py-4 border-b border-[var(--color-border)] bg-[var(--color-surface)] rounded-t-xl">
        <h3 class="font-bold text-sm uppercase tracking-wide text-[var(--color-muted)] mb-0">{{ _('bia.manage_availability.sections.current_targets') }}</h3>
      </div>
      <div class="p-0">
        <div class="overflow-x-auto w-full rounded-b-xl">
          <table class="w-full text-sm border-collapse bg-[var(--color-card)] align-middle mb-0">
            <thead class="bg-[var(--color-surface)] border-b border-[var(--color-border)]">
              <tr>
                <th scope="col" class="px-4 py-3 text-left font-semibold text-[var(--color-text)] w-1/4">{{ _('bia.manage_availability.table.component') }}</th>
                <th scope="col" class="px-4 py-3 text-left font-semibold text-[var(--color-text)]">{{ _('bia.manage_availability.table.mtd') }}</th>
                <th scope="col" class="px-4 py-3 text-left font-semibold text-[var(--color-text)]">{{ _('bia.manage_availability.table.rto') }}</th>
                <th scope="col" class="px-4 py-3 text-left font-semibold text-[var(--color-text)]">{{ _('bia.manage_availability.table.rpo') }}</th>
                <th scope="col" class="px-4 py-3 text-left font-semibold text-[var(--color-text)]">{{ _('bia.manage_availability.table.masl') }}</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-[var(--color-border)]">
              {% for row in availability_rows %}
              <tr class="hover:bg-[var(--color-surface-hover)] transition-colors {{ 'bg-[var(--color-surface)]/50' if row.component.id == selected_component.id }}">
                <td class="px-4 py-3 font-medium text-[var(--color-text)]">
                  {{ row.component.name }}
                  {% if row.component.id == selected_component.id %}
                    <span class="ml-2 inline-block w-2 h-2 rounded-full bg-primary-500"></span>
                  {% endif %}
                </td>
                <td class="px-4 py-3 text-[var(--color-muted)]">{{ row.requirement.mtd if row.requirement else _('bia.manage_availability.empty.not_set') }}</td>
                <td class="px-4 py-3 text-[var(--color-muted)]">{{ row.requirement.rto if row.requirement else _('bia.manage_availability.empty.not_set') }}</td>
                <td class="px-4 py-3 text-[var(--color-muted)]">{{ row.requirement.rpo if row.requirement else _('bia.manage_availability.empty.not_set') }}</td>
                <td class="px-4 py-3 text-[var(--color-muted)] truncate max-w-xs" title="{{ row.requirement.masl if row.requirement else '' }}">{{ row.requirement.masl if row.requirement else _('bia.manage_availability.empty.not_set') }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
{{ super() }}
<script nonce="{{ csp_nonce }}">
(function () {
  const select = document.querySelector('[data-component-switch]');
  if (!select) {
    return;
  }
  select.addEventListener('change', () => {
    const baseUrl = select.getAttribute('data-component-switch');
    if (!baseUrl || !select.value) {
      return;
    }
    const target = new URL(baseUrl, window.location.origin);
    target.searchParams.set('component_id', select.value);
    window.location = target.toString();
  });
})();
</script>
{% endblock %}
