{% extends "base.html" %}
{% block title %}{{ _('csa.dashboard.title') }}{% endblock %}
{% block content %}
{% set can_manage_assignments = current_user.has_role('admin') or current_user.has_role('manager') %}
<div class="card bg-dark border-secondary mb-4">
	<div class="card-body d-flex flex-column flex-lg-row align-items-start align-items-lg-center gap-3">
		<div class="flex-grow-1">
			<p class="text-uppercase text-secondary small mb-1">{{ _('csa.dashboard.title') }}</p>
			<h1 class="mb-2">{{ _('csa.dashboard.heading') }}</h1>
			<p class="text-secondary mb-0">{{ _('csa.dashboard.lead') }}</p>
		</div>
		<div class="d-flex flex-wrap gap-2 w-100 w-lg-auto">
			<a class="btn btn-primary flex-fill flex-lg-grow-0" href="{{ url_for('csa.start_assessment') }}">{{ _('csa.dashboard.quick_actions.start') }}</a>
			{% if can_manage_assignments %}
			<a class="btn btn-outline-light flex-fill flex-lg-grow-0" href="{{ url_for('csa.assign_assessment') }}">{{ _('csa.dashboard.quick_actions.assign') }}</a>
			<a class="btn btn-outline-light flex-fill flex-lg-grow-0" href="{{ url_for('csa.overview_assessments') }}">{{ _('csa.dashboard.quick_actions.overview') }}</a>
			{% endif %}
			{% if current_user.has_role('admin') %}
			<a class="btn btn-warning flex-fill flex-lg-grow-0" href="{{ url_for('csa.import_controls') }}">{{ _('csa.dashboard.quick_actions.import_controls') }}</a>
			{% endif %}
		</div>
	</div>
</div>

<div class="row g-3">
	<div class="col-12 col-lg-4">
		<div class="card bg-dark border-secondary h-100">
			<div class="card-body">
				<p class="text-secondary text-uppercase small mb-1">{{ _('csa.dashboard.cards.assessments.title') }}</p>
				<div class="d-flex justify-content-between align-items-end">
					<span class="display-6">{{ assessment_count }}</span>
					<span class="text-secondary small">{{ _('csa.dashboard.cards.assessments.description') }}</span>
				</div>
			</div>
		</div>
	</div>
	<div class="col-12 col-lg-4">
		<div class="card bg-dark border-secondary h-100">
			<div class="card-body">
				<p class="text-secondary text-uppercase small mb-1">{{ _('csa.dashboard.cards.controls.title') }}</p>
				<div class="d-flex justify-content-between align-items-end">
					<span class="display-6">{{ control_count }}</span>
					<span class="text-secondary small">{{ _('csa.dashboard.cards.controls.description') }}</span>
				</div>
			</div>
		</div>
	</div>
	<div class="col-12 col-lg-4">
		<div class="card bg-dark border-secondary h-100">
			<div class="card-body">
				<p class="text-secondary text-uppercase small mb-1">{{ _('csa.dashboard.cards.workflow.title') }}</p>
				{% set total_status = status_totals.values() | sum %}
				{% for status, label in csa_status_labels.items() %}
					{% set count = status_totals[status] or 0 %}
					<div class="mb-2">
						<div class="d-flex justify-content-between small">
							<span>{{ label }}</span>
							<span class="text-secondary">{{ count }}</span>
						</div>
						<div class="progress" style="height: 6px;">
							<div class="progress-bar bg-{{ csa_status_badges[status] }}" role="progressbar" style="width: {{ 0 if total_status == 0 else (count / total_status * 100) }}%"></div>
						</div>
					</div>
				{% endfor %}
			</div>
		</div>
	</div>
	<div class="col-12 col-xl-4">
		<div class="card bg-dark border-secondary h-100">
			<div class="card-body">
				<p class="text-secondary text-uppercase small mb-1">{{ _('csa.dashboard.latest.title') }}</p>
				{% if latest_assessments %}
					<ul class="list-unstyled mb-0 small">
						{% for assessment in latest_assessments[:4] %}
						<li class="d-flex justify-content-between align-items-center py-1">
							<span class="text-truncate me-2">{{ assessment.template.control.section if assessment.template.control else '' }} {{ assessment.template.control.domain if assessment.template.control else assessment.template.name }}</span>
							<span class="badge bg-{{ csa_status_badges.get(assessment.status, 'secondary') }}">{{ csa_status_labels.get(assessment.status, assessment.status.value) }}</span>
						</li>
						{% endfor %}
					</ul>
				{% else %}
					<p class="text-secondary mb-0">{{ _('csa.dashboard.latest.empty') }}</p>
				{% endif %}
			</div>
		</div>
	</div>
</div>

<div class="row g-3 mt-2">
	<div class="col-12 col-xl-7">
		<div class="card bg-dark border-secondary h-100">
			<div class="card-header border-secondary d-flex justify-content-between align-items-center">
				<span>{{ _('csa.dashboard.latest.title') }}</span>
				<a href="{{ url_for('csa.overview_assessments') }}" class="btn btn-sm btn-outline-light">{{ _('csa.dashboard.quick_actions.overview') }}</a>
			</div>
			<div class="card-body p-0">
				{% if latest_assessments %}
					<div class="table-responsive">
						<table class="table table-dark table-hover mb-0 align-middle">
							<thead>
								<tr>
									<th scope="col">{{ _('csa.dashboard.latest.title') }}</th>
									<th scope="col" class="text-center">{{ _('csa.dashboard.cards.workflow.title') }}</th>
									<th scope="col" class="text-end">{{ _('csa.dashboard.latest.updated', timestamp='') }}</th>
								</tr>
							</thead>
							<tbody>
								{% for assessment in latest_assessments %}
								<tr>
									<td>
										<a class="text-decoration-none text-light" href="{{ url_for('csa.view_assessment', assessment_id=assessment.id) }}">
											<div class="fw-semibold">{{ assessment.template.control.section if assessment.template.control else '' }} {{ assessment.template.control.domain if assessment.template.control else assessment.template.name }}</div>
											<div class="text-secondary small">{{ _('csa.dashboard.latest.assessment_number', id=assessment.id) }}</div>
										</a>
									</td>
									<td class="text-center">
										<span class="badge bg-{{ csa_status_badges.get(assessment.status, 'secondary') }}">{{ csa_status_labels.get(assessment.status, assessment.status.value) }}</span>
									</td>
									<td class="text-end text-secondary small">
										{% set updated_at = assessment.updated_at or assessment.created_at or _('csa.common.unknown') %}
										{{ _('csa.dashboard.latest.updated', timestamp=updated_at) }}
									</td>
								</tr>
								{% endfor %}
							</tbody>
						</table>
					</div>
				{% else %}
					<div class="p-4 text-secondary">{{ _('csa.dashboard.latest.empty') }}</div>
				{% endif %}
			</div>
		</div>
	</div>
	<div class="col-12 col-xl-5">
		<div class="card bg-dark border-secondary h-100">
			<div class="card-header border-secondary">{{ _('csa.dashboard.quick_actions.title') }}</div>
			<div class="card-body">
				<div class="d-flex flex-column gap-3">
					<div>
						<p class="text-secondary text-uppercase small mb-1">{{ _('csa.dashboard.cards.workflow.title') }}</p>
						<ul class="list-unstyled mb-0">
							{% for status, label in csa_status_labels.items() %}
							<li class="d-flex justify-content-between align-items-center py-1 border-bottom border-secondary-subtle">
								<span>{{ label }}</span>
								<span class="badge bg-{{ csa_status_badges[status] }}">{{ status_totals[status] or 0 }}</span>
							</li>
							{% endfor %}
						</ul>
					</div>
					<div class="d-flex flex-wrap gap-2">
						<a class="btn btn-outline-light flex-fill" href="{{ url_for('csa.start_assessment') }}">{{ _('csa.dashboard.quick_actions.start') }}</a>
						{% if can_manage_assignments %}
						<a class="btn btn-outline-light flex-fill" href="{{ url_for('csa.assign_assessment') }}">{{ _('csa.dashboard.quick_actions.assign') }}</a>
						<a class="btn btn-outline-light flex-fill" href="{{ url_for('csa.overview_assessments') }}">{{ _('csa.dashboard.quick_actions.overview') }}</a>
						{% endif %}
						{% if current_user.has_role('admin') %}
						<a class="btn btn-warning flex-fill" href="{{ url_for('csa.import_controls') }}">{{ _('csa.dashboard.quick_actions.import_controls') }}</a>
						{% endif %}
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
{% endblock %}
