{% extends "base.html" %}
{% block title %}Consequences | {{ component.name }}{% endblock %}
{% block content %}
{% set csrf_field = consequence_form.csrf_token %}
{% set csrf_value = csrf_field._value() if csrf_field else '' %}
<input type="hidden" id="csrf-token" value="{{ csrf_value }}">
<div class="mb-3">
  <a href="{{ url_for('bia.view_components') }}" class="text-secondary text-decoration-none">&larr; Back to components</a>
</div>

<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h3 mb-0">Consequences for {{ component.name }}</h1>
  <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addConsequenceModal">Add consequence</button>
</div>

<div class="card bg-dark border-secondary">
  <div class="card-body p-0">
    {% if consequences %}
    <div class="table-responsive">
      <table class="table table-dark table-striped align-middle mb-0">
        <thead>
          <tr>
            <th scope="col">Category</th>
            <th scope="col">Security property</th>
            <th scope="col">Worst case</th>
            <th scope="col">Realistic case</th>
            <th scope="col">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for consequence in consequences %}
          <tr>
            <td>{{ consequence.consequence_category }}</td>
            <td class="text-uppercase">{{ consequence.security_property }}</td>
            <td>
              <span class="badge {{ bia_get_impact_color(consequence.consequence_worstcase) if consequence.consequence_worstcase else 'text-bg-secondary' }} text-capitalize">{{ consequence.consequence_worstcase or 'N/A' }}</span>
              {% if consequence.justification_worstcase %}
                <div class="small text-secondary">{{ consequence.justification_worstcase }}</div>
              {% endif %}
            </td>
            <td>
              <span class="badge {{ bia_get_impact_color(consequence.consequence_realisticcase) if consequence.consequence_realisticcase else 'text-bg-secondary' }} text-capitalize">{{ consequence.consequence_realisticcase or 'N/A' }}</span>
              {% if consequence.justification_realisticcase %}
                <div class="small text-secondary">{{ consequence.justification_realisticcase }}</div>
              {% endif %}
            </td>
            <td>
              <div class="d-flex gap-2">
                <button class="btn btn-outline-light btn-sm" data-edit-consequence data-edit-url="{{ url_for('bia.get_consequence', consequence_id=consequence.id) }}" data-update-url="{{ url_for('bia.edit_consequence', consequence_id=consequence.id) }}">Edit</button>
                <button class="btn btn-outline-danger btn-sm" data-delete-consequence data-delete-url="{{ url_for('bia.delete_consequence', consequence_id=consequence.id) }}">Delete</button>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
      <p class="p-4 mb-0 text-secondary">No consequences recorded for this component yet.</p>
    {% endif %}
  </div>
</div>

<!-- Add consequence modal -->
<div class="modal fade" id="addConsequenceModal" tabindex="-1" aria-labelledby="addConsequenceLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content bg-dark border-secondary">
      <div class="modal-header border-secondary">
        <h2 class="modal-title h5" id="addConsequenceLabel">Add consequence</h2>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="add-consequence-form" class="vstack gap-3">
          {{ csrf_field if csrf_field else '' }}
          <div>
            {{ consequence_form.consequence_category.label(class="form-label") }}
            {{ consequence_form.consequence_category(class="form-select", multiple=true) }}
            <div class="form-text text-secondary">Select one or more consequence categories.</div>
          </div>
          <div class="row g-3">
            <div class="col-md-6">
              {{ consequence_form.security_property.label(class="form-label") }}
              {{ consequence_form.security_property(class="form-select text-capitalize") }}
            </div>
            <div class="col-md-6">
              {{ consequence_form.consequence_worstcase.label(class="form-label") }}
              {{ consequence_form.consequence_worstcase(class="form-select text-capitalize") }}
            </div>
          </div>
          <div>
            {{ consequence_form.justification_worstcase.label(class="form-label") }}
            {{ consequence_form.justification_worstcase(class="form-control", rows=2) }}
          </div>
          <div class="row g-3">
            <div class="col-md-6">
              {{ consequence_form.consequence_realisticcase.label(class="form-label") }}
              {{ consequence_form.consequence_realisticcase(class="form-select text-capitalize") }}
            </div>
            <div class="col-md-6">
              {{ consequence_form.justification_realisticcase.label(class="form-label") }}
              {{ consequence_form.justification_realisticcase(class="form-control", rows=2) }}
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer border-secondary">
        <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" data-submit-add>Save consequence(s)</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit consequence modal -->
<div class="modal fade" id="editConsequenceModal" tabindex="-1" aria-labelledby="editConsequenceLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content bg-dark border-secondary">
      <div class="modal-header border-secondary">
        <h2 class="modal-title h5" id="editConsequenceLabel">Edit consequence</h2>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="edit-consequence-form" class="vstack gap-3">
          <input type="hidden" name="csrf_token" value="{{ csrf_value }}">
          <input type="hidden" name="update_url" value="">
          <div>
            <label class="form-label" for="edit-consequence-category">Consequence category</label>
            <select id="edit-consequence-category" name="consequence_category" class="form-select">
              {% for value, label in consequence_form.consequence_category.choices %}
                <option value="{{ value }}">{{ label }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label" for="edit-security-property">Security property</label>
              <select id="edit-security-property" name="security_property" class="form-select text-capitalize">
                {% for value, label in consequence_form.security_property.choices %}
                  <option value="{{ value }}">{{ label }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label" for="edit-consequence-worstcase">Worst case</label>
              <select id="edit-consequence-worstcase" name="consequence_worstcase" class="form-select text-capitalize">
                {% for value, label in consequence_form.consequence_worstcase.choices %}
                  <option value="{{ value }}">{{ label }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div>
            <label class="form-label" for="edit-justification-worstcase">Justification (worst case)</label>
            <textarea id="edit-justification-worstcase" name="justification_worstcase" class="form-control" rows="2"></textarea>
          </div>
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label" for="edit-consequence-realisticcase">Realistic case</label>
              <select id="edit-consequence-realisticcase" name="consequence_realisticcase" class="form-select text-capitalize">
                {% for value, label in consequence_form.consequence_realisticcase.choices %}
                  <option value="{{ value }}">{{ label }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label" for="edit-justification-realisticcase">Justification (realistic)</label>
              <textarea id="edit-justification-realisticcase" name="justification_realisticcase" class="form-control" rows="2"></textarea>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer border-secondary">
        <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" data-submit-edit>Save changes</button>
      </div>
    </div>
  </div>
</div>

<script nonce="{{ csp_nonce }}">
document.addEventListener('DOMContentLoaded', () => {
  const bootstrapLib = window.bootstrap;
  if (!bootstrapLib) {
    console.error('Bootstrap library not available; consequence modals inactive.');
    return;
  }

  const csrfTokenInput = document.getElementById('csrf-token');
  const csrfToken = csrfTokenInput ? csrfTokenInput.value : '';
  const addEndpoint = "{{ url_for('bia.add_consequence', component_id=component.id) }}";
  const addModalElement = document.getElementById('addConsequenceModal');
  const editModalElement = document.getElementById('editConsequenceModal');
  const addModal = addModalElement ? new bootstrapLib.Modal(addModalElement) : null;
  const editModal = editModalElement ? new bootstrapLib.Modal(editModalElement) : null;
  const addForm = document.getElementById('add-consequence-form');
  const editForm = document.getElementById('edit-consequence-form');

  const resetForm = (form) => {
    if (!form) {
      return;
    }
    form.reset();
  };

  addModalElement?.addEventListener('hidden.bs.modal', () => resetForm(addForm));
  editModalElement?.addEventListener('hidden.bs.modal', () => resetForm(editForm));

  const collectFormValues = (form) => Object.fromEntries(new FormData(form));

  const handleAdd = () => {
    if (!addForm) {
      return;
    }
    const data = collectFormValues(addForm);
    const categorySelect = addForm.querySelector('select[name="consequence_category"]');
    const categories = categorySelect ? Array.from(categorySelect.selectedOptions).map((option) => option.value) : [];
    if (!categories.length) {
      window.alert('Select at least one consequence category.');
      return;
    }
    data.consequence_category = categories;
    fetch(addEndpoint, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken,
      },
      body: JSON.stringify(data),
    })
      .then((response) => response.json())
      .then((result) => {
        if (result.success) {
          addModal?.hide();
          window.location.reload();
        } else {
          window.alert('Unable to add consequence: ' + JSON.stringify(result.errors));
        }
      })
      .catch(() => window.alert('Failed to add consequence.'));
  };

  const handleEditSave = () => {
    if (!editForm) {
      return;
    }
    const payload = collectFormValues(editForm);
    const updateUrl = payload.update_url;
    if (!updateUrl) {
      window.alert('Update endpoint missing.');
      return;
    }
    delete payload.update_url;
    fetch(updateUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken,
      },
      body: JSON.stringify(payload),
    })
      .then((response) => response.json())
      .then((result) => {
        if (result.success) {
          editModal?.hide();
          window.location.reload();
        } else {
          window.alert('Unable to update consequence: ' + JSON.stringify(result.errors));
        }
      })
      .catch(() => window.alert('Failed to update consequence.'));
  };

  const hydrateEditForm = (data, updateUrl) => {
    if (!editForm) {
      return;
    }
    editForm.querySelector('input[name="update_url"]').value = updateUrl;
    editForm.querySelector('#edit-consequence-category').value = data.consequence_category;
    editForm.querySelector('#edit-security-property').value = (data.security_property || '').toLowerCase();
    editForm.querySelector('#edit-consequence-worstcase').value = data.consequence_worstcase;
    editForm.querySelector('#edit-justification-worstcase').value = data.justification_worstcase || '';
    editForm.querySelector('#edit-consequence-realisticcase').value = data.consequence_realisticcase;
    editForm.querySelector('#edit-justification-realisticcase').value = data.justification_realisticcase || '';
  };

  const handleEditClick = (event) => {
    const button = event.currentTarget;
    const getUrl = button.getAttribute('data-edit-url');
    const updateUrl = button.getAttribute('data-update-url');
    if (!getUrl || !updateUrl || !editForm) {
      return;
    }
    fetch(getUrl)
      .then((response) => {
        if (!response.ok) {
          throw new Error('Lookup failed');
        }
        return response.json();
      })
      .then((data) => {
        hydrateEditForm(data, updateUrl);
        editModal?.show();
      })
      .catch(() => window.alert('Failed to load the selected consequence.'));
  };

  const handleDeleteClick = (event) => {
    if (!window.confirm('Delete this consequence?')) {
      return;
    }
    const button = event.currentTarget;
    const deleteUrl = button.getAttribute('data-delete-url');
    if (!deleteUrl) {
      return;
    }
    const formData = new FormData();
    formData.append('csrf_token', csrfToken);
    fetch(deleteUrl, {
      method: 'POST',
      body: formData,
    })
      .then((response) => response.json())
      .then((result) => {
        if (result.success) {
          window.location.reload();
        } else {
          window.alert('Could not delete the consequence.');
        }
      })
      .catch(() => window.alert('Failed to delete consequence.'));
  };

  document.querySelector('[data-submit-add]')?.addEventListener('click', handleAdd);
  document.querySelector('[data-submit-edit]')?.addEventListener('click', handleEditSave);
  document.querySelectorAll('[data-edit-consequence]').forEach((button) => {
    button.addEventListener('click', handleEditClick);
  });
  document.querySelectorAll('[data-delete-consequence]').forEach((button) => {
    button.addEventListener('click', handleDeleteClick);
  });
});
</script>
{% endblock %}
