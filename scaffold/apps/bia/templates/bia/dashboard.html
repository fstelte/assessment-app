{% extends "base.html" %}
{% block title %}{{ _('bia.dashboard.title') }}{% endblock %}
{% block extra_css %}
<style nonce="{{ csp_nonce }}">
.bia-dashboard {
	display: flex;
	flex-direction: column;
	gap: 2rem;
}
.bia-dashboard-hero {
	background: linear-gradient(130deg, rgba(13, 110, 253, 0.95), rgba(111, 66, 193, 0.95));
	border-radius: 1.5rem;
	padding: clamp(1.75rem, 4vw, 2.5rem);
	box-shadow: 0 1.25rem 3rem rgba(15, 23, 42, 0.25);
	color: #fff;
	position: relative;
	overflow: hidden;
}
body[data-theme="dark"] .bia-dashboard-hero {
	background: linear-gradient(130deg, rgba(13, 110, 253, 0.6), rgba(111, 66, 193, 0.7));
	box-shadow: 0 1rem 2.5rem rgba(0, 0, 0, 0.45);
	border: 1px solid rgba(255, 255, 255, 0.08);
}
.bia-dashboard-hero::after {
	content: "";
	position: absolute;
	width: 320px;
	height: 320px;
	background: radial-gradient(circle, rgba(255, 255, 255, 0.2), transparent 65%);
	right: -80px;
	top: -60px;
	filter: blur(4px);
}
.bia-dashboard-hero__body {
	position: relative;
	z-index: 1;
}
.bia-dashboard-hero__metrics {
	display: grid;
	grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
	gap: 1.25rem;
	margin-top: 1.5rem;
}
.bia-dashboard-hero__metric {
	background: rgba(255, 255, 255, 0.08);
	border-radius: 1rem;
	padding: 1rem 1.25rem;
	backdrop-filter: blur(6px);
}
.bia-dashboard-hero__metric strong {
	font-size: clamp(1.5rem, 4vw, 2.5rem);
	line-height: 1;
}
.bia-dashboard-hero__metric small {
	color: rgba(255, 255, 255, 0.8);
}
.bia-quick-card {
	border: none;
	border-radius: 1.25rem;
	background: var(--bs-body-bg);
	box-shadow: 0 0.5rem 1.5rem rgba(15, 23, 42, 0.08);
	padding: 1.5rem;
	height: 100%;
}
body[data-theme="dark"] .bia-quick-card {
	background: rgba(18, 18, 18, 0.8);
	border: 1px solid rgba(255, 255, 255, 0.08);
	box-shadow: 0 0.5rem 1.5rem rgba(0, 0, 0, 0.65);
}
.bia-quick-card h2 {
	font-size: 0.75rem;
	letter-spacing: 0.1em;
	text-transform: uppercase;
	color: var(--bs-secondary-color);
	margin-bottom: 1rem;
}
.bia-quick-nav .nav-link {
	border-radius: 0.75rem;
	padding: 0.65rem 0.75rem;
	font-weight: 500;
	color: inherit;
	transition: background 0.2s ease, transform 0.2s ease;
}
.bia-quick-nav .nav-link:hover {
	background: rgba(13, 110, 253, 0.08);
	transform: translateX(4px);
}
.bia-dashboard-actions {
	display: grid;
	gap: 1.5rem;
}
@media (min-width: 768px) {
	.bia-dashboard-actions {
		grid-template-columns: repeat(3, minmax(0, 1fr));
	}
}
.bia-dashboard-actions__item {
	display: flex;
}
.bia-dashboard-actions__item .bia-quick-card {
	width: 100%;
}
.bia-dashboard-actions .btn {
	border-radius: 999px;
}
.bia-dashboard-actions .btn.btn-sm {
	padding-inline: 1.25rem;
	font-weight: 500;
}
.bia-context-grid article {
	height: 100%;
}
.bia-context-card {
	border-radius: 1.25rem;
	border: 1px solid var(--bs-border-color-translucent);
	background: var(--bs-body-bg);
	box-shadow: 0 1rem 2rem rgba(15, 23, 42, 0.12);
	padding: 1.5rem;
	display: flex;
	flex-direction: column;
	gap: 1.25rem;
	transition: transform 0.2s ease, box-shadow 0.2s ease;
}
body[data-theme="dark"] .bia-context-card {
	background: rgba(23, 23, 23, 0.9);
	border-color: rgba(255, 255, 255, 0.06);
	box-shadow: 0 1rem 2.5rem rgba(0, 0, 0, 0.55);
}
.bia-context-card:hover {
	transform: translateY(-4px);
	box-shadow: 0 1.5rem 3rem rgba(15, 23, 42, 0.16);
}
.bia-context-card__owner form {
	max-width: 360px;
}
.bia-chip {
	display: inline-flex;
	align-items: center;
	gap: 0.35rem;
	padding: 0.2rem 0.9rem;
	border-radius: 999px;
	font-size: 0.75rem;
	font-weight: 600;
	background: rgba(13, 110, 253, 0.1);
	color: var(--bs-primary);
}
body[data-theme="dark"] .bia-chip {
	color: #9cc1ff;
	background: rgba(13, 110, 253, 0.18);
}
.bia-chip--muted {
	background: rgba(108, 117, 125, 0.15);
	color: var(--bs-secondary-color);
}
.bia-dashboard-empty {
	border-radius: 1rem;
	padding: 2rem;
	background: rgba(13, 110, 253, 0.05);
	border: 1px dashed rgba(13, 110, 253, 0.4);
}
</style>
{% endblock %}
{% block content %}
{% set is_dark = theme != 'light' %}
{% set nav_link_color = 'text-light' if is_dark else 'text-dark' %}
{% set outline_inverse = 'btn-outline-light' if is_dark else 'btn-outline-dark' %}
{% set badge_muted = 'text-bg-secondary' %}
{% set context_list = contexts or [] %}
{% set contexts_count = context_list | length %}
{% set assigned_contexts = context_list | selectattr('author') | list %}
{% set assigned_count = assigned_contexts | length %}
{% set stats = namespace(components=0, most_recent=None) %}
{% for ctx in context_list %}
	{% set stats.components = stats.components + (ctx.components | length) %}
	{% if ctx.last_update %}
		{% if stats.most_recent is none or ctx.last_update > stats.most_recent %}
			{% set stats.most_recent = ctx.last_update %}
		{% endif %}
	{% endif %}
{% endfor %}
{% set last_updated_display = stats.most_recent or _('bia.dashboard.card.never') %}

<div class="bia-dashboard">
	<section class="bia-dashboard-hero">
		<div class="bia-dashboard-hero__body d-flex flex-column flex-lg-row align-items-start align-items-lg-center gap-4">
			<div class="flex-grow-1">
				<p class="text-uppercase small text-white-50 mb-2">{{ _('bia.dashboard.header.subtitle') }}</p>
				<h1 class="display-6 fw-semibold mb-3">{{ _('bia.dashboard.header.title') }}</h1>
				<div class="d-flex flex-wrap gap-2">
					<span class="bia-chip bia-chip--muted">{{ _('bia.dashboard.sidebar.navigate') }}</span>
					<span class="bia-chip bia-chip--muted">{{ _('bia.dashboard.sidebar.manage') }}</span>
					<span class="bia-chip bia-chip--muted">{{ _('bia.dashboard.sidebar.exports') }}</span>
				</div>
			</div>
		</div>
		<div class="bia-dashboard-hero__metrics">
			<div class="bia-dashboard-hero__metric">
				<p class="text-uppercase small text-white-50 mb-1">{{ _('bia.dashboard.sidebar.overview') }}</p>
				<strong>{{ contexts_count }}</strong>
				<small>{{ _('bia.dashboard.header.subtitle') }}</small>
			</div>
			<div class="bia-dashboard-hero__metric">
				<p class="text-uppercase small text-white-50 mb-1">{{ _('bia.dashboard.sidebar.components') }}</p>
				<strong>{{ stats.components }}</strong>
				<small>{{ _('bia.dashboard.card.components', count=stats.components) }}</small>
			</div>
			<div class="bia-dashboard-hero__metric">
				<p class="text-uppercase small text-white-50 mb-1">{{ _('bia.dashboard.card.risk_owner') }}</p>
				<strong>{{ assigned_count }}</strong>
				<small>{{ _('bia.dashboard.card.last_updated', date=last_updated_display) }}</small>
			</div>
		</div>
	</section>

	<section class="bia-dashboard-actions">
		<div class="bia-dashboard-actions__item">
			<div class="bia-quick-card h-100">
				<h2>{{ _('bia.dashboard.sidebar.navigate') }}</h2>
				<ul class="nav flex-column gap-2 bia-quick-nav">
					<li class="nav-item">
						<a class="nav-link {{ nav_link_color }} d-flex align-items-center" href="{{ url_for('bia.dashboard') }}">
							<i class="fas fa-chart-line me-2 text-primary"></i>
							{{ _('bia.dashboard.sidebar.overview') }}
						</a>
					</li>
					<li class="nav-item">
						<a class="nav-link {{ nav_link_color }} d-flex align-items-center" href="{{ url_for('bia.view_components') }}">
							<i class="fas fa-layer-group me-2 text-primary"></i>
							{{ _('bia.dashboard.sidebar.components') }}
						</a>
					</li>
				</ul>
			</div>
		</div>
		<div class="bia-dashboard-actions__item">
			<div class="bia-quick-card h-100 d-flex flex-column gap-3">
				<h2>{{ _('bia.dashboard.sidebar.manage') }}</h2>
				<div class="d-flex flex-wrap gap-2">
					<a href="{{ url_for('bia.new_item') }}" class="btn btn-primary btn-sm">{{ _('bia.dashboard.sidebar.new_bia') }}</a>
					<a href="{{ url_for('bia.import_csv_view') }}" class="btn {{ outline_inverse }} btn-sm">{{ _('bia.dashboard.sidebar.import_csv') }}</a>
					<a href="{{ url_for('bia.import_sql_form') }}" class="btn btn-outline-secondary btn-sm">{{ _('bia.dashboard.sidebar.import_sql') }}</a>
					<a href="{{ url_for('bia.archived_list') }}" class="btn btn-outline-secondary btn-sm">{{ _('bia.dashboard.sidebar.archived') }}</a>
				</div>
				<div class="small text-secondary">
					{{ _('bia.dashboard.header.subtitle') }}
				</div>
			</div>
		</div>
		<div class="bia-dashboard-actions__item">
			<div class="bia-quick-card h-100 d-flex flex-column gap-2">
				<h2>{{ _('bia.dashboard.sidebar.exports') }}</h2>
				<div class="d-grid gap-2">
					<a href="{{ url_for('bia.export_data_inventory') }}" class="btn btn-outline-secondary btn-sm">{{ _('bia.dashboard.sidebar.export_inventory') }}</a>
					<a href="{{ url_for('bia.export_all_consequences') }}" class="btn btn-outline-secondary btn-sm">{{ _('bia.dashboard.sidebar.export_cia_detailed') }}</a>
					<a href="{{ url_for('bia.export_all_consequences', type='summary') }}" class="btn btn-outline-secondary btn-sm">{{ _('bia.dashboard.sidebar.export_cia_summary') }}</a>
					<a href="{{ url_for('bia.export_availability_requirements') }}" class="btn btn-outline-secondary btn-sm">{{ _('bia.dashboard.sidebar.export_availability_detailed') }}</a>
					<a href="{{ url_for('bia.export_availability_requirements', type='summary') }}" class="btn btn-outline-secondary btn-sm">{{ _('bia.dashboard.sidebar.export_availability_summary') }}</a>
					<a href="{{ url_for('bia.export_all_dependencies') }}" class="btn btn-outline-secondary btn-sm">Export Dependencies</a>
					<a href="{{ url_for('bia.export_all_tiers') }}" class="btn btn-outline-secondary btn-sm">Export Tiers</a>
					<a href="{{ url_for('bia.export_authentication_overview') }}" class="btn btn-outline-secondary btn-sm">{{ _('bia.dashboard.sidebar.export_authentication') }}</a>
				</div>
			</div>
		</div>
	</section>

	<section>
		<div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3 gap-3">
			<div>
				<h2 class="h4 mb-1">{{ _('bia.dashboard.header.title') }}</h2>
				<p class="text-secondary mb-0">{{ _('bia.dashboard.header.subtitle') }}</p>
			</div>
			<div class="d-flex flex-wrap gap-2">
				<span class="bia-chip">{{ _('bia.dashboard.card.components', count=stats.components) }}</span>
				<span class="bia-chip bia-chip--muted">{{ _('bia.dashboard.card.last_updated', date=last_updated_display) }}</span>
			</div>
		</div>

		{% if context_list %}
		<div class="row row-cols-1 row-cols-lg-2 row-cols-xxl-3 g-4 bia-context-grid">
			{% for context in context_list %}
			<article class="col">
				<div class="bia-context-card h-100">
					<div class="d-flex justify-content-between align-items-start gap-3">
						<div>
							<h3 class="h5 mb-1">{{ context.name }}</h3>
							<p class="text-secondary small mb-0">
								{{ _('bia.dashboard.card.risk_owner') }}: {{ context.risk_owner or (context.author.full_name if context.author else context.responsible) or _('bia.dashboard.card.not_assigned') }}
							</p>
						</div>
						<span class="badge {{ badge_muted }}">{{ _('bia.dashboard.card.components', count=context.components | length) }}</span>
					</div>
					{% if can_manage_owner|default(False) %}
					<div class="bia-context-card__owner">
						<form class="mt-3" method="post" action="{{ url_for('bia.update_owner', item_id=context.id) }}">
							{% if csrf_token is defined %}
							<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
							{% endif %}
							<div class="input-group input-group-sm">
								<select class="form-select" name="owner_id" aria-label="{{ _('bia.dashboard.card.owner_aria') }}">
									<option value="" {% if not context.author %}selected{% endif %}>{{ _('bia.dashboard.card.owner_unassigned') }}</option>
									{% if context.author and owner_choice_ids and context.author.id not in owner_choice_ids %}
									<option value="{{ context.author.id }}" selected>{{ context.author.full_name }}</option>
									{% endif %}
									{% for owner in owner_choices %}
									<option value="{{ owner.id }}" {% if context.author and context.author.id == owner.id %}selected{% endif %}>
										{{ owner.full_name }}{% if owner.email %} ({{ owner.email }}){% endif %}
									</option>
									{% endfor %}
								</select>
								<button type="submit" class="btn btn-outline-primary">{{ _('bia.dashboard.card.owner_save') }}</button>
							</div>
						</form>
					</div>
					{% endif %}
					<div class="text-secondary small">
						{% if context.service_description %}
							{{ context.service_description | truncate(160, True, '...') }}
						{% else %}
							{{ _('bia.dashboard.card.no_description') }}
						{% endif %}
					</div>
					<div class="d-flex flex-wrap gap-2 align-items-center">
						<a href="{{ url_for('bia.view_item', item_id=context.id) }}" class="btn {{ outline_inverse }} btn-sm">{{ _('bia.dashboard.card.action_view') }}</a>
						<a href="{{ url_for('bia.export_item', item_id=context.id) }}" class="btn btn-outline-secondary btn-sm">{{ _('bia.dashboard.card.action_export_html') }}</a>
						<a href="{{ url_for('bia.export_csv', item_id=context.id) }}" class="btn btn-outline-secondary btn-sm">{{ _('bia.dashboard.card.action_export_csv') }}</a>
						<a href="{{ url_for('bia.export_bia_sql', item_id=context.id) }}" class="btn btn-outline-secondary btn-sm">{{ _('bia.dashboard.card.action_export_sql') }}</a>
						{% if editable_context_ids and context.id in editable_context_ids %}
						<a href="{{ url_for('bia.edit_item', item_id=context.id) }}" class="btn btn-outline-primary btn-sm">{{ _('bia.dashboard.card.action_edit') }}</a>
						<form method="post" action="{{ url_for('bia.copy_item', item_id=context.id) }}" style="display: contents;">
							<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
							<button type="submit" class="btn btn-outline-secondary btn-sm" onclick="return confirm('{{ _('bia.actions.confirm_copy') }}');">{{ _('bia.actions.copy') }}</button>
						</form>
						<form method="post" action="{{ url_for('bia.archive_item', item_id=context.id) }}" style="display: contents;">
							<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
							<button type="submit" class="btn btn-outline-warning btn-sm" onclick="return confirm('{{ _('bia.actions.confirm_archive') }}');">{{ _('bia.actions.archive') }}</button>
						</form>
						{% endif %}
					</div>
					<div class="text-secondary small">
						{{ _('bia.dashboard.card.last_updated', date=context.last_update or _('bia.dashboard.card.never')) }}
					</div>
				</div>
			</article>
			{% endfor %}
		</div>
		{% else %}
		<div class="bia-dashboard-empty">
			<strong>{{ _('bia.dashboard.empty.title') }}</strong>
			<p class="mb-0">{{ _('bia.dashboard.empty.body') }}</p>
		</div>
		{% endif %}
	</section>
</div>
{% endblock %}
