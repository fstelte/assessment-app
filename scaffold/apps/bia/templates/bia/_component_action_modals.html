<script nonce="{{ csp_nonce }}">
(function () {
  const addForm = document.getElementById('add-component-form');
  const csrfTokenInput = document.querySelector('input[name="csrf_token"]');
  const csrfToken = csrfTokenInput ? csrfTokenInput.value : null;
  const i18n = {
    errorUnexpected: "{{ _('bia.components.messages.error_unexpected') }}",
    validationFailed: "{{ _('bia.components.messages.validation_failed') }}",
    addFailed: "{{ _('bia.components.messages.add_failed') }}",
    deleteFailed: "{{ _('bia.components.messages.delete_failed') }}",
    confirmDelete: "{{ _('bia.components.table.confirm_delete') }}"
  };
  const handleErrors = (messages) => {
    if (!messages) {
      window.alert(i18n.errorUnexpected);
      return;
    }
    const details = Object.entries(messages).map(([field, errs]) => `${field}: ${errs.join(', ')}`).join('\n');
    window.alert(`${i18n.validationFailed}\n${details}`);
  };

  if (addForm) {
    addForm.addEventListener('submit', function (event) {
      event.preventDefault();
      const formData = new FormData(addForm);
      fetch(addForm.action, {
        method: 'POST',
        body: formData,
      }).then((response) => response.json())
        .then((data) => {
          if (data.success) {
            window.location.reload();
          } else {
            handleErrors(data.errors);
          }
        })
        .catch(() => window.alert(i18n.addFailed));
    });
  }

  document.querySelectorAll('[data-delete-url]').forEach((button) => {
    button.addEventListener('click', function () {
      if (!window.confirm(i18n.confirmDelete)) {
        return;
      }
      const payload = new FormData();
      if (csrfToken) {
        payload.append('csrf_token', csrfToken);
      }
      fetch(this.dataset.deleteUrl, {
        method: 'POST',
        body: payload,
      }).then((response) => response.json())
        .then((data) => {
          if (data.success) {
            window.location.reload();
          } else {
            window.alert(i18n.deleteFailed);
          }
        })
        .catch(() => window.alert(i18n.deleteFailed));
    });
  });
})();
</script>
