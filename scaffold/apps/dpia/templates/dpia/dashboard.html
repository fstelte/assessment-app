{% extends "base.html" %}
{% block title %}{{ _('dpia.dashboard.title') }}{% endblock %}

{% block extra_css %}
<style nonce="{{ csp_nonce }}">
.dpia-dashboard {
  display: flex;
  flex-direction: column;
  gap: 2rem;
}
.dpia-hero {
  background: linear-gradient(130deg, rgba(109, 40, 217, 0.92), rgba(76, 29, 149, 0.95));
  border-radius: 1.5rem;
  padding: clamp(1.75rem, 4vw, 2.5rem);
  box-shadow: 0 1.25rem 3rem rgba(15, 23, 42, 0.25);
  color: #fff;
  position: relative;
  overflow: hidden;
}
body[data-theme="dark"] .dpia-hero {
  background: linear-gradient(130deg, rgba(109, 40, 217, 0.6), rgba(76, 29, 149, 0.7));
  box-shadow: 0 1rem 2.5rem rgba(0, 0, 0, 0.45);
  border: 1px solid rgba(255, 255, 255, 0.08);
}
.dpia-hero::after {
  content: "";
  position: absolute;
  width: 320px;
  height: 320px;
  background: radial-gradient(circle, rgba(255, 255, 255, 0.18), transparent 65%);
  right: -80px;
  top: -60px;
  filter: blur(4px);
  pointer-events: none;
}
.dpia-hero__body {
  position: relative;
  z-index: 1;
}
.dpia-hero__metrics {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 1.25rem;
  margin-top: 1.5rem;
}
.dpia-hero__metric {
  background: rgba(255, 255, 255, 0.1);
  border-radius: 1rem;
  padding: 1rem 1.25rem;
  backdrop-filter: blur(6px);
}
.dpia-hero__metric strong {
  font-size: clamp(1.5rem, 4vw, 2.5rem);
  line-height: 1;
  display: block;
}
.dpia-hero__metric small {
  color: rgba(255, 255, 255, 0.75);
  font-size: 0.8rem;
}
.dpia-quick-card {
  border: none;
  border-radius: 1.25rem;
  background: var(--bs-body-bg);
  box-shadow: 0 0.5rem 1.5rem rgba(15, 23, 42, 0.08);
}
body[data-theme="dark"] .dpia-quick-card {
  background: rgba(18, 18, 18, 0.8);
  border: 1px solid rgba(255, 255, 255, 0.08);
  box-shadow: 0 0.5rem 1.5rem rgba(0, 0, 0, 0.65);
}
.dpia-assessment-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 0.75rem;
  border: 1px solid var(--bs-border-color-translucent);
  border-radius: 0.75rem;
  padding: 0.4rem 0.75rem;
  font-size: 0.8rem;
}
.dpia-auth-badge {
  display: inline-flex;
  align-items: center;
  padding: 0.2rem 0.75rem;
  border-radius: 999px;
  font-size: 0.72rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  background: rgba(109, 40, 217, 0.1);
  color: #7c3aed;
  border: 1px solid rgba(109, 40, 217, 0.22);
}
body[data-theme="dark"] .dpia-auth-badge {
  color: #c4b5fd;
  background: rgba(109, 40, 217, 0.2);
  border-color: rgba(109, 40, 217, 0.35);
}
.dpia-auth-badge--unset {
  background: rgba(108, 117, 125, 0.1);
  color: var(--bs-secondary-color);
  border-color: rgba(108, 117, 125, 0.2);
}
</style>
{% endblock %}

{% block content %}
{% set ns = namespace(with_dpia=0) %}
{% for c in components %}{% if c.dpia_assessments %}{% set ns.with_dpia = ns.with_dpia + 1 %}{% endif %}{% endfor %}

<div class="dpia-dashboard">

  {# ── Hero ── #}
  <section class="dpia-hero">
    <div class="dpia-hero__body d-flex flex-column flex-lg-row align-items-start align-items-lg-center gap-4">
      <div class="flex-grow-1">
        <p class="text-uppercase mb-2" style="font-size:0.75rem;letter-spacing:0.08em;color:rgba(255,255,255,0.6);">{{ _('dpia.dashboard.title') }}</p>
        <h1 class="fw-bold mb-2" style="font-size:clamp(1.6rem,4vw,2.2rem);">{{ _('dpia.dashboard.heading') }}</h1>
        <p class="mb-0" style="color:rgba(255,255,255,0.8);font-size:0.9rem;">{{ _('dpia.dashboard.supporting_copy') }}</p>
      </div>
      <div class="mt-3 mt-lg-0">
        <a href="{{ url_for('bia.view_components') }}" class="btn btn-sm btn-light fw-medium">
          <i class="fas fa-layer-group me-1"></i> {{ _('dpia.dashboard.manage_components') }}
        </a>
      </div>
    </div>
    <div class="dpia-hero__metrics">
      <div class="dpia-hero__metric">
        <p class="text-uppercase mb-1" style="font-size:0.7rem;color:rgba(255,255,255,0.6);letter-spacing:0.08em;">{{ _('dpia.dashboard.table.headers.component') }}</p>
        <strong>{{ pagination.total }}</strong>
        <small>{{ _('dpia.dashboard.table.title') }}</small>
      </div>
      <div class="dpia-hero__metric">
        <p class="text-uppercase mb-1" style="font-size:0.7rem;color:rgba(255,255,255,0.6);letter-spacing:0.08em;">{{ _('dpia.dashboard.table.headers.bia') }}</p>
        <strong>{{ contexts | length }}</strong>
        <small>{{ _('dpia.dashboard.filters.scope_label') }}</small>
      </div>
      <div class="dpia-hero__metric">
        <p class="text-uppercase mb-1" style="font-size:0.7rem;color:rgba(255,255,255,0.6);letter-spacing:0.08em;">{{ _('dpia.dashboard.table.headers.dpia_status') }}</p>
        <strong>{{ ns.with_dpia }}</strong>
        <small>{{ _('dpia.dashboard.table.title') }}</small>
      </div>
    </div>
  </section>

  {# ── Filter form ── #}
  <form method="get" action="{{ url_for('dpia.dashboard') }}">
    <div class="row g-3 align-items-end">
      <div class="col-12 col-md-5">
        <label for="dpia-component-search" class="form-label small fw-medium">{{ _('dpia.dashboard.filters.search_label') }}</label>
        <div class="input-group">
          <span class="input-group-text"><i class="fas fa-search"></i></span>
          <input type="search" name="q" id="dpia-component-search" class="form-control"
                 value="{{ search_query }}"
                 placeholder="{{ _('dpia.dashboard.filters.search_placeholder') }}">
        </div>
      </div>
      <div class="col-12 col-md-4">
        <label for="dpia-scope-filter" class="form-label small fw-medium">{{ _('dpia.dashboard.filters.scope_label') }}</label>
        <select name="scope" id="dpia-scope-filter" class="form-select">
          <option value="all" {% if selected_scope|lower == 'all' %}selected{% endif %}>{{ _('dpia.dashboard.filters.scope_all') }}</option>
          {% for context in contexts %}
            <option value="{{ context.name }}" {% if context.name == selected_scope %}selected{% endif %}>{{ context.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-12 col-md-auto">
        <button type="submit" class="btn btn-primary w-100">
          <i class="fas fa-filter me-1"></i> {{ _('dpia.dashboard.filters.apply') }}
        </button>
      </div>
      {% if search_query or (selected_scope and selected_scope|lower != 'all') %}
      <div class="col-12 col-md-auto">
        <a href="{{ url_for('dpia.dashboard') }}" class="btn btn-outline-secondary w-100">
          <i class="fas fa-times me-1"></i> {{ _('actions.clear', default='Clear') }}
        </a>
      </div>
      {% endif %}
    </div>
  </form>

  {# ── Components table ── #}
  <section>
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3 gap-3">
      <div>
        <h2 class="h5 fw-semibold mb-1">{{ _('dpia.dashboard.table.title') }}</h2>
        <p class="text-secondary mb-0" style="font-size:0.875rem;">{{ _('dpia.dashboard.supporting_copy') }}</p>
      </div>
      {% if pagination.pages > 1 %}
      <small class="text-secondary">{{ _('dpia.dashboard.table.pagination', start=page_start, end=page_end, total=pagination.total) }}</small>
      {% endif %}
    </div>

    <div class="dpia-quick-card overflow-hidden">
      {% if components %}
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0 w-100">
          <thead>
            <tr>
              <th class="ps-4">{{ _('dpia.dashboard.table.headers.component') }}</th>
              <th>{{ _('dpia.dashboard.table.headers.bia') }}</th>
              <th>{{ _('dpia.dashboard.table.headers.owner') }}</th>
              <th>{{ _('dpia.dashboard.table.headers.authentication') }}</th>
              <th>{{ _('dpia.dashboard.table.headers.dpia_status') }}</th>
              <th class="text-end pe-4">{{ _('dpia.dashboard.table.headers.actions') }}</th>
            </tr>
          </thead>
          <tbody>
            {% for component in components %}
              {% set assessment_count = component.dpia_assessments | length %}
              <tr>
                <td class="ps-4 fw-semibold">{{ component.name }}</td>
                <td>
                  {% if component.context_scope %}
                    <span class="badge bg-secondary bg-opacity-10 text-secondary border" style="font-size:0.72rem;">{{ component.context_scope.name }}</span>
                  {% else %}
                    <span class="text-secondary" style="font-size:0.8rem;">{{ _('dpia.dashboard.table.not_linked') }}</span>
                  {% endif %}
                </td>
                <td>
                  <span class="text-body" style="font-size:0.875rem;">{{ component.info_owner or _('dpia.dashboard.table.not_set') }}</span>
                </td>
                <td>
                  {% if component.authentication_method and component.authentication_method.name %}
                    <span class="dpia-auth-badge">{{ component.authentication_method.name }}</span>
                  {% else %}
                    <span class="dpia-auth-badge dpia-auth-badge--unset">{{ _('dpia.dashboard.table.authentication_unset') }}</span>
                  {% endif %}
                </td>
                <td>
                  {% if assessment_count %}
                    <div class="d-flex flex-column gap-2">
                      {% for assessment in component.dpia_assessments|sort(attribute='updated_at', reverse=True) %}
                        {% set badge_class = dpia_status_badges.get(assessment.status.value, 'bg-secondary') %}
                        {% if assessment.updated_at %}
                          {% set updated_display = _('dpia.dashboard.table.assessment_updated', timestamp=assessment.updated_at.strftime('%Y-%m-%d %H:%M')) %}
                        {% else %}
                          {% set updated_display = _('dpia.dashboard.table.assessment_updated', timestamp=_('dpia.dashboard.table.unknown')) %}
                        {% endif %}
                        <div class="dpia-assessment-row">
                          <span class="badge {{ badge_class }}" style="font-size:0.7rem;">{{ _('dpia.status.' ~ assessment.status.value) }}</span>
                          <small class="text-secondary">{{ updated_display }}</small>
                        </div>
                      {% endfor %}
                    </div>
                  {% else %}
                    <span class="text-secondary" style="font-size:0.8rem;">{{ _('dpia.dashboard.table.dpia_none') }}</span>
                  {% endif %}
                </td>
                <td class="text-end pe-4">
                  {% if component.context_scope %}
                    {% if assessment_count %}
                      <div class="d-flex flex-column align-items-end gap-2">
                        {% for assessment in component.dpia_assessments|sort(attribute='updated_at', reverse=True) %}
                          <div class="d-flex flex-wrap justify-content-end gap-1">
                            <a href="{{ url_for('dpia.view_assessment', assessment_id=assessment.id) }}"
                               class="btn btn-sm btn-outline-secondary">
                              {{ _('dpia.dashboard.table.edit_existing_action') }}
                            </a>
                            <form method="post" action="{{ url_for('dpia.delete_assessment', assessment_id=assessment.id) }}" class="d-inline">
                              {% if csrf_token is defined %}
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                              {% endif %}
                              <button type="submit" class="btn btn-sm btn-outline-danger"
                                      data-confirm-message="{{ _('dpia.dashboard.table.delete_confirm') }}"
                                      onclick="return confirm(this.dataset.confirmMessage);">
                                {{ _('dpia.dashboard.table.delete_action') }}
                              </button>
                            </form>
                          </div>
                        {% endfor %}
                        <small class="text-secondary">{{ _('dpia.dashboard.table.start_blocked') }}</small>
                      </div>
                    {% else %}
                      <a href="{{ url_for('dpia.start_from_component', component_id=component.id) }}"
                         class="btn btn-sm btn-primary">
                        <i class="fas fa-plus me-1"></i> {{ _('dpia.dashboard.table.start_action') }}
                      </a>
                    {% endif %}
                  {% else %}
                    <span class="text-secondary" style="font-size:0.8rem;">{{ _('dpia.dashboard.table.start_disabled') }}</span>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      {% if pagination.pages > 1 %}
      <div class="flex items-center justify-between border-t border-[var(--color-border)] px-4 py-3">
        <div>
          <p class="text-sm text-[var(--color-muted)]">{{ _('dpia.dashboard.table.pagination', start=page_start, end=page_end, total=pagination.total) }}</p>
        </div>
        <div class="flex items-center gap-2">
          <div class="flex sm:hidden gap-2">
            {% if pagination.has_prev %}
            <a href="{{ url_for('dpia.dashboard', page=pagination.prev_num, q=search_query, scope=selected_scope) }}" class="relative inline-flex items-center rounded-md border border-[var(--color-border)] bg-[var(--color-card)] px-4 py-2 text-sm font-medium text-[var(--color-text)] hover:bg-[var(--color-surface)]">
              {{ _('pagination.previous') }}
            </a>
            {% else %}
            <span class="relative inline-flex items-center rounded-md border border-[var(--color-border)] bg-[var(--color-surface)] px-4 py-2 text-sm font-medium text-[var(--color-muted)] opacity-50 cursor-not-allowed">
              {{ _('pagination.previous') }}
            </span>
            {% endif %}
            {% if pagination.has_next %}
            <a href="{{ url_for('dpia.dashboard', page=pagination.next_num, q=search_query, scope=selected_scope) }}" class="relative inline-flex items-center rounded-md border border-[var(--color-border)] bg-[var(--color-card)] px-4 py-2 text-sm font-medium text-[var(--color-text)] hover:bg-[var(--color-surface)]">
              {{ _('pagination.next') }}
            </a>
            {% else %}
            <span class="relative inline-flex items-center rounded-md border border-[var(--color-border)] bg-[var(--color-surface)] px-4 py-2 text-sm font-medium text-[var(--color-muted)] opacity-50 cursor-not-allowed">
              {{ _('pagination.next') }}
            </span>
            {% endif %}
          </div>
          <nav class="hidden sm:flex isolate inline-flex -space-x-px rounded-md shadow-sm" aria-label="Pagination">
            {% if pagination.has_prev %}
            <a href="{{ url_for('dpia.dashboard', page=pagination.prev_num, q=search_query, scope=selected_scope) }}" class="relative inline-flex items-center rounded-l-md px-2 py-2 text-[var(--color-muted)] ring-1 ring-inset ring-[var(--color-border)] hover:bg-[var(--color-surface)] focus:z-20 focus:outline-offset-0">
              <span class="sr-only">{{ _('pagination.previous') }}</span>
              <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M12.79 5.23a.75.75 0 01-.02 1.06L8.832 10l3.938 3.71a.75.75 0 11-1.04 1.08l-4.5-4.25a.75.75 0 010-1.08l4.5-4.25a.75.75 0 011.06.02z" clip-rule="evenodd" /></svg>
            </a>
            {% else %}
            <span class="relative inline-flex items-center rounded-l-md px-2 py-2 text-[var(--color-muted)] ring-1 ring-inset ring-[var(--color-border)] bg-[var(--color-surface)] opacity-50 cursor-not-allowed">
              <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M12.79 5.23a.75.75 0 01-.02 1.06L8.832 10l3.938 3.71a.75.75 0 11-1.04 1.08l-4.5-4.25a.75.75 0 010-1.08l4.5-4.25a.75.75 0 011.06.02z" clip-rule="evenodd" /></svg>
            </span>
            {% endif %}
            {% for p in pagination.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
              {% if p %}
                {% if p == pagination.page %}
                <span class="relative z-10 inline-flex items-center bg-primary-600 px-4 py-2 text-sm font-semibold text-white focus:z-20">{{ p }}</span>
                {% else %}
                <a href="{{ url_for('dpia.dashboard', page=p, q=search_query, scope=selected_scope) }}" class="relative inline-flex items-center px-4 py-2 text-sm font-semibold text-[var(--color-text)] ring-1 ring-inset ring-[var(--color-border)] hover:bg-[var(--color-surface)] focus:z-20 focus:outline-offset-0">{{ p }}</a>
                {% endif %}
              {% else %}
              <span class="relative inline-flex items-center px-4 py-2 text-sm font-semibold text-[var(--color-muted)] ring-1 ring-inset ring-[var(--color-border)] focus:outline-offset-0">&hellip;</span>
              {% endif %}
            {% endfor %}
            {% if pagination.has_next %}
            <a href="{{ url_for('dpia.dashboard', page=pagination.next_num, q=search_query, scope=selected_scope) }}" class="relative inline-flex items-center rounded-r-md px-2 py-2 text-[var(--color-muted)] ring-1 ring-inset ring-[var(--color-border)] hover:bg-[var(--color-surface)] focus:z-20 focus:outline-offset-0">
              <span class="sr-only">{{ _('pagination.next') }}</span>
              <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" /></svg>
            </a>
            {% else %}
            <span class="relative inline-flex items-center rounded-r-md px-2 py-2 text-[var(--color-muted)] ring-1 ring-inset ring-[var(--color-border)] bg-[var(--color-surface)] opacity-50 cursor-not-allowed">
              <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" /></svg>
            </span>
            {% endif %}
          </nav>
        </div>
      </div>
      {% endif %}

      {% else %}
      <div class="text-center text-secondary py-5">
        <i class="fas fa-shield-alt fa-2x mb-2 d-block opacity-40"></i>
        {{ _('dpia.dashboard.table.empty') }}
      </div>
      {% endif %}
    </div>
  </section>

  {# ── Help notice ── #}
  <div class="alert alert-secondary d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 mb-0" role="alert">
    <div>
      <strong>{{ _('dpia.dashboard.help.title') }}</strong>
      <p class="mb-0 mt-1" style="font-size:0.875rem;">{{ _('dpia.dashboard.help.description') }}</p>
    </div>
    <a href="{{ url_for('bia.view_components') }}" class="btn btn-sm btn-outline-secondary flex-shrink-0">
      <i class="fas fa-layer-group me-1"></i> {{ _('dpia.dashboard.help.manage_link') }}
    </a>
  </div>

</div>
{% endblock %}
