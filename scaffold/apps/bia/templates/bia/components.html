{% extends "base.html" %}
{% block title %}Components | BIA{% endblock %}
{% block content %}
<div class="mb-3">
  <a href="{{ url_for('bia.dashboard') }}" class="text-secondary text-decoration-none">&larr; Back to dashboard</a>
</div>

<div class="d-flex justify-content-between align-items-center mb-4">
  <h1 class="mb-0">Component library</h1>
  <form class="d-flex gap-2" method="get" action="{{ url_for('bia.view_components') }}">
    <select class="form-select" name="scope">
      <option value="all" {% if selected_scope|lower == 'all' %}selected{% endif %}>All BIAs</option>
      {% for context in contexts %}
        <option value="{{ context.name }}" {% if context.name == selected_scope %}selected{% endif %}>{{ context.name }}</option>
      {% endfor %}
    </select>
    <button type="submit" class="btn btn-outline-light">Filter</button>
  </form>
</div>

<div class="card bg-dark border-secondary mb-4">
  <div class="card-header border-secondary">Add a component</div>
  <div class="card-body">
    <form id="add-component-form" action="{{ url_for('bia.add_component') }}" method="post" class="row g-3 align-items-end">
      {{ component_form.hidden_tag() }}
      <div class="col-md-4">
        <label for="bia-id" class="form-label">BIA</label>
        <select id="bia-id" name="bia_id" class="form-select" required>
          <option value="" disabled selected>Select a BIA</option>
          {% for context in contexts %}
            <option value="{{ context.id }}">{{ context.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-4">{{ component_form.name.label(class="form-label") }}{{ component_form.name(class="form-control") }}</div>
      <div class="col-md-4">{{ component_form.info_owner.label(class="form-label") }}{{ component_form.info_owner(class="form-control") }}</div>
      <div class="col-md-4">{{ component_form.info_type.label(class="form-label") }}{{ component_form.info_type(class="form-control") }}</div>
      <div class="col-md-4">{{ component_form.user_type.label(class="form-label") }}{{ component_form.user_type(class="form-control") }}</div>
      <div class="col-md-4">{{ component_form.process_dependencies.label(class="form-label") }}{{ component_form.process_dependencies(class="form-control") }}</div>
      <div class="col-12">{{ component_form.description.label(class="form-label") }}{{ component_form.description(class="form-control", rows=2) }}</div>
      <div class="col-12 text-end">
        <button type="submit" class="btn btn-primary">Add component</button>
      </div>
    </form>
  </div>
</div>

<div class="card bg-dark border-secondary" id="consequences">
  <div class="card-header border-secondary">Existing components</div>
  <div class="card-body p-0">
    {% if components %}
    <div class="table-responsive">
      <table class="table table-dark table-striped align-middle mb-0">
        <thead>
          <tr>
            <th scope="col">Component</th>
            <th scope="col">BIA</th>
            <th scope="col">Owner</th>
            <th scope="col">Users</th>
            <th scope="col">Consequences</th>
            <th scope="col">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for component in components %}
          <tr>
            <td>{{ component.name }}</td>
            <td>{{ component.context_scope.name if component.context_scope else 'Not linked' }}</td>
            <td>{{ component.info_owner or 'Not set' }}</td>
            <td>{{ component.user_type or 'Not set' }}</td>
            <td>{{ component.consequences | length }}</td>
            <td>
              <div class="d-flex flex-wrap gap-2">
                <button class="btn btn-outline-light btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#edit-component-{{ component.id }}" aria-expanded="false" aria-controls="edit-component-{{ component.id }}">Edit</button>
                <button class="btn btn-outline-primary btn-sm" type="button" data-ai-manage data-component-id="{{ component.id }}">Identify AI</button>
                <a href="{{ url_for('bia.view_consequences', component_id=component.id) }}" class="btn btn-outline-secondary btn-sm">Consequences</a>
                <button class="btn btn-outline-danger btn-sm" type="button" data-delete-url="{{ url_for('bia.delete_component', component_id=component.id) }}">Delete</button>
              </div>
            </td>
          </tr>
          <tr class="collapse" id="edit-component-{{ component.id }}">
            <td colspan="6" class="bg-secondary bg-opacity-10">
              <form class="component-edit-form row g-3" data-action="{{ url_for('bia.update_component', component_id=component.id) }}">
                {{ component_form.hidden_tag() }}
                <div class="col-md-4">
                  <label class="form-label" for="name-{{ component.id }}">Name</label>
                  <input type="text" id="name-{{ component.id }}" name="name" class="form-control" value="{{ component.name }}" required>
                </div>
                <div class="col-md-4">
                  <label class="form-label" for="bia_id-{{ component.id }}">BIA</label>
                  <select id="bia_id-{{ component.id }}" name="bia_id" class="form-select" required>
                    {% for context in contexts %}
                      <option value="{{ context.id }}" {% if component.context_scope and component.context_scope.id == context.id %}selected{% endif %}>{{ context.name }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-4">
                  <label class="form-label" for="info_owner-{{ component.id }}">Owner</label>
                  <input type="text" id="info_owner-{{ component.id }}" name="info_owner" class="form-control" value="{{ component.info_owner }}">
                </div>
                <div class="col-md-4">
                  <label class="form-label" for="info_type-{{ component.id }}">Information type</label>
                  <input type="text" id="info_type-{{ component.id }}" name="info_type" class="form-control" value="{{ component.info_type }}">
                </div>
                <div class="col-md-4">
                  <label class="form-label" for="user_type-{{ component.id }}">User type</label>
                  <input type="text" id="user_type-{{ component.id }}" name="user_type" class="form-control" value="{{ component.user_type }}">
                </div>
                <div class="col-md-4">
                  <label class="form-label" for="process_dependencies-{{ component.id }}">Process dependencies</label>
                  <input type="text" id="process_dependencies-{{ component.id }}" name="process_dependencies" class="form-control" value="{{ component.process_dependencies }}">
                </div>
                <div class="col-md-12">
                  <label class="form-label" for="description-{{ component.id }}">Description</label>
                  <textarea id="description-{{ component.id }}" name="description" class="form-control" rows="2">{{ component.description }}</textarea>
                </div>
                <div class="col-12 text-end">
                  <button type="submit" class="btn btn-outline-light btn-sm">Save changes</button>
                </div>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div class="d-flex flex-column flex-md-row align-items-center justify-content-between gap-2 px-3 py-2 border-top border-secondary">
      <small class="text-secondary mb-0">
        Showing {{ page_start }}â€“{{ page_end }} of {{ pagination.total }}{% if pagination.pages > 1 %} (page {{ pagination.page }} of {{ pagination.pages }}){% endif %}
      </small>
      {% if pagination.pages > 1 %}
      <nav aria-label="Component pagination">
        <ul class="pagination pagination-sm mb-0">
          <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('bia.view_components', page=pagination.prev_num, scope=selected_scope) }}" aria-label="Previous" tabindex="-1">&laquo;</a>
          </li>
          {% for p in pagination.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
            {% if p %}
              <li class="page-item {% if p == pagination.page %}active{% endif %}">
                <a class="page-link" href="{{ url_for('bia.view_components', page=p, scope=selected_scope) }}">{{ p }}</a>
              </li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">&hellip;</span></li>
            {% endif %}
          {% endfor %}
          <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('bia.view_components', page=pagination.next_num, scope=selected_scope) }}" aria-label="Next">&raquo;</a>
          </li>
        </ul>
      </nav>
      {% endif %}
    </div>
    {% else %}
      <div class="p-4 text-secondary">No components found for this selection.</div>
    {% endif %}
  </div>
  </div>

  <div class="modal fade" id="ai-identification-modal" tabindex="-1" aria-labelledby="ai-identification-label" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content bg-dark border-secondary">
        <div class="modal-header border-secondary">
          <h2 class="modal-title h5" id="ai-identification-label">AI identification</h2>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="ai-identification-form" class="vstack gap-3">
            <input type="hidden" id="ai-component-id" name="component_id">
            <div>
              <label class="form-label" for="ai-category">Risk category</label>
              <select id="ai-category" name="category" class="form-select">
                <option value="No AI">No AI</option>
                <option value="Unacceptable risk">Unacceptable risk</option>
                <option value="High risk">High risk</option>
                <option value="Limited risk">Limited risk</option>
                <option value="Minimal risk">Minimal risk</option>
              </select>
            </div>
            <div>
              <label class="form-label" for="ai-motivation">Motivation</label>
              <textarea id="ai-motivation" name="motivatie" class="form-control" rows="3" placeholder="Describe the reasoning for this classification"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer border-secondary">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" data-ai-save>Save</button>
        </div>
      </div>
    </div>
</div>

<script nonce="{{ csp_nonce }}">
(function () {
  const addForm = document.getElementById('add-component-form');
  const csrfTokenInput = document.querySelector('input[name="csrf_token"]');
  const csrfToken = csrfTokenInput ? csrfTokenInput.value : null;
  const aiModalElement = document.getElementById('ai-identification-modal');
  const aiForm = document.getElementById('ai-identification-form');
  const aiComponentIdField = document.getElementById('ai-component-id');
  const aiCategoryField = document.getElementById('ai-category');
  const aiMotivationField = document.getElementById('ai-motivation');
  const aiSaveTrigger = document.querySelector('[data-ai-save]');
  const aiRoutes = {
    detail: '{{ url_for("bia.get_ai_identification", component_id=0)[:-1] }}',
    upsert: '{{ url_for("bia.add_ai_identification", component_id=0)[:-1] }}'
  };
  const handleErrors = (messages) => {
    if (!messages) {
      window.alert('An unexpected error occurred.');
      return;
    }
    const details = Object.entries(messages).map(([field, errs]) => `${field}: ${errs.join(', ')}`).join('\n');
    window.alert(`Validation failed:\n${details}`);
  };

  const openAiModal = (componentId) => {
    if (!aiComponentIdField) {
      return;
    }
    const modalInstance = aiModalElement ? window.bootstrap?.Modal.getOrCreateInstance(aiModalElement) : null;
    aiComponentIdField.value = componentId;
    const targetUrl = aiRoutes.detail + componentId;
    fetch(targetUrl, { credentials: 'same-origin' })
      .then((response) => {
        if (response.status === 404) {
          return { category: 'No AI', motivatie: '' };
        }
        if (!response.ok) {
          throw new Error('Lookup failed');
        }
        return response.json();
      })
      .then((data) => {
        if (aiCategoryField) {
          aiCategoryField.value = data.category || 'No AI';
        }
        if (aiMotivationField) {
          aiMotivationField.value = data.motivatie || '';
        }
        modalInstance?.show();
      })
      .catch(() => {
        if (aiCategoryField) {
          aiCategoryField.value = 'No AI';
        }
        if (aiMotivationField) {
          aiMotivationField.value = '';
        }
        modalInstance?.show();
      });
  };

  document.querySelectorAll('[data-ai-manage]').forEach((button) => {
    button.addEventListener('click', () => {
      const componentId = button.getAttribute('data-component-id');
      if (componentId) {
        openAiModal(componentId);
      }
    });
  });

  aiModalElement?.addEventListener('hidden.bs.modal', () => {
    if (aiForm) {
      aiForm.reset();
    }
  });

  aiSaveTrigger?.addEventListener('click', () => {
    if (!aiForm || !aiComponentIdField) {
      return;
    }
    const componentId = aiComponentIdField.value;
    if (!componentId) {
      window.alert('Component reference missing.');
      return;
    }
    const formData = new FormData();
    if (csrfToken) {
      formData.append('csrf_token', csrfToken);
    }
    formData.append('category', aiCategoryField ? aiCategoryField.value : 'No AI');
    formData.append('motivatie', aiMotivationField ? aiMotivationField.value : '');

    fetch(aiRoutes.upsert + componentId, {
      method: 'POST',
      body: formData,
      credentials: 'same-origin',
    })
      .then((response) => {
        if (!response.ok) {
          throw new Error('Save failed');
        }
        return response.json();
      })
      .then((data) => {
        if (!data.success) {
          throw new Error('Server rejected the request');
        }
        const modalInstance = aiModalElement ? window.bootstrap?.Modal.getInstance(aiModalElement) : null;
        modalInstance?.hide();
        window.location.reload();
      })
      .catch(() => {
        window.alert('Unable to store AI identification.');
      });
  });

  if (addForm) {
    addForm.addEventListener('submit', function (event) {
      event.preventDefault();
      const formData = new FormData(addForm);
      fetch(addForm.action, {
        method: 'POST',
        body: formData,
      }).then((response) => response.json())
        .then((data) => {
          if (data.success) {
            window.location.reload();
          } else {
            handleErrors(data.errors);
          }
        })
        .catch(() => window.alert('Could not add the component.'));
    });
  }

  document.querySelectorAll('.component-edit-form').forEach((form) => {
    form.addEventListener('submit', function (event) {
      event.preventDefault();
      const formData = new FormData(form);
      fetch(form.dataset.action, {
        method: 'POST',
        body: formData,
      }).then((response) => response.json())
        .then((data) => {
          if (data.success) {
            window.location.reload();
          } else {
            handleErrors(data.errors);
          }
        })
        .catch(() => window.alert('Could not update the component.'));
    });
  });

  document.querySelectorAll('[data-delete-url]').forEach((button) => {
    button.addEventListener('click', function () {
      if (!window.confirm('Delete this component?')) {
        return;
      }
      const payload = new FormData();
      if (csrfToken) {
        payload.append('csrf_token', csrfToken);
      }
      fetch(this.dataset.deleteUrl, {
        method: 'POST',
        body: payload,
      }).then((response) => response.json())
        .then((data) => {
          if (data.success) {
            window.location.reload();
          } else {
            window.alert('Could not delete the component.');
          }
        })
        .catch(() => window.alert('Could not delete the component.'));
    });
  });
})();
</script>
{% endblock %}
